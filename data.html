<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemindai Kucing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff8e1; /* warm background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 25px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            padding: 35px;
            max-width: 580px;
            width: 100%;
            text-align: center;
            border: 1px solid #f0e0c8;
        }
video, #captured-image {
    width: 100%;
    max-width: 720px;
    height: auto;
    border-radius: 15px;
    background-color: #263238;
    margin-bottom: 30px;
    display: block;
    object-fit: cover;
    aspect-ratio: 16 / 9;
    border: 2px solid #efc18a;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    margin-left: auto;
    margin-right: auto;
}
#captured-image {
            display: none;
        }
        .button-group {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        button {
            background-image: linear-gradient(to right, #ffb74d 0%, #ff8a65 100%);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button i {
            font-size: 2.5rem;
            margin-right: 0;
        }
        button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.28);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background-image: linear-gradient(to right, #9e9e9e 0%, #757575 100%);
        }
        #loading-indicator {
            display: none;
            margin-top: 30px;
            color: #424242;
            font-style: italic;
            font-size: 1.05rem;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        #results {
            margin-top: 30px;
            padding: 25px;
            background-color: #fff3e0;
            border-radius: 16px;
            border: 2px solid #ffcc80;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            font-size: 1.05rem;
            color: #6d4c41;
            font-weight: 500;
            word-wrap: break-word;
            text-align: left;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        #results p { margin-bottom: 8px; }
        #results p:last-child { margin-bottom: 0; }
        #hidden-canvas, #gallery-input { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Pemindai Kucing</h1>
        <p class="text-gray-700 mb-10 text-lg">Pindai dari kamera atau pilih gambar dari galeri untuk mendapatkan detail kucing: ras (jenis), usia estimasi, warna, jenis kelamin, dan perkiraan harga di pasaran.</p>

        <video id="video-feed" autoplay playsinline></video>
        <img id="captured-image" alt="Gambar Kucing yang Dipindai">
        <canvas id="hidden-canvas"></canvas>

        <div class="button-group">
            <button id="scan-camera-button"><i class="fas fa-camera"></i></button>
            <button id="take-photo-button" style="display: none;"><i class="fas fa-camera-retro"></i></button>
            <input type="file" id="gallery-input" accept="image/*">
            <button id="select-gallery-button"><i class="fas fa-image"></i></button>
        </div>

        <div id="loading-indicator" class="flex items-center justify-center space-x-3">
            <svg class="animate-spin h-6 w-6 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Memindai kucing... Mohon tunggu.</span>
        </div>

        <div id="results" class="text-gray-700">
            Hasil akan muncul di sini.
        </div>
    </div>

    <script>
        const videoFeed = document.getElementById('video-feed');
        const capturedImage = document.getElementById('captured-image');
        const hiddenCanvas = document.getElementById('hidden-canvas');
        const scanCameraButton = document.getElementById('scan-camera-button');
        const takePhotoButton = document.getElementById('take-photo-button');
        const galleryInput = document.getElementById('gallery-input');
        const selectGalleryButton = document.getElementById('select-gallery-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsDiv = document.getElementById('results');
        const context = hiddenCanvas.getContext('2d');

        async function startCameraStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: "environment" } }
                });
                videoFeed.srcObject = stream;
                videoFeed.style.display = 'block';
                capturedImage.style.display = 'none';

                return new Promise((resolve) => {
                    videoFeed.onloadedmetadata = () => {
                        hiddenCanvas.width = videoFeed.videoWidth;
                        hiddenCanvas.height = videoFeed.videoHeight;
                        capturedImage.width = videoFeed.videoWidth;
                        capturedImage.height = videoFeed.videoHeight;
                        videoFeed.play().then(() => { resolve(); }).catch(err => {
                            console.error("Error playing video:", err);
                            resultsDiv.innerHTML = '<p class="text-red-500">Gagal memutar video kamera.</p>';
                            scanCameraButton.disabled = true;
                            resolve();
                        });
                    };
                });

            } catch (error) {
                console.error('Gagal mengakses kamera:', error);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoFeed.srcObject = stream;
                    videoFeed.style.display = 'block';
                    capturedImage.style.display = 'none';

                    return new Promise((resolve) => {
                        videoFeed.onloadedmetadata = () => {
                            hiddenCanvas.width = videoFeed.videoWidth;
                            hiddenCanvas.height = videoFeed.videoHeight;
                            capturedImage.width = videoFeed.videoWidth;
                            capturedImage.height = videoFeed.videoHeight;
                            videoFeed.play().then(() => {
                                resultsDiv.innerHTML = '<p class="text-yellow-600">Kamera belakang tidak ditemukan atau tidak dapat diakses. Menggunakan kamera default.</p>';
                                resolve();
                            }).catch(err => {
                                console.error("Error playing fallback video:", err);
                                resultsDiv.innerHTML = '<p class="text-red-500">Gagal memutar video kamera default.</p>';
                                scanCameraButton.disabled = true;
                                resolve();
                            });
                        };
                    });
                } catch (defaultCameraError) {
                    console.error('Gagal mengakses kamera apapun:', defaultCameraError);
                    resultsDiv.innerHTML = '<p class="text-red-500">Gagal mengakses kamera. Pastikan Anda memberikan izin.</p>';
                    scanCameraButton.disabled = true;
                    return Promise.reject("No camera access");
                }
            }
        }

        function stopCameraStream() {
            if (videoFeed.srcObject) {
                const tracks = videoFeed.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoFeed.srcObject = null;
            }
            videoFeed.style.display = 'none';
        }

        async function sendImageToGemini(base64ImageData) {
            loadingIndicator.style.display = 'flex';
            resultsDiv.textContent = '';
            scanCameraButton.disabled = true;
            selectGalleryButton.disabled = true;
            takePhotoButton.style.display = 'none';

            try {
                const prompt = `Identifikasi kucing dalam gambar. Berikan detail berikut dalam format JSON. Jika tidak ada kucing yang terlihat, berikan JSON: {"terdeteksi": "Tidak"}. Untuk tiap field yang tidak dapat ditentukan, gunakan "Tidak tersedia".
                {
                    "terdeteksi": "Ya atau Tidak",
                    "jenis_kucing": "ras/jenis kucing (misal: Persian, Siamese, Domestic Shorthair)",
                    "perkiraan_usia": "perkiraan usia (misal: 2 tahun, 6 bulan)",
                    "jenis_kelamin": "Jantan/Betina/Tidak tersedia",
                    "warna_bulu": "warna dominan bulu (misal: Putih, Oranye, Tabby)",
                    "kondisi_kesehatan_ringkas": "indikator kesehatan singkat jika terlihat (misal: tampak sehat, kurus, luka pada tubuh), atau 'Tidak tersedia'",
                    "perkiraan_harga_pasaran": "estimasi harga di pasaran Indonesia dalam Rupiah (misal: Rp 1.500.000), atau 'Tidak tersedia' jika tidak dapat diestimasi",
                    "ras_probabilitas": "persentase/kepercayaan terhadap identifikasi ras jika memungkinkan (misal: 85%), atau 'Tidak tersedia'",
                    "keterangan_tambahan": "ringkasan singkat (misal: cocok untuk indoor, perawatan tinggi), atau 'Tidak tersedia'"
                }
                Berikan output sebagai JSON saja tanpa teks tambahan.`;

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "terdeteksi": { "type": "STRING" },
                                "jenis_kucing": { "type": "STRING" },
                                "perkiraan_usia": { "type": "STRING" },
                                "jenis_kelamin": { "type": "STRING" },
                                "warna_bulu": { "type": "STRING" },
                                "kondisi_kesehatan_ringkas": { "type": "STRING" },
                                "perkiraan_harga_pasaran": { "type": "STRING" },
                                "ras_probabilitas": { "type": "STRING" },
                                "keterangan_tambahan": { "type": "STRING" }
                            },
                            propertyOrdering: [
                                "terdeteksi","jenis_kucing","perkiraan_usia","jenis_kelamin","warna_bulu","kondisi_kesehatan_ringkas","perkiraan_harga_pasaran","ras_probabilitas","keterangan_tambahan"
                            ]
                        }
                    }
                };

                const apiKey = "AIzaSyD55RE9twbJIk367GVV9fU8quPovcFNic8"; // tetap menggunakan API yang sama (ganti jika perlu)
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const catDetails = JSON.parse(jsonString);

                    let detailsHtml = '';
                    if (catDetails.terdeteksi === "Tidak" || catDetails.terdeteksi === "Tidak ada kucing terdeteksi") {
                        detailsHtml = `<p class="text-red-500">Tidak ada kucing terdeteksi dalam gambar.</p>`;
                    } else {
                        detailsHtml += `<p><strong>Jenis / Ras:</strong> ${catDetails.jenis_kucing || 'Tidak tersedia'}</p>`;
                        detailsHtml += `<p><strong>Perkiraan Usia:</strong> ${catDetails.perkiraan_usia || 'Tidak tersedia'}</p>`;
                        detailsHtml += `<p><strong>Jenis Kelamin:</strong> ${catDetails.jenis_kelamin || 'Tidak tersedia'}</p>`;
                        detailsHtml += `<p><strong>Warna Bulu:</strong> ${catDetails.warna_bulu || 'Tidak tersedia'}</p>`;

                        if (catDetails.kondisi_kesehatan_ringkas && catDetails.kondisi_kesehatan_ringkas !== 'Tidak tersedia') {
                            detailsHtml += `<p><strong>Kondisi Kesehatan (Ringkas):</strong> ${catDetails.kondisi_kesehatan_ringkas}</p>`;
                        } else {
                            detailsHtml += `<p><strong>Kondisi Kesehatan (Ringkas):</strong> Tidak tersedia.</p>`;
                        }

                        if (catDetails.perkiraan_harga_pasaran && catDetails.perkiraan_harga_pasaran !== 'Tidak tersedia') {
                            detailsHtml += `<p><strong>Perkiraan Harga di Pasaran:</strong> ${catDetails.perkiraan_harga_pasaran}</p>`;
                        } else {
                            detailsHtml += `<p><strong>Perkiraan Harga di Pasaran:</strong> Tidak tersedia.</p>`;
                        }

                        detailsHtml += `<p><strong>Kepercayaan Identifikasi Ras:</strong> ${catDetails.ras_probabilitas || 'Tidak tersedia'}</p>`;

                        if (catDetails.keterangan_tambahan && catDetails.keterangan_tambahan !== 'Tidak tersedia') {
                            detailsHtml += `<p><strong>Keterangan Tambahan:</strong> ${catDetails.keterangan_tambahan}</p>`;
                        } else {
                            detailsHtml += `<p><strong>Keterangan Tambahan:</strong> Tidak tersedia.</p>`;
                        }
                    }
                    resultsDiv.innerHTML = detailsHtml;

                } else {
                    resultsDiv.textContent = 'Tidak dapat mengidentifikasi detail kucing.';
                    console.error('Unexpected API response structure:', result);
                }

            } catch (error) {
                console.error('Kesalahan saat memindai kucing:', error);
                resultsDiv.innerHTML = '<p class="text-red-500">Terjadi kesalahan saat memindai. Silakan coba lagi.</p>';
            } finally {
                loadingIndicator.style.display = 'none';
                scanCameraButton.disabled = false;
                selectGalleryButton.disabled = false;
                takePhotoButton.disabled = false;
            }
        }

        scanCameraButton.addEventListener('click', async () => {
            try {
                await startCameraStream();
                scanCameraButton.disabled = true;
                selectGalleryButton.disabled = true;
                takePhotoButton.style.display = 'block';
                resultsDiv.textContent = '';
            } catch (error) {
                console.error("Error during camera scan initiation:", error);
                loadingIndicator.style.display = 'none';
                scanCameraButton.disabled = false;
                selectGalleryButton.disabled = false;
                videoFeed.style.display = 'none';
                capturedImage.style.display = 'none';
            }
        });

        takePhotoButton.addEventListener('click', () => {
            takePhotoButton.disabled = true;
            loadingIndicator.style.display = 'flex';
            resultsDiv.textContent = '';

            context.drawImage(videoFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
            capturedImage.src = hiddenCanvas.toDataURL('image/png');

            videoFeed.style.display = 'none';
            capturedImage.style.display = 'block';

            stopCameraStream();

            sendImageToGemini(hiddenCanvas.toDataURL('image/png').split(',')[1]);
        });

        selectGalleryButton.addEventListener('click', () => {
            stopCameraStream();
            galleryInput.click();
            scanCameraButton.disabled = true;
            selectGalleryButton.disabled = true;
            takePhotoButton.style.display = 'none';
            resultsDiv.textContent = '';
        });

        galleryInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        hiddenCanvas.width = img.width;
                        hiddenCanvas.height = img.height;
                        context.drawImage(img, 0, 0, img.width, img.height);

                        videoFeed.style.display = 'none';
                        capturedImage.style.display = 'block';
                        capturedImage.src = e.target.result;

                        sendImageToGemini(hiddenCanvas.toDataURL('image/png').split(',')[1]);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        window.onload = () => {
            videoFeed.style.display = 'none';
            capturedImage.style.display = 'none';
            takePhotoButton.style.display = 'none';
        };
    </script>
</body>
</html>

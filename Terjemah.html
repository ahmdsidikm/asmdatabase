<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembaca Teks dari Gambar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js CSS dan JS untuk pemangkasan gambar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1a202c;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 2rem;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg space-y-6">
    <h1 class="text-3xl font-bold text-center text-gray-800">Pembaca Teks dari Gambar</h1>
    <p class="text-center text-gray-600">Ambil gambar atau pilih dari galeri Anda untuk mendeteksi teks.</p>

    <!-- UI untuk memulai kamera atau memilih dari galeri -->
    <div id="start-section" class="flex flex-col items-center space-y-4">
        <button id="start-btn" class="bg-green-600 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105">
            Mulai Kamera
        </button>
        <button id="gallery-btn" class="bg-gray-400 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-105">
            Pilih dari Galeri
        </button>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <!-- UI Kamera -->
    <div id="camera-section" class="hidden flex flex-col items-center space-y-4">
        <video id="video" class="w-full rounded-lg shadow-md border border-gray-300" autoplay playsinline></video>
        <button id="snap-btn" class="bg-blue-600 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            Ambil Gambar
        </button>
    </div>

    <!-- UI Pemangkasan Gambar -->
    <div id="crop-section" class="hidden flex flex-col items-center space-y-4">
        <img id="image-to-crop" class="w-full rounded-lg shadow-md border border-gray-300" style="max-height: 400px; display: block;">
        <button id="crop-btn" class="bg-blue-600 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
            Pangkas & Analisis
        </button>
    </div>

    <!-- UI Hasil & Loading -->
    <div id="result-section" class="hidden flex flex-col items-center space-y-4">
        <img id="analyzed-image" class="w-full rounded-lg shadow-md border border-gray-300">
        <div id="loading-indicator" class="hidden flex items-center space-x-2">
            <div class="loading-spinner"></div>
            <span class="text-gray-500">Menganalisis teks...</span>
        </div>
        <div id="text-output" class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200" style="min-height: 100px;">
            <p class="text-gray-700 text-sm">Hasil teks akan muncul di sini.</p>
        </div>
        <button id="retry-btn" class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-full shadow hover:bg-gray-300 transition duration-300">
            Coba Lagi
        </button>
    </div>
    
    <!-- Modals untuk pesan kesalahan dan info -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80 text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-3"></h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button id="modal-ok-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
        </div>
    </div>
</div>

<script type="module">
    const apiKey = "AIzaSyAmxFA9I5ERBfZTlXNRndtNkPppGaElW1Q";

    const startBtn = document.getElementById('start-btn');
    const galleryBtn = document.getElementById('gallery-btn');
    const fileInput = document.getElementById('file-input');
    const startSection = document.getElementById('start-section');
    const video = document.getElementById('video');
    const snapBtn = document.getElementById('snap-btn');
    const cameraSection = document.getElementById('camera-section');
    const cropSection = document.getElementById('crop-section');
    const imageToCrop = document.getElementById('image-to-crop');
    const cropBtn = document.getElementById('crop-btn');
    const resultSection = document.getElementById('result-section');
    const analyzedImage = document.getElementById('analyzed-image');
    const loadingIndicator = document.getElementById('loading-indicator');
    const textOutput = document.getElementById('text-output');
    const retryBtn = document.getElementById('retry-btn');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalOkBtn = document.getElementById('modal-ok-btn');

    let stream;
    let cropper;
    let retries = 0;
    const MAX_RETRIES = 5;
    const RETRY_DELAY = 1000;

    // Menampilkan modal kustom
    function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalOverlay.classList.remove('hidden');
        modalOverlay.classList.add('flex');
    }

    // Menyembunyikan modal kustom
    function hideModal() {
        modalOverlay.classList.add('hidden');
        modalOverlay.classList.remove('flex');
    }

    modalOkBtn.addEventListener('click', hideModal);

    // Memulai kamera dan mengubah tampilan UI
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            startSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            cropSection.classList.add('hidden');
            textOutput.innerHTML = '<p class="text-gray-700 text-sm">Hasil teks akan muncul di sini.</p>';
        } catch (error) {
            console.error("Kesalahan saat mengakses kamera:", error);
            showModal("Kesalahan", "Gagal memulai kamera. Pastikan Anda memberikan izin.");
        }
    }

    // Menghentikan streaming kamera
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }

    // Mengirim gambar untuk dianalisis oleh Gemini AI
    async function recognizeText(base64Image) {
        retries = 0;
        await sendRequest(base64Image);
    }

    async function sendRequest(base64Image) {
        loadingIndicator.classList.remove('hidden');
        cropBtn.disabled = true;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: "Berdasarkan gambar, ekstrak semua teks yang terlihat secara akurat." },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image.split(',')[1] } }
                    ]
                }
            ],
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (response.status === 429 && retries < MAX_RETRIES) {
                    retries++;
                    await new Promise(res => setTimeout(res, RETRY_DELAY * Math.pow(2, retries - 1)));
                    await sendRequest(base64Image); // Coba lagi
                    return;
                }
                const errorData = await response.json();
                throw new Error(`Kesalahan API: ${errorData.error.message}`);
            }

            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Tidak ada teks yang terdeteksi.";
            textOutput.innerHTML = `<p class="text-gray-700 whitespace-pre-wrap">${text}</p>`;

        } catch (error) {
            console.error("Gagal memproses gambar:", error);
            showModal("Kesalahan", "Gagal memproses gambar. Silakan coba lagi.");
            textOutput.innerHTML = `<p class="text-red-500">Kesalahan: ${error.message}</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
            cropBtn.disabled = false;
        }
    }

    // Event listener untuk tombol 'Mulai Kamera'
    startBtn.addEventListener('click', startCamera);

    // Event listener untuk tombol 'Ambil Gambar'
    snapBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL('image/jpeg');

        stopCamera();
        
        // Tampilkan UI pemangkasan dengan gambar yang diambil
        imageToCrop.src = imageDataUrl;
        cameraSection.classList.add('hidden');
        cropSection.classList.remove('hidden');
        
        if (cropper) {
            cropper.destroy();
        }
        cropper = new Cropper(imageToCrop, {
            aspectRatio: NaN,
            viewMode: 1,
        });
    });

    // Event listener untuk tombol 'Pilih dari Galeri'
    galleryBtn.addEventListener('click', () => {
        fileInput.click();
    });

    // Event listener untuk input file
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageDataUrl = e.target.result;
                
                // Tampilkan UI pemangkasan dengan gambar yang dipilih
                imageToCrop.src = imageDataUrl;
                startSection.classList.add('hidden');
                cropSection.classList.remove('hidden');

                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: NaN,
                    viewMode: 1,
                });
            };
            reader.readAsDataURL(file);
        }
    });

    // Event listener untuk tombol 'Pangkas & Analisis'
    cropBtn.addEventListener('click', () => {
        if (!cropper) return;

        // Dapatkan gambar yang sudah dipangkas
        const croppedCanvas = cropper.getCroppedCanvas({
            width: 1024,
            height: 1024,
        });
        const croppedImageDataUrl = croppedCanvas.toDataURL('image/jpeg');
        
        // Tampilkan gambar yang dipangkas
        analyzedImage.src = croppedImageDataUrl;
        
        // Sembunyikan UI pemangkasan dan tampilkan UI hasil
        cropSection.classList.add('hidden');
        resultSection.classList.remove('hidden');

        // Lakukan analisis teks
        recognizeText(croppedImageDataUrl);
    });

    // Event listener untuk tombol 'Coba Lagi'
    retryBtn.addEventListener('click', () => {
        resultSection.classList.add('hidden');
        startSection.classList.remove('hidden');
    });
</script>

</body>
</html>

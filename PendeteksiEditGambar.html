<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload Gambar/Video ke Supabase (Tanpa Popup Sukses)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-6">
  <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-4xl">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Upload Gambar / Video ke Supabase</h1>
    <p class="text-center text-gray-600 mb-6">Pilih gambar atau video â€” hasil Base64 tidak akan ditampilkan penuh agar tidak lag.</p>

    <!-- Upload area -->
    <div class="space-y-4">
      <div class="flex gap-4 items-center">
        <!-- accept both image and video -->
        <input id="fileInput" type="file" accept="image/*,video/*" class="flex-1 text-gray-700 bg-gray-50 border border-gray-300 rounded-md p-2 cursor-pointer focus:outline-none" />
        <button id="uploadButton" disabled class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 transition duration-200 opacity-50 cursor-not-allowed">Upload ke Supabase</button>
      </div>

      <!-- Ringkasan file terpilih (thumbnail gambar atau preview video + nama + ukuran) -->
      <div id="fileSummary" class="hidden items-center gap-4 p-3 border border-gray-200 rounded-md bg-white">
        <img id="imgThumb" alt="thumbnail" class="w-28 h-28 object-cover rounded-md border hidden" />
        <video id="videoThumb" controls class="w-48 h-28 rounded-md border hidden"></video>
        <div>
          <div id="summaryName" class="font-medium text-gray-800"></div>
          <div id="summarySize" class="text-sm text-gray-500 mt-1"></div>
          <div id="summaryMime" class="text-sm text-gray-500 mt-1"></div>
        </div>
      </div>
    </div>

    <!-- Message box (untuk error/detailed info) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-700 bg-opacity-40 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg text-center">
        <pre id="messageText" class="text-left text-sm whitespace-pre-wrap"></pre>
        <div class="mt-4">
          <button id="messageCloseBtn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">Tutup</button>
        </div>
      </div>
    </div>

    <!-- Daftar file -->
    <div class="mt-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-gray-800">Daftar file di Supabase</h2>
        <div class="flex items-center gap-2">
          <button id="refreshButton" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-300">Segarkan</button>
          <span id="listStatus" class="text-sm text-gray-500"></span>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full table-auto border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="text-left p-2 border-b">Filename</th>
              <th class="text-left p-2 border-b">MIME</th>
              <th class="text-left p-2 border-b">Created At</th>
              <th class="p-2 border-b">Aksi</th>
            </tr>
          </thead>
          <tbody id="filesTbody" class="bg-white">
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://nqvgnmmvlfogouvdxkkr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xdmdubW12bGZvZ291dmR4a2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTEzMTgsImV4cCI6MjA3MTk2NzMxOH0.rliklScLWkzcC_qVNsCEus9b96DTravbfnfCILQXBWQ';
    const SUPABASE_REST_ENDPOINT = `${SUPABASE_URL}/rest/v1/images`;
    const MAX_SAFE_SIZE_BYTES = 100 * 1024 * 1024; // 100 MB - tunable
    // =================

    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');

    const fileSummary = document.getElementById('fileSummary');
    const imgThumb = document.getElementById('imgThumb');
    const videoThumb = document.getElementById('videoThumb');
    const summaryName = document.getElementById('summaryName');
    const summarySize = document.getElementById('summarySize');
    const summaryMime = document.getElementById('summaryMime');

    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageCloseBtn = document.getElementById('messageCloseBtn');

    const refreshButton = document.getElementById('refreshButton');
    const listStatus = document.getElementById('listStatus');
    const filesTbody = document.getElementById('filesTbody');

    // Base64 only in JS variable (never rendered)
    let currentBase64 = '';
    let currentFileName = '';
    let currentMime = '';

    function showMessage(text) {
      messageText.textContent = text;
      messageBox.classList.remove('hidden');
    }
    function closeMessageBox() {
      messageBox.classList.add('hidden');
    }
    messageCloseBtn.addEventListener('click', closeMessageBox);

    // File selection: preview via object URL, confirm if large, then read as dataURL into currentBase64
    fileInput.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) { resetSelection(); return; }

      // show lightweight preview
      const objectUrl = URL.createObjectURL(file);
      summaryName.textContent = file.name;
      summarySize.textContent = `Ukuran: ${formatBytes(file.size)}`;
      summaryMime.textContent = `MIME: ${file.type || 'unknown'}`;
      fileSummary.classList.remove('hidden');

      if (file.type.startsWith('image/')) {
        imgThumb.src = objectUrl;
        imgThumb.classList.remove('hidden');
        videoThumb.classList.add('hidden');
        videoThumb.pause();
        videoThumb.removeAttribute('src');
      } else if (file.type.startsWith('video/')) {
        videoThumb.src = objectUrl;
        videoThumb.classList.remove('hidden');
        imgThumb.classList.add('hidden');
        imgThumb.src = '';
      } else {
        // generic fallback
        imgThumb.src = '';
        imgThumb.classList.add('hidden');
        videoThumb.classList.add('hidden');
      }

      // If file very large, confirm
      if (file.size > MAX_SAFE_SIZE_BYTES) {
        const ok = confirm(`File lebih besar dari ${formatBytes(MAX_SAFE_SIZE_BYTES)}. Membaca & mengupload file besar dapat memakan waktu / kuota. Lanjutkan?`);
        if (!ok) { resetSelection(); return; }
      }

      // Read DataURL into JS variable only (may be heavy for video)
      const reader = new FileReader();
      reader.onload = (e) => {
        currentBase64 = e.target.result; // data:[mime];base64,....
        currentFileName = file.name || `file_${Date.now()}`;
        currentMime = file.type || 'application/octet-stream';
        uploadButton.disabled = false;
        uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
      };
      reader.onerror = () => {
        showMessage('Gagal membaca file. Coba lagi.');
        resetSelection();
      };
      reader.readAsDataURL(file);
    });

    function resetSelection() {
      currentBase64 = '';
      currentFileName = '';
      currentMime = '';
      fileSummary.classList.add('hidden');
      imgThumb.src = '';
      imgThumb.classList.add('hidden');
      videoThumb.pause();
      videoThumb.removeAttribute('src');
      videoThumb.classList.add('hidden');
      summaryName.textContent = '';
      summarySize.textContent = '';
      summaryMime.textContent = '';
      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
      fileInput.value = '';
    }

    function formatBytes(bytes, decimals = 2) {
      if (!bytes) return '0 B';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Upload: do not show popup on success; instead update listStatus briefly and refresh files
    uploadButton.addEventListener('click', async () => {
      if (!currentBase64) { showMessage('Tidak ada data untuk diupload. Pilih file terlebih dahulu.'); return; }

      const m = currentBase64.match(/^data:(.+);base64,(.*)$/);
      const mime = m ? m[1] : currentMime || 'application/octet-stream';
      const base64Data = m ? m[2] : currentBase64;

      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
      const prevText = uploadButton.textContent;
      uploadButton.textContent = 'Mengupload...';

      const payload = { filename: currentFileName, mime_type: mime, base64: base64Data };

      try {
        const res = await fetch(SUPABASE_REST_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          // silent success: set status briefly and refresh list
          listStatus.textContent = 'Upload sukses';
          setTimeout(() => { if (listStatus.textContent === 'Upload sukses') listStatus.textContent = ''; }, 3000);
          resetSelection();
          await fetchFiles();
        } else {
          const text = await res.text();
          showMessage(`Gagal upload. Status ${res.status} ${res.statusText}\n\n${text}`);
        }
      } catch (err) {
        showMessage('Kesalahan jaringan: ' + err.message);
      } finally {
        uploadButton.disabled = false;
        uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
        uploadButton.textContent = prevText;
      }
    });

    // --- Fetch file list (no base64) ---
    async function fetchFiles() {
      listStatus.textContent = 'Memuat...';
      filesTbody.innerHTML = '';
      try {
        const res = await fetch(`${SUPABASE_REST_ENDPOINT}?select=id,filename,mime_type,created_at&order=created_at.desc`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Accept': 'application/json'
          }
        });

        if (!res.ok) {
          const t = await res.text();
          showMessage(`Gagal mengambil daftar file. Status ${res.status}\n\n${t}`);
          listStatus.textContent = 'Gagal';
          return;
        }

        const files = await res.json();
        if (!Array.isArray(files) || files.length === 0) {
          filesTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Belum ada file.</td></tr>`;
          listStatus.textContent = 'Selesai';
          return;
        }

        filesTbody.innerHTML = files.map(f => {
          const created = f.created_at ? (new Date(f.created_at)).toLocaleString() : '-';
          return `
            <tr class="border-b">
              <td class="p-2">${escapeHtml(f.filename)}</td>
              <td class="p-2">${escapeHtml(f.mime_type || '')}</td>
              <td class="p-2">${escapeHtml(created)}</td>
              <td class="p-2">
                <div class="flex gap-2">
                  <button data-id="${f.id}" class="viewBtn bg-green-500 text-white px-2 py-1 rounded-md text-sm hover:bg-green-600">Lihat</button>
                  <button data-id="${f.id}" class="deleteBtn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600">Hapus</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        listStatus.textContent = `Terlihat ${files.length} file`;
      } catch (err) {
        showMessage('Kesalahan saat mengambil daftar: ' + err.message);
        listStatus.textContent = 'Gagal';
      }
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // Event delegation for view & delete
    filesTbody.addEventListener('click', async (ev) => {
      const viewBtn = ev.target.closest('.viewBtn');
      if (viewBtn) {
        const id = viewBtn.dataset.id;
        await viewFile(id);
        return;
      }
      const deleteBtn = ev.target.closest('.deleteBtn');
      if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        if (!confirm('Hapus file ini dari database? Tindakan tidak dapat dibatalkan.')) return;
        await deleteFile(id, deleteBtn);
        return;
      }
    });

    // --- View: fetch base64 from Supabase and open in new tab (works for images & videos) ---
    async function viewFile(id) {
      try {
        const res = await fetch(`${SUPABASE_REST_ENDPOINT}?select=base64,mime_type,filename&limit=1&id=eq.${encodeURIComponent(id)}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Accept': 'application/json'
          }
        });
        if (!res.ok) {
          const t = await res.text();
          showMessage(`Gagal mengambil file. Status ${res.status}\n\n${t}`);
          return;
        }
        const rows = await res.json();
        if (!rows || rows.length === 0) { showMessage('Data file tidak ditemukan.'); return; }
        const row = rows[0];
        const dataUri = `data:${row.mime_type || 'application/octet-stream'};base64,${row.base64}`;
        // buka di tab baru, untuk video & gambar akan tampil
        const w = window.open();
        try {
          w.document.write(`<title>${escapeHtml(row.filename || 'file')}</title>`);
          if ((row.mime_type || '').startsWith('image/')) {
            w.document.write(`<img src="${dataUri}" style="max-width:100%;height:auto;display:block;margin:0 auto" />`);
          } else if ((row.mime_type || '').startsWith('video/')) {
            w.document.write(`<video controls src="${dataUri}" style="width:100%;height:auto;display:block;margin:0 auto"></video>`);
          } else {
            // fallback: link download
            w.document.write(`<a href="${dataUri}" download="${escapeHtml(row.filename || 'file')}">Download file</a>`);
          }
        } catch (e) {
          // fallback: trigger download
          const a = document.createElement('a');
          a.href = dataUri;
          a.download = row.filename || 'file';
          a.click();
        }
      } catch (err) {
        showMessage('Kesalahan saat mengambil file: ' + err.message);
      }
    }

    // --- Delete file ---
    async function deleteFile(id, btnElement) {
      if (btnElement) {
        btnElement.disabled = true;
        const prev = btnElement.textContent;
        btnElement.textContent = 'Menghapus...';
      }
      try {
        const res = await fetch(`${SUPABASE_REST_ENDPOINT}?id=eq.${encodeURIComponent(id)}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Accept': 'application/json'
          }
        });
        if (res.ok) {
          // tampilkan pesan singkat di status bar
          listStatus.textContent = 'Hapus sukses';
          setTimeout(() => { if (listStatus.textContent === 'Hapus sukses') listStatus.textContent = ''; }, 3000);
          await fetchFiles();
        } else {
          const t = await res.text();
          showMessage(`Gagal menghapus. Status ${res.status}\n\n${t}`);
        }
      } catch (err) {
        showMessage('Kesalahan saat menghapus: ' + err.message);
      } finally {
        if (btnElement) {
          btnElement.disabled = false;
          btnElement.textContent = 'Hapus';
        }
      }
    }

    // Tombol segarkan
    refreshButton.addEventListener('click', fetchFiles);

    // Auto fetch pertama kali
    fetchFiles();
  </script>
</body>
</html>

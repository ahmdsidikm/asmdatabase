<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° Catatan Keuangan Pribadi</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .card-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .card-red { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .card-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .sidebar { transition: transform 0.3s ease; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; }
            .sidebar.open { transform: translateX(0); }
        }
        .modal { display: none; }
        .modal.active { display: flex; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .loading { pointer-events: none; opacity: 0.6; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-6 rounded-2xl flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p id="loadingText">Memuat data...</p>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="md:hidden fixed top-4 left-4 z-50 bg-purple-600 text-white p-2 rounded-lg shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>

    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 bg-white h-screen fixed left-0 top-0 shadow-xl overflow-y-auto">
            <div class="p-6 card-gradient">
                <h1 class="text-xl font-bold text-white flex items-center gap-2">
                    ğŸ’° Keuangan Ku
                </h1>
                <p class="text-purple-200 text-sm mt-1">Kelola uangmu dengan bijak</p>
            </div>
            
            <nav class="p-4 space-y-2">
                <a href="#" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="dashboard">
                    <span>ğŸ“Š</span> Dashboard
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="accounts">
                    <span>ğŸ¦</span> Akun & Dompet
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="transactions">
                    <span>ğŸ’³</span> Transaksi
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="transfer">
                    <span>ğŸ”„</span> Transfer
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="categories">
                    <span>ğŸ·ï¸</span> Kategori
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="budget">
                    <span>ğŸ¯</span> Anggaran
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="reports">
                    <span>ğŸ“ˆ</span> Laporan
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="history">
                    <span>ğŸ“œ</span> Riwayat
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="targets">
                    <span>ğŸ¯</span> Target
                </a>
                <a href="#" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-purple-100 transition" data-page="settings">
                    <span>âš™ï¸</span> Pengaturan
                </a>
            </nav>

            <div class="p-4 mt-4 mx-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl">
                <p class="text-xs text-gray-500 mb-2">Total Kekayaan</p>
                <p id="totalWealth" class="text-xl font-bold text-purple-700">Rp 0</p>
            </div>

            <div class="p-4 mx-4 mt-2 text-xs text-gray-400 text-center">
                <p>ğŸ”— Connected to Supabase</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-4 md:p-8 pt-16 md:pt-8">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page active fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-gray-500">Ringkasan keuangan anda</p>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="card-gradient p-6 rounded-2xl text-white shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-purple-200 text-sm">Total Saldo</p>
                                <p id="dashTotalBalance" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <span class="text-3xl">ğŸ’°</span>
                        </div>
                    </div>
                    <div class="card-green p-6 rounded-2xl text-white shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-100 text-sm">Pemasukan Bulan Ini</p>
                                <p id="dashIncome" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <span class="text-3xl">ğŸ“ˆ</span>
                        </div>
                    </div>
                    <div class="card-red p-6 rounded-2xl text-white shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-red-100 text-sm">Pengeluaran Bulan Ini</p>
                                <p id="dashExpense" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <span class="text-3xl">ğŸ“‰</span>
                        </div>
                    </div>
                    <div class="card-blue p-6 rounded-2xl text-white shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-100 text-sm">Selisih</p>
                                <p id="dashDiff" class="text-2xl font-bold mt-1">Rp 0</p>
                            </div>
                            <span class="text-3xl">âš–ï¸</span>
                        </div>
                    </div>
                </div>

                <!-- Account Summary -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ¦ Saldo Per Akun
                        </h3>
                        <div id="dashAccountList" class="space-y-3">
                            <p class="text-gray-400 text-center py-4">Belum ada akun</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ“Š Pengeluaran per Kategori
                        </h3>
                        <canvas id="categoryChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            ğŸ• Transaksi Terbaru
                        </h3>
                        <a href="#" class="text-purple-600 text-sm hover:underline" onclick="showPage('history')">Lihat Semua</a>
                    </div>
                    <div id="recentTransactions" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">Belum ada transaksi</p>
                    </div>
                </div>
            </div>

            <!-- Accounts Page -->
            <div id="page-accounts" class="page fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Akun & Dompet</h2>
                        <p class="text-gray-500">Kelola akun bank dan dompet tunai</p>
                    </div>
                    <button onclick="openModal('accountModal')" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center gap-2">
                        <span>â•</span> Tambah Akun
                    </button>
                </div>

                <div id="accountsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Account cards will be rendered here -->
                </div>
            </div>

            <!-- Transactions Page -->
            <div id="page-transactions" class="page fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Transaksi</h2>
                        <p class="text-gray-500">Catat pemasukan dan pengeluaran</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTransactionModal('income')" class="bg-green-600 text-white px-4 py-3 rounded-xl hover:bg-green-700 transition flex items-center gap-2">
                            <span>ğŸ“ˆ</span> Pemasukan
                        </button>
                        <button onclick="openTransactionModal('expense')" class="bg-red-500 text-white px-4 py-3 rounded-xl hover:bg-red-600 transition flex items-center gap-2">
                            <span>ğŸ“‰</span> Pengeluaran
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Hari Ini</p>
                        <p id="todayExpense" class="text-xl font-bold text-red-500">Rp 0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Minggu Ini</p>
                        <p id="weekExpense" class="text-xl font-bold text-orange-500">Rp 0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Bulan Ini</p>
                        <p id="monthExpense" class="text-xl font-bold text-purple-600">Rp 0</p>
                    </div>
                </div>

                <!-- Transaction List Today -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-4">Transaksi Hari Ini</h3>
                    <div id="todayTransactions" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">Belum ada transaksi hari ini</p>
                    </div>
                </div>
            </div>

            <!-- Transfer Page -->
            <div id="page-transfer" class="page fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Transfer Antar Akun</h2>
                    <p class="text-gray-500">Pindahkan saldo antar akun</p>
                </div>

                <div class="max-w-lg mx-auto">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dari Akun</label>
                                <select id="transferFrom" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <option value="">Pilih akun asal</option>
                                </select>
                            </div>
                            <div class="flex justify-center">
                                <div class="bg-purple-100 p-3 rounded-full">
                                    <span class="text-2xl">â¬‡ï¸</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ke Akun</label>
                                <select id="transferTo" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <option value="">Pilih akun tujuan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                                <input type="number" id="transferAmount" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Masukkan jumlah">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (opsional)</label>
                                <input type="text" id="transferNote" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Tambah catatan">
                            </div>
                            <button onclick="processTransfer()" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                                Transfer Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Transfer History -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm mt-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Riwayat Transfer</h3>
                        <div id="transferHistory" class="space-y-3">
                            <p class="text-gray-400 text-center py-4">Belum ada riwayat transfer</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Page -->
            <div id="page-categories" class="page fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Kategori</h2>
                        <p class="text-gray-500">Kelola kategori pemasukan dan pengeluaran</p>
                    </div>
                    <button onclick="openModal('categoryModal')" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center gap-2">
                        <span>â•</span> Tambah Kategori
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Income Categories -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-green-500">ğŸ“ˆ</span> Kategori Pemasukan
                        </h3>
                        <div id="incomeCategories" class="space-y-2">
                        </div>
                    </div>

                    <!-- Expense Categories -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-red-500">ğŸ“‰</span> Kategori Pengeluaran
                        </h3>
                        <div id="expenseCategories" class="space-y-2">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Page -->
            <div id="page-budget" class="page fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Anggaran Bulanan</h2>
                        <p class="text-gray-500">Atur batas pengeluaran per kategori</p>
                    </div>
                    <button onclick="openBudgetModal()" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center gap-2">
                        <span>â•</span> Tambah Anggaran
                    </button>
                </div>

                <!-- Budget Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-purple-200 text-sm">Total Anggaran</p>
                        <p id="totalBudget" class="text-2xl font-bold mt-1">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-green-200 text-sm">Sisa Anggaran</p>
                        <p id="remainingBudget" class="text-2xl font-bold mt-1">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-blue-200 text-sm">Anggaran Aktif</p>
                        <p id="activeBudgetCount" class="text-2xl font-bold mt-1">0</p>
                    </div>
                </div>

                <div id="budgetList" class="space-y-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm text-center text-gray-400">
                        Belum ada anggaran yang diatur
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="page-reports" class="page fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Laporan Keuangan</h2>
                    <p class="text-gray-500">Analisis keuangan anda</p>
                </div>

                <!-- Filter -->
                <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                    <div class="flex flex-wrap gap-4">
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Periode</label>
                            <select id="reportPeriod" class="p-2 border rounded-lg" onchange="updateReports()">
                                <option value="week">Minggu Ini</option>
                                <option value="month" selected>Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                                <option value="all">Semua</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4">Tren Pemasukan vs Pengeluaran</h3>
                        <canvas id="trendChart" height="250"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4">Distribusi Pengeluaran</h3>
                        <canvas id="expenseDistChart" height="250"></canvas>
                    </div>
                </div>

                <!-- Summary Table -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-4">Ringkasan Per Kategori</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-2">Kategori</th>
                                    <th class="text-right py-3 px-2">Jumlah Transaksi</th>
                                    <th class="text-right py-3 px-2">Total</th>
                                </tr>
                            </thead>
                            <tbody id="categorySummary">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- History Page -->
            <div id="page-history" class="page fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Riwayat Transaksi</h2>
                    <p class="text-gray-500">Semua catatan transaksi anda</p>
                </div>

                <!-- Filters -->
                <div class="bg-white p-4 rounded-2xl shadow-sm mb-6">
                    <div class="flex flex-wrap gap-4">
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Tipe</label>
                            <select id="filterType" class="p-2 border rounded-lg" onchange="filterTransactions()">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Akun</label>
                            <select id="filterAccount" class="p-2 border rounded-lg" onchange="filterTransactions()">
                                <option value="all">Semua Akun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Dari Tanggal</label>
                            <input type="date" id="filterDateFrom" class="p-2 border rounded-lg" onchange="filterTransactions()">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Sampai Tanggal</label>
                            <input type="date" id="filterDateTo" class="p-2 border rounded-lg" onchange="filterTransactions()">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Cari</label>
                            <input type="text" id="filterSearch" class="p-2 border rounded-lg" placeholder="Cari..." oninput="filterTransactions()">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <div id="historyList" class="space-y-3">
                        <p class="text-gray-400 text-center py-4">Belum ada transaksi</p>
                    </div>
                </div>
            </div>

            <!-- Targets Page -->
            <div id="page-targets" class="page fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ¯ Target Tabungan</h2>
                        <p class="text-gray-500">Rencanakan dan capai target finansial anda</p>
                    </div>
                    <button onclick="openModal('targetModal')" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center gap-2">
                        <span>â•</span> Tambah Target
                    </button>
                </div>

                <!-- Target Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-purple-200 text-sm">Total Target</p>
                        <p id="totalTargetAmount" class="text-2xl font-bold mt-1">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-green-200 text-sm">Sudah Terkumpul</p>
                        <p id="totalTargetCollected" class="text-2xl font-bold mt-1">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-6 rounded-2xl text-white shadow-lg">
                        <p class="text-blue-200 text-sm">Target Aktif</p>
                        <p id="activeTargetCount" class="text-2xl font-bold mt-1">0</p>
                    </div>
                </div>

                <!-- Target Simulator -->
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                    <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        ğŸ”® Kalkulator & Prediksi Target
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Target (Rp)</label>
                                <input type="number" id="simTargetAmount" class="w-full p-3 border rounded-xl" placeholder="Contoh: 25000000" oninput="calculatePrediction()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Target</label>
                                <input type="date" id="simTargetDate" class="w-full p-3 border rounded-xl" oninput="calculatePrediction()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Uang yang Sudah Ada (Rp)</label>
                                <input type="number" id="simCurrentAmount" class="w-full p-3 border rounded-xl" placeholder="0" value="0" oninput="calculatePrediction()">
                            </div>
                        </div>
                        <div id="predictionResult" class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ“Š Hasil Prediksi</h4>
                            <div class="text-gray-500 text-center py-8">
                                <span class="text-4xl">ğŸ§®</span>
                                <p class="mt-2">Masukkan data untuk melihat prediksi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Target List -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="font-semibold text-gray-800 mb-4">ğŸ“‹ Daftar Target</h3>
                    <div id="targetList" class="space-y-4">
                        <p class="text-gray-400 text-center py-8">Belum ada target. Buat target pertama anda!</p>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Pengaturan</h2>
                    <p class="text-gray-500">Kelola data dan preferensi</p>
                </div>

                <div class="max-w-2xl space-y-6">
                    <!-- Supabase Status -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ”— Status Koneksi Supabase
                        </h3>
                        <div id="supabaseStatus" class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full bg-green-500"></div>
                            <span class="text-green-600 font-medium">Terhubung</span>
                        </div>
                        <p class="text-gray-500 text-sm mt-2">Data disimpan di cloud dan dapat diakses dari mana saja</p>
                    </div>

                    <!-- Export Data -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ“¤ Export Data
                        </h3>
                        <p class="text-gray-500 text-sm mb-4">Unduh semua data keuangan anda</p>
                        <div class="flex gap-2">
                            <button onclick="exportData('json')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                                Export JSON
                            </button>
                            <button onclick="exportData('csv')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                                Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Sync Data -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            ğŸ”„ Sinkronisasi Data
                        </h3>
                        <p class="text-gray-500 text-sm mb-4">Refresh data dari server</p>
                        <button onclick="refreshAllData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                            Refresh Data
                        </button>
                    </div>

                    <!-- App Info -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            â„¹ï¸ Informasi Aplikasi
                        </h3>
                        <div class="text-gray-500 text-sm space-y-2">
                            <p>Versi: 2.1.0 (Supabase + Target)</p>
                            <p>Database: PostgreSQL (Supabase)</p>
                            <p>Â© 2024 Keuangan Ku</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tambah Akun Baru</h3>
                <button onclick="closeModal('accountModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="accountForm" class="space-y-4">
                <input type="hidden" id="accountId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Akun</label>
                    <input type="text" id="accountName" class="w-full p-3 border rounded-xl" placeholder="Contoh: BCA, Dompet" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Akun</label>
                    <select id="accountType" class="w-full p-3 border rounded-xl" required>
                        <option value="bank">ğŸ¦ Bank/ATM</option>
                        <option value="wallet">ğŸ‘› Dompet Tunai</option>
                        <option value="ewallet">ğŸ“± E-Wallet</option>
                        <option value="savings">ğŸ· Tabungan</option>
                        <option value="investment">ğŸ“ˆ Investasi</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Saldo Awal</label>
                    <input type="number" id="accountBalance" class="w-full p-3 border rounded-xl" placeholder="0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Warna</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="accountColor" value="purple" class="hidden peer">
                            <div class="w-8 h-8 rounded-full bg-purple-500 peer-checked:ring-4 ring-purple-200"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="accountColor" value="blue" class="hidden peer" checked>
                            <div class="w-8 h-8 rounded-full bg-blue-500 peer-checked:ring-4 ring-blue-200"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="accountColor" value="green" class="hidden peer">
                            <div class="w-8 h-8 rounded-full bg-green-500 peer-checked:ring-4 ring-green-200"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="accountColor" value="orange" class="hidden peer">
                            <div class="w-8 h-8 rounded-full bg-orange-500 peer-checked:ring-4 ring-orange-200"></div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="accountColor" value="pink" class="hidden peer">
                            <div class="w-8 h-8 rounded-full bg-pink-500 peer-checked:ring-4 ring-pink-200"></div>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (opsional)</label>
                    <input type="text" id="accountNote" class="w-full p-3 border rounded-xl" placeholder="Catatan tambahan">
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    Simpan Akun
                </button>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="transactionModalTitle" class="text-lg font-semibold">Tambah Transaksi</h3>
                <button onclick="closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="transactionId">
                <input type="hidden" id="transactionType">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                    <input type="number" id="transactionAmount" class="w-full p-3 border rounded-xl text-xl font-bold" placeholder="0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Akun</label>
                    <select id="transactionAccount" class="w-full p-3 border rounded-xl" required>
                        <option value="">Pilih akun</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <select id="transactionCategory" class="w-full p-3 border rounded-xl" required>
                        <option value="">Pilih kategori</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="datetime-local" id="transactionDate" class="w-full p-3 border rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                    <input type="text" id="transactionNote" class="w-full p-3 border rounded-xl" placeholder="Tambah keterangan">
                </div>
                <button type="submit" id="transactionSubmitBtn" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    Simpan
                </button>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Tambah Kategori</h3>
                <button onclick="closeModal('categoryModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="categoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kategori</label>
                    <input type="text" id="categoryName" class="w-full p-3 border rounded-xl" placeholder="Nama kategori" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                    <select id="categoryType" class="w-full p-3 border rounded-xl" required>
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                    <div class="grid grid-cols-8 gap-2" id="iconPicker">
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ”" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ”</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ›’" class="hidden peer" checked><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ›’</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸš—" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸš—</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ " class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ </div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ’¡" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’¡</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ“±" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ“±</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ®" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ®</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ‘•" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ‘•</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ’Š" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’Š</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="âœˆï¸" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">âœˆï¸</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ“" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ“</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ’¼" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’¼</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ’°" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’°</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ’µ" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’µ</div></label>
                        <label class="cursor-pointer"><input type="radio" name="categoryIcon" value="ğŸ¦" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ¦</div></label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    Simpan Kategori
                </button>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="budgetModalTitle" class="text-lg font-semibold">Tambah Anggaran</h3>
                <button onclick="closeModal('budgetModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="budgetForm" class="space-y-4">
                <input type="hidden" id="budgetId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <select id="budgetCategory" class="w-full p-3 border rounded-xl" required>
                        <option value="">Pilih kategori</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Batas Anggaran</label>
                    <input type="number" id="budgetAmount" class="w-full p-3 border rounded-xl" placeholder="0" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Tanggal Mulai</label>
                        <input type="date" id="budgetStartDate" class="w-full p-3 border rounded-xl" required onchange="updateBudgetPreview()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Tanggal Selesai</label>
                        <input type="date" id="budgetEndDate" class="w-full p-3 border rounded-xl" required onchange="updateBudgetPreview()">
                    </div>
                </div>
                <div id="budgetPeriodInfo" class="bg-blue-50 p-4 rounded-xl">
                    <p class="text-sm text-blue-700 mb-2">ğŸ“Š Info Periode:</p>
                    <p class="text-sm text-blue-600" id="budgetPeriodPreview">Pilih tanggal untuk melihat durasi</p>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    Simpan Anggaran
                </button>
            </form>
        </div>
    </div>

    <!-- Target Modal -->
    <div id="targetModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ¯ Tambah Target Baru</h3>
                <button onclick="closeModal('targetModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="targetForm" class="space-y-4">
                <input type="hidden" id="targetId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Target</label>
                    <input type="text" id="targetName" class="w-full p-3 border rounded-xl" placeholder="Contoh: Beli Motor, Liburan, dll" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Target (Rp)</label>
                    <input type="number" id="targetAmount" class="w-full p-3 border rounded-xl" placeholder="Contoh: 25000000" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Uang yang Sudah Ada (Rp)</label>
                    <input type="number" id="targetCurrentAmount" class="w-full p-3 border rounded-xl" placeholder="0" value="0">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Target</label>
                    <input type="date" id="targetDate" class="w-full p-3 border rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                    <div class="grid grid-cols-8 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ¯" class="hidden peer" checked><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ¯</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸï¸" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸï¸</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸš—" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸš—</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ " class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ </div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ“±" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ“±</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ’»" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’»</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="âœˆï¸" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">âœˆï¸</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ“" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ“</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ’" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ’</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ‘¶" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ‘¶</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ®" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ®</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ“·" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ“·</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ¸" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ¸</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="âŒš" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">âŒš</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ‘œ" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ‘œ</div></label>
                        <label class="cursor-pointer"><input type="radio" name="targetIcon" value="ğŸ¥" class="hidden peer"><div class="text-2xl p-2 rounded-lg peer-checked:bg-purple-100">ğŸ¥</div></label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (opsional)</label>
                    <input type="text" id="targetNote" class="w-full p-3 border rounded-xl" placeholder="Catatan tambahan">
                </div>
                
                <!-- Preview Prediction in Modal -->
                <div id="modalPrediction" class="bg-purple-50 p-4 rounded-xl hidden">
                    <p class="text-sm font-medium text-purple-800 mb-2">ğŸ“Š Prediksi Tabungan:</p>
                    <div id="modalPredictionContent" class="text-sm text-purple-700"></div>
                </div>
                
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700 transition font-medium">
                    Simpan Target
                </button>
            </form>
        </div>
    </div>

    <!-- Add Savings to Target Modal -->
    <div id="addSavingsModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ’° Tambah Tabungan</h3>
                <button onclick="closeModal('addSavingsModal')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <form id="addSavingsForm" class="space-y-4">
                <input type="hidden" id="savingsTargetId">
                <div id="savingsTargetInfo" class="bg-purple-50 p-4 rounded-xl mb-4"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Tabungan (Rp)</label>
                    <input type="number" id="savingsAmount" class="w-full p-3 border rounded-xl" placeholder="Masukkan jumlah" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 transition font-medium">
                    Tambah Tabungan
                </button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        // ===================== SUPABASE CONFIGURATION =====================
        const SUPABASE_URL = 'https://vdzfbgsabssixddddxkl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkemZiZ3NhYnNzaXhkZGRkeGtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzODMyNjksImV4cCI6MjA4MDk1OTI2OX0.7jTQ9HfJj7zEGejLNEnJSCtvTHxGc1seEMlbBFrJRVo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===================== DATA CACHE =====================
        let cache = {
            accounts: [],
            transactions: [],
            categories: { income: [], expense: [] },
            budgets: [],
            transfers: [],
            targets: []
        };

        // ===================== LOADING & SYNC INDICATORS =====================
        function showLoading(text = 'Memuat data...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function setSyncStatus(status) {
            // Status indicator removed - function kept for compatibility
        }

        // ===================== UTILITIES =====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300 z-50`;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // ===================== SUPABASE DATA FUNCTIONS =====================
        
        // Load all data from Supabase
        async function loadAllData() {
            showLoading('Memuat data dari server...');
            setSyncStatus('syncing');
            
            try {
                // Load accounts
                const { data: accounts, error: accError } = await supabase
                    .from('accounts')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (accError) throw accError;
                cache.accounts = accounts || [];

                // Load categories
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name');
                if (catError) throw catError;
                
                cache.categories.income = (categories || []).filter(c => c.type === 'income');
                cache.categories.expense = (categories || []).filter(c => c.type === 'expense');

                // Load transactions
                const { data: transactions, error: transError } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('transaction_date', { ascending: false });
                if (transError) throw transError;
                cache.transactions = transactions || [];

                // Load transfers
                const { data: transfers, error: transferError } = await supabase
                    .from('transfers')
                    .select('*')
                    .order('transfer_date', { ascending: false });
                if (transferError) throw transferError;
                cache.transfers = transfers || [];

                // Load budgets
                const { data: budgets, error: budgetError } = await supabase
                    .from('budgets')
                    .select('*');
                if (budgetError) throw budgetError;
                cache.budgets = budgets || [];

                // Load targets
                const { data: targets, error: targetError } = await supabase
                    .from('targets')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (targetError) throw targetError;
                cache.targets = targets || [];

                setSyncStatus('online');
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                setSyncStatus('offline');
                hideLoading();
                showToast('Gagal memuat data: ' + error.message, true);
                return false;
            }
        }

        // Refresh all data
        async function refreshAllData() {
            await loadAllData();
            updateDashboard();
            showToast('Data berhasil di-refresh!');
        }

        // ===================== NAVIGATION =====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            document.getElementById('sidebar').classList.remove('open');
            refreshPageContent(pageId);
        }

        function refreshPageContent(pageId) {
            switch(pageId) {
                case 'dashboard': updateDashboard(); break;
                case 'accounts': renderAccounts(); break;
                case 'transactions': renderTransactionsPage(); break;
                case 'transfer': setupTransferPage(); break;
                case 'categories': renderCategories(); break;
                case 'budget': renderBudgets(); break;
                case 'reports': updateReports(); break;
                case 'history': renderHistory(); break;
                case 'targets': renderTargets(); break;
            }
        }

        // ===================== MODALS =====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.getElementById(modalId.replace('Modal', 'Form'));
            if (form) form.reset();
            document.getElementById('accountId').value = '';
            document.getElementById('transactionId').value = '';
            document.getElementById('budgetId').value = '';
            // Re-enable budget category select
            const budgetCatSelect = document.getElementById('budgetCategory');
            if (budgetCatSelect) budgetCatSelect.disabled = false;
        }

        // ===================== ACCOUNTS =====================
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            if (cache.accounts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full bg-white p-8 rounded-2xl shadow-sm text-center">
                        <p class="text-6xl mb-4">ğŸ¦</p>
                        <p class="text-gray-500">Belum ada akun. Tambahkan akun pertama anda!</p>
                    </div>
                `;
                return;
            }

            const typeIcons = { bank: 'ğŸ¦', wallet: 'ğŸ‘›', ewallet: 'ğŸ“±', savings: 'ğŸ·', investment: 'ğŸ“ˆ' };
            const colorClasses = {
                purple: 'from-purple-500 to-purple-700',
                blue: 'from-blue-500 to-blue-700',
                green: 'from-green-500 to-green-700',
                orange: 'from-orange-500 to-orange-700',
                pink: 'from-pink-500 to-pink-700'
            };

            container.innerHTML = cache.accounts.map(acc => `
                <div class="bg-gradient-to-br ${colorClasses[acc.color] || colorClasses.blue} p-6 rounded-2xl text-white shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                    <div class="flex justify-between items-start relative">
                        <div>
                            <span class="text-3xl">${typeIcons[acc.type] || 'ğŸ’³'}</span>
                            <h3 class="font-semibold text-lg mt-2">${acc.name}</h3>
                            <p class="text-white/70 text-sm capitalize">${acc.type}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editAccount('${acc.id}')" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition">âœï¸</button>
                            <button onclick="deleteAccount('${acc.id}')" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p class="text-2xl font-bold mt-4">${formatCurrency(acc.balance)}</p>
                    ${acc.note ? `<p class="text-white/60 text-sm mt-2">${acc.note}</p>` : ''}
                </div>
            `).join('');
        }

        document.getElementById('accountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('accountId').value;
            const accountData = {
                name: document.getElementById('accountName').value,
                type: document.getElementById('accountType').value,
                balance: parseFloat(document.getElementById('accountBalance').value) || 0,
                color: document.querySelector('input[name="accountColor"]:checked').value,
                note: document.getElementById('accountNote').value
            };

            setSyncStatus('syncing');
            try {
                if (id) {
                    const { error } = await supabase.from('accounts').update(accountData).eq('id', id);
                    if (error) throw error;
                    showToast('Akun berhasil diperbarui!');
                } else {
                    const { error } = await supabase.from('accounts').insert([accountData]);
                    if (error) throw error;
                    showToast('Akun berhasil ditambahkan!');
                }

                await loadAllData();
                closeModal('accountModal');
                renderAccounts();
                updateDashboard();
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });

        async function editAccount(id) {
            const account = cache.accounts.find(a => a.id === id);
            if (!account) return;

            document.getElementById('accountId').value = account.id;
            document.getElementById('accountName').value = account.name;
            document.getElementById('accountType').value = account.type;
            document.getElementById('accountBalance').value = account.balance;
            document.getElementById('accountNote').value = account.note || '';
            const colorInput = document.querySelector(`input[name="accountColor"][value="${account.color}"]`);
            if (colorInput) colorInput.checked = true;

            openModal('accountModal');
        }

        async function deleteAccount(id) {
            if (!confirm('Yakin ingin menghapus akun ini? Semua transaksi terkait juga akan dihapus.')) return;
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('accounts').delete().eq('id', id);
                if (error) throw error;

                await loadAllData();
                renderAccounts();
                updateDashboard();
                showToast('Akun berhasil dihapus!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        // ===================== TRANSACTIONS =====================
        async function openTransactionModal(type) {
            document.getElementById('transactionType').value = type;
            document.getElementById('transactionModalTitle').textContent = type === 'income' ? 'ğŸ“ˆ Tambah Pemasukan' : 'ğŸ“‰ Tambah Pengeluaran';
            document.getElementById('transactionSubmitBtn').className = type === 'income' 
                ? 'w-full bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 transition font-medium'
                : 'w-full bg-red-500 text-white py-3 rounded-xl hover:bg-red-600 transition font-medium';
            
            const accountSelect = document.getElementById('transactionAccount');
            accountSelect.innerHTML = '<option value="">Pilih akun</option>' + 
                cache.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            const categorySelect = document.getElementById('transactionCategory');
            const cats = type === 'income' ? cache.categories.income : cache.categories.expense;
            categorySelect.innerHTML = '<option value="">Pilih kategori</option>' + 
                cats.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');

            document.getElementById('transactionDate').value = new Date().toISOString().slice(0, 16);
            openModal('transactionModal');
        }

        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('transactionId').value;
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const accountId = document.getElementById('transactionAccount').value;

            const transactionData = {
                type: type,
                amount: amount,
                account_id: accountId,
                category_id: document.getElementById('transactionCategory').value,
                transaction_date: document.getElementById('transactionDate').value,
                note: document.getElementById('transactionNote').value
            };

            setSyncStatus('syncing');
            try {
                // Get current account balance
                const account = cache.accounts.find(a => a.id === accountId);
                let newBalance = account.balance;

                if (id) {
                    // Editing - revert old transaction first
                    const oldTrans = cache.transactions.find(t => t.id === id);
                    if (oldTrans) {
                        const oldAccount = cache.accounts.find(a => a.id === oldTrans.account_id);
                        if (oldAccount) {
                            let revertBalance = oldAccount.balance;
                            if (oldTrans.type === 'income') revertBalance -= oldTrans.amount;
                            else revertBalance += oldTrans.amount;
                            await supabase.from('accounts').update({ balance: revertBalance }).eq('id', oldTrans.account_id);
                        }
                    }
                    
                    const { error } = await supabase.from('transactions').update(transactionData).eq('id', id);
                    if (error) throw error;
                    showToast('Transaksi berhasil diperbarui!');
                } else {
                    const { error } = await supabase.from('transactions').insert([transactionData]);
                    if (error) throw error;
                    showToast('Transaksi berhasil disimpan!');
                }

                // Update account balance
                if (type === 'income') newBalance += amount;
                else newBalance -= amount;
                await supabase.from('accounts').update({ balance: newBalance }).eq('id', accountId);

                await loadAllData();
                closeModal('transactionModal');
                renderTransactionsPage();
                updateDashboard();
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });

        function renderTransactionsPage() {
            const today = new Date().toISOString().split('T')[0];
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const startOfMonth = new Date();
            startOfMonth.setDate(1);

            const todayExpense = cache.transactions
                .filter(t => t.type === 'expense' && t.transaction_date.startsWith(today))
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const weekExpense = cache.transactions
                .filter(t => t.type === 'expense' && new Date(t.transaction_date) >= startOfWeek)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const monthExpense = cache.transactions
                .filter(t => t.type === 'expense' && new Date(t.transaction_date) >= startOfMonth)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            document.getElementById('todayExpense').textContent = formatCurrency(todayExpense);
            document.getElementById('weekExpense').textContent = formatCurrency(weekExpense);
            document.getElementById('monthExpense').textContent = formatCurrency(monthExpense);

            const todayTrans = cache.transactions
                .filter(t => t.transaction_date.startsWith(today))
                .sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date));

            renderTransactionList('todayTransactions', todayTrans);
        }

        function renderTransactionList(containerId, transactions) {
            const container = document.getElementById(containerId);
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Tidak ada transaksi</p>';
                return;
            }

            container.innerHTML = transactions.map(t => {
                const account = cache.accounts.find(a => a.id === t.account_id);
                const allCats = [...cache.categories.income, ...cache.categories.expense];
                const category = allCats.find(c => c.id === t.category_id);

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${category?.icon || 'ğŸ’³'}</span>
                            <div>
                                <p class="font-medium text-gray-800">${category?.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-500">${account?.name || '-'} â€¢ ${formatDate(t.transaction_date)}</p>
                                ${t.note ? `<p class="text-xs text-gray-400">${t.note}</p>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-500'}">
                                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                            </p>
                            <div class="flex gap-1 mt-1 justify-end">
                                <button onclick="editTransaction('${t.id}')" class="text-gray-400 hover:text-blue-500 text-sm">âœï¸</button>
                                <button onclick="deleteTransaction('${t.id}')" class="text-gray-400 hover:text-red-500 text-sm">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editTransaction(id) {
            const trans = cache.transactions.find(t => t.id === id);
            if (!trans) return;

            document.getElementById('transactionId').value = trans.id;
            document.getElementById('transactionType').value = trans.type;
            document.getElementById('transactionAmount').value = trans.amount;
            document.getElementById('transactionDate').value = trans.transaction_date.slice(0, 16);
            document.getElementById('transactionNote').value = trans.note || '';

            const accountSelect = document.getElementById('transactionAccount');
            accountSelect.innerHTML = '<option value="">Pilih akun</option>' + 
                cache.accounts.map(a => `<option value="${a.id}" ${a.id === trans.account_id ? 'selected' : ''}>${a.name}</option>`).join('');

            const categorySelect = document.getElementById('transactionCategory');
            const cats = trans.type === 'income' ? cache.categories.income : cache.categories.expense;
            categorySelect.innerHTML = '<option value="">Pilih kategori</option>' + 
                cats.map(c => `<option value="${c.id}" ${c.id === trans.category_id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('');

            document.getElementById('transactionModalTitle').textContent = trans.type === 'income' ? 'ğŸ“ˆ Edit Pemasukan' : 'ğŸ“‰ Edit Pengeluaran';
            openModal('transactionModal');
        }

        async function deleteTransaction(id) {
            if (!confirm('Yakin ingin menghapus transaksi ini?')) return;

            setSyncStatus('syncing');
            try {
                const trans = cache.transactions.find(t => t.id === id);
                if (trans) {
                    const account = cache.accounts.find(a => a.id === trans.account_id);
                    if (account) {
                        let newBalance = account.balance;
                        if (trans.type === 'income') newBalance -= parseFloat(trans.amount);
                        else newBalance += parseFloat(trans.amount);
                        await supabase.from('accounts').update({ balance: newBalance }).eq('id', account.id);
                    }
                }

                const { error } = await supabase.from('transactions').delete().eq('id', id);
                if (error) throw error;

                await loadAllData();
                renderTransactionsPage();
                renderHistory();
                updateDashboard();
                showToast('Transaksi berhasil dihapus!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        // ===================== TRANSFER =====================
        function setupTransferPage() {
            const fromSelect = document.getElementById('transferFrom');
            const toSelect = document.getElementById('transferTo');

            fromSelect.innerHTML = '<option value="">Pilih akun asal</option>' + 
                cache.accounts.map(a => `<option value="${a.id}">${a.name} (${formatCurrency(a.balance)})</option>`).join('');
            toSelect.innerHTML = '<option value="">Pilih akun tujuan</option>' + 
                cache.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            renderTransferHistory();
        }

        async function processTransfer() {
            const fromId = document.getElementById('transferFrom').value;
            const toId = document.getElementById('transferTo').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value;

            if (!fromId || !toId || !amount) {
                showToast('Lengkapi semua data!', true);
                return;
            }

            if (fromId === toId) {
                showToast('Akun asal dan tujuan tidak boleh sama!', true);
                return;
            }

            const fromAccount = cache.accounts.find(a => a.id === fromId);
            if (fromAccount.balance < amount) {
                showToast('Saldo tidak mencukupi!', true);
                return;
            }

            setSyncStatus('syncing');
            try {
                // Insert transfer record
                const { error: transferError } = await supabase.from('transfers').insert([{
                    from_account_id: fromId,
                    to_account_id: toId,
                    amount: amount,
                    note: note,
                    transfer_date: new Date().toISOString()
                }]);
                if (transferError) throw transferError;

                // Update account balances
                const toAccount = cache.accounts.find(a => a.id === toId);
                await supabase.from('accounts').update({ balance: fromAccount.balance - amount }).eq('id', fromId);
                await supabase.from('accounts').update({ balance: toAccount.balance + amount }).eq('id', toId);

                await loadAllData();
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferNote').value = '';
                setupTransferPage();
                updateDashboard();
                showToast('Transfer berhasil!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        function renderTransferHistory() {
            const container = document.getElementById('transferHistory');
            const transfers = cache.transfers.slice(0, 10);

            if (transfers.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada riwayat transfer</p>';
                return;
            }

            container.innerHTML = transfers.map(t => {
                const fromAcc = cache.accounts.find(a => a.id === t.from_account_id);
                const toAcc = cache.accounts.find(a => a.id === t.to_account_id);
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ”„</span>
                            <div>
                                <p class="font-medium text-gray-800">${fromAcc?.name || '-'} â†’ ${toAcc?.name || '-'}</p>
                                <p class="text-sm text-gray-500">${formatDate(t.transfer_date)}</p>
                                ${t.note ? `<p class="text-xs text-gray-400">${t.note}</p>` : ''}
                            </div>
                        </div>
                        <p class="font-bold text-purple-600">${formatCurrency(t.amount)}</p>
                    </div>
                `;
            }).join('');
        }

        // ===================== CATEGORIES =====================
        function renderCategories() {
            const incomeContainer = document.getElementById('incomeCategories');
            const expenseContainer = document.getElementById('expenseCategories');

            incomeContainer.innerHTML = cache.categories.income.length === 0 
                ? '<p class="text-gray-400 text-center py-4">Tidak ada kategori</p>'
                : cache.categories.income.map(c => `
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${c.icon}</span>
                            <span class="font-medium">${c.name}</span>
                            ${c.is_default ? '<span class="text-xs bg-green-200 px-2 py-1 rounded">Default</span>' : ''}
                        </div>
                        ${!c.is_default ? `<button onclick="deleteCategory('${c.id}')" class="text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>` : ''}
                    </div>
                `).join('');

            expenseContainer.innerHTML = cache.categories.expense.length === 0
                ? '<p class="text-gray-400 text-center py-4">Tidak ada kategori</p>'
                : cache.categories.expense.map(c => `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-xl">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${c.icon}</span>
                            <span class="font-medium">${c.name}</span>
                            ${c.is_default ? '<span class="text-xs bg-red-200 px-2 py-1 rounded">Default</span>' : ''}
                        </div>
                        ${!c.is_default ? `<button onclick="deleteCategory('${c.id}')" class="text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>` : ''}
                    </div>
                `).join('');
        }

        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const categoryData = {
                name: document.getElementById('categoryName').value,
                type: document.getElementById('categoryType').value,
                icon: document.querySelector('input[name="categoryIcon"]:checked').value,
                is_default: false
            };

            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('categories').insert([categoryData]);
                if (error) throw error;

                await loadAllData();
                closeModal('categoryModal');
                renderCategories();
                showToast('Kategori berhasil ditambahkan!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });

        async function deleteCategory(id) {
            if (!confirm('Yakin ingin menghapus kategori ini?')) return;
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('categories').delete().eq('id', id);
                if (error) throw error;

                await loadAllData();
                renderCategories();
                showToast('Kategori berhasil dihapus!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        // ===================== BUDGET =====================
        function formatDateShort(date) {
            return new Date(date).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function updateBudgetPreview() {
            const startDate = document.getElementById('budgetStartDate').value;
            const endDate = document.getElementById('budgetEndDate').value;
            const preview = document.getElementById('budgetPeriodPreview');
            
            if (!startDate || !endDate) {
                preview.innerHTML = 'Pilih tanggal untuk melihat durasi';
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 0) {
                preview.innerHTML = '<span class="text-red-500">âš ï¸ Tanggal selesai harus setelah tanggal mulai!</span>';
                return;
            }
            
            const amount = parseFloat(document.getElementById('budgetAmount').value) || 0;
            const dailyBudget = amount > 0 ? amount / diffDays : 0;
            
            preview.innerHTML = `
                <div class="space-y-1">
                    <p><strong>${formatDateShort(start)}</strong> s/d <strong>${formatDateShort(end)}</strong></p>
                    <p class="text-xs">ğŸ“† Durasi: <strong>${diffDays} hari</strong></p>
                    ${amount > 0 ? `<p class="text-xs">ğŸ’° Budget per hari: <strong>${formatCurrency(dailyBudget)}</strong></p>` : ''}
                </div>
            `;
        }
        
        function openBudgetModal(isEdit = false, budgetData = null) {
            document.getElementById('budgetModalTitle').textContent = isEdit ? 'Edit Anggaran' : 'Tambah Anggaran';
            document.getElementById('budgetId').value = budgetData?.id || '';
            
            const budgetCategorySelect = document.getElementById('budgetCategory');
            budgetCategorySelect.innerHTML = '<option value="">Pilih kategori</option>' + 
                cache.categories.expense.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
            
            if (isEdit && budgetData) {
                budgetCategorySelect.value = budgetData.category_id;
                budgetCategorySelect.disabled = true;
                document.getElementById('budgetAmount').value = budgetData.amount;
                document.getElementById('budgetStartDate').value = budgetData.start_date;
                document.getElementById('budgetEndDate').value = budgetData.end_date;
            } else {
                budgetCategorySelect.disabled = false;
                document.getElementById('budgetAmount').value = '';
                // Set default dates
                const today = new Date();
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + 1);
                document.getElementById('budgetStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('budgetEndDate').value = endDate.toISOString().split('T')[0];
            }
            
            updateBudgetPreview();
            openModal('budgetModal');
        }
        
        // Add event listener for budget amount change
        document.getElementById('budgetAmount').addEventListener('input', updateBudgetPreview);
        
        async function renderBudgets() {
            const container = document.getElementById('budgetList');

            if (cache.budgets.length === 0) {
                container.innerHTML = '<div class="bg-white p-6 rounded-2xl shadow-sm text-center text-gray-400">Belum ada anggaran yang diatur</div>';
                document.getElementById('totalBudget').textContent = formatCurrency(0);
                document.getElementById('remainingBudget').textContent = formatCurrency(0);
                document.getElementById('activeBudgetCount').textContent = '0';
                return;
            }

            let totalBudget = 0;
            let totalSpent = 0;
            let activeCount = 0;

            container.innerHTML = cache.budgets.map(b => {
                const category = cache.categories.expense.find(c => c.id === b.category_id);
                
                // Calculate period based on start_date
                const startDate = b.start_date ? new Date(b.start_date) : new Date(b.created_at);
                const endDate = b.end_date ? new Date(b.end_date) : new Date(startDate);
                if (!b.end_date) {
                    endDate.setMonth(endDate.getMonth() + 1);
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = endDate - today;
                const remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const elapsedDays = Math.max(totalDays - remainingDays, 0);
                
                const isExpired = remainingDays <= 0;
                
                if (!isExpired) activeCount++;
                
                // Calculate spent within the budget period
                const spent = cache.transactions
                    .filter(t => {
                        const tDate = new Date(t.transaction_date);
                        return t.type === 'expense' && 
                               t.category_id === b.category_id && 
                               tDate >= startDate && 
                               tDate <= endDate;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const percentage = Math.min((spent / b.amount) * 100, 100);
                const isOverBudget = spent > b.amount;
                
                // Daily budget calculation
                const dailyBudget = totalDays > 0 ? b.amount / totalDays : 0;
                const idealSpent = dailyBudget * elapsedDays;
                const spendingStatus = spent <= idealSpent ? 'on-track' : 'over-pace';

                if (!isExpired) {
                    totalBudget += parseFloat(b.amount);
                    totalSpent += spent;
                }

                // Prepare budget data for reset/edit
                const budgetDataStr = JSON.stringify({
                    id: b.id,
                    category_id: b.category_id,
                    amount: b.amount,
                    start_date: b.start_date,
                    end_date: b.end_date
                }).replace(/"/g, '&quot;');

                return `
                    <div class="bg-white p-6 rounded-2xl shadow-sm ${isExpired ? 'border-2 border-orange-300 bg-orange-50' : ''}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">${category?.icon || 'ğŸ“¦'}</span>
                                <div>
                                    <h4 class="font-semibold">${category?.name || 'Unknown'}</h4>
                                    <p class="text-sm text-gray-500">Anggaran: ${formatCurrency(b.amount)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${isExpired ? '<span class="bg-orange-200 text-orange-700 px-2 py-1 rounded-full text-xs font-medium">â° Berakhir</span>' : 
                                  remainingDays <= 7 ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs">âš¡ Segera</span>' : 
                                  '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">âœ… Aktif</span>'}
                                <button onclick="editBudget('${b.id}')" class="text-gray-400 hover:text-blue-500" title="Edit">âœï¸</button>
                                <button onclick="deleteBudget('${b.id}')" class="text-gray-400 hover:text-red-500" title="Hapus">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        
                        <!-- Period Info -->
                        <div class="bg-blue-50 p-3 rounded-xl mb-4">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-blue-600">ğŸ“… Periode:</span>
                                <span class="font-medium text-blue-700">${formatDateShort(startDate)} - ${formatDateShort(endDate)}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-1">
                                <span class="text-blue-600">â³ Sisa waktu:</span>
                                <span class="font-bold ${isExpired ? 'text-orange-600' : remainingDays <= 7 ? 'text-red-600' : 'text-blue-700'}">${isExpired ? 'Sudah berakhir' : remainingDays + ' hari lagi'}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-1">
                                <span class="text-blue-600">ğŸ“Š Durasi total:</span>
                                <span class="text-blue-700">${totalDays} hari</span>
                            </div>
                        </div>
                        
                        <!-- Budget Progress -->
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span>${formatCurrency(spent)} terpakai</span>
                                <span class="${isOverBudget ? 'text-red-500' : 'text-green-600'}">${formatCurrency(b.amount - spent)} sisa</span>
                            </div>
                            <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full ${isOverBudget ? 'bg-red-500' : percentage > 80 ? 'bg-yellow-500' : 'bg-green-500'} rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-right text-xs text-gray-500 mt-1">${percentage.toFixed(1)}% terpakai</p>
                        </div>
                        

                        
                        ${isOverBudget ? '<p class="text-red-500 text-sm font-medium mb-3">âš ï¸ Melebihi anggaran!</p>' : 
                          spendingStatus === 'over-pace' && !isExpired ? '<p class="text-yellow-600 text-sm font-medium mb-3">âš¡ Pengeluaran lebih cepat dari target</p>' : 
                          !isExpired ? '<p class="text-green-600 text-sm font-medium mb-3">âœ… Pengeluaran sesuai target</p>' : ''}
                        
                        ${isExpired ? `
                        <div class="bg-orange-100 p-4 rounded-xl mb-3">
                            <p class="text-orange-700 text-sm font-medium mb-2">â° Periode anggaran telah berakhir!</p>
                            <p class="text-orange-600 text-xs">Anda bisa memperpanjang atau reset anggaran ini.</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="resetBudget('${b.id}', ${b.amount})" class="bg-green-600 text-white py-2 px-3 rounded-xl hover:bg-green-700 transition text-sm font-medium flex items-center justify-center gap-1">
                                ğŸ”„ Reset Baru
                            </button>
                            <button onclick="extendBudget('${b.id}')" class="bg-blue-600 text-white py-2 px-3 rounded-xl hover:bg-blue-700 transition text-sm font-medium flex items-center justify-center gap-1">
                                â• Perpanjang
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('remainingBudget').textContent = formatCurrency(totalBudget - totalSpent);
            document.getElementById('activeBudgetCount').textContent = activeCount;
        }
        
        async function editBudget(id) {
            const budget = cache.budgets.find(b => b.id === id);
            if (!budget) return;
            
            openBudgetModal(true, budget);
        }
        
        async function resetBudget(id, amount) {
            if (!confirm('Reset anggaran ini untuk periode baru mulai dari hari ini?')) return;
            
            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + 1);
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('budgets').update({
                    amount: amount,
                    start_date: today.toISOString().split('T')[0],
                    end_date: endDate.toISOString().split('T')[0]
                }).eq('id', id);
                
                if (error) throw error;
                
                await loadAllData();
                renderBudgets();
                showToast('Anggaran berhasil di-reset untuk periode baru!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }
        
        async function extendBudget(id) {
            const budget = cache.budgets.find(b => b.id === id);
            if (!budget) return;
            
            // Open modal with current budget data, but set new dates starting from today
            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + 1);
            
            openBudgetModal(true, {
                ...budget,
                start_date: today.toISOString().split('T')[0],
                end_date: endDate.toISOString().split('T')[0]
            });
        }

        document.getElementById('budgetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const budgetId = document.getElementById('budgetId').value;
            const categoryId = document.getElementById('budgetCategory').value;
            const startDate = document.getElementById('budgetStartDate').value;
            const endDate = document.getElementById('budgetEndDate').value;
            
            // Validate dates
            if (new Date(endDate) <= new Date(startDate)) {
                showToast('Tanggal selesai harus setelah tanggal mulai!', true);
                return;
            }

            // Check duplicate category only for new budget
            if (!budgetId && cache.budgets.some(b => b.category_id === categoryId)) {
                showToast('Anggaran untuk kategori ini sudah ada!', true);
                return;
            }

            const budgetData = {
                category_id: categoryId,
                amount: parseFloat(document.getElementById('budgetAmount').value),
                start_date: startDate,
                end_date: endDate
            };

            setSyncStatus('syncing');
            try {
                if (budgetId) {
                    // Update existing budget
                    const { error } = await supabase.from('budgets').update(budgetData).eq('id', budgetId);
                    if (error) throw error;
                    showToast('Anggaran berhasil diperbarui!');
                } else {
                    // Insert new budget
                    const { error } = await supabase.from('budgets').insert([budgetData]);
                    if (error) throw error;
                    showToast('Anggaran berhasil ditambahkan!');
                }

                await loadAllData();
                closeModal('budgetModal');
                renderBudgets();
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });

        async function deleteBudget(id) {
            if (!confirm('Yakin ingin menghapus anggaran ini?')) return;
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('budgets').delete().eq('id', id);
                if (error) throw error;

                await loadAllData();
                renderBudgets();
                showToast('Anggaran berhasil dihapus!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        // ===================== REPORTS =====================
        let trendChart, expenseDistChart, categoryChart;

        function updateReports() {
            const period = document.getElementById('reportPeriod').value;
            let startDate = new Date(0);
            const now = new Date();

            switch(period) {
                case 'week':
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case 'year':
                    startDate = new Date();
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
            }

            const filteredTrans = cache.transactions.filter(t => new Date(t.transaction_date) >= startDate);

            // Trend Chart
            const trendData = {};
            filteredTrans.forEach(t => {
                const date = t.transaction_date.split('T')[0];
                if (!trendData[date]) trendData[date] = { income: 0, expense: 0 };
                if (t.type === 'income') trendData[date].income += parseFloat(t.amount);
                else trendData[date].expense += parseFloat(t.amount);
            });

            const labels = Object.keys(trendData).sort();
            const incomeData = labels.map(d => trendData[d].income);
            const expenseData = labels.map(d => trendData[d].expense);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: labels.map(d => new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })),
                    datasets: [
                        { label: 'Pemasukan', data: incomeData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Pengeluaran', data: expenseData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Expense Distribution Chart
            const expenseByCategory = {};
            filteredTrans.filter(t => t.type === 'expense').forEach(t => {
                const cat = cache.categories.expense.find(c => c.id === t.category_id);
                const name = cat?.name || 'Lainnya';
                expenseByCategory[name] = (expenseByCategory[name] || 0) + parseFloat(t.amount);
            });

            if (expenseDistChart) expenseDistChart.destroy();
            expenseDistChart = new Chart(document.getElementById('expenseDistChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseByCategory),
                    datasets: [{
                        data: Object.values(expenseByCategory),
                        backgroundColor: ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#6366f1', '#14b8a6']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Category Summary Table
            const summaryContainer = document.getElementById('categorySummary');
            const allCategories = [
                ...cache.categories.income.map(c => ({...c, catType: 'income'})), 
                ...cache.categories.expense.map(c => ({...c, catType: 'expense'}))
            ];
            
            summaryContainer.innerHTML = allCategories.map(cat => {
                const trans = filteredTrans.filter(t => t.category_id === cat.id);
                const total = trans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                if (trans.length === 0) return '';
                return `
                    <tr class="border-b">
                        <td class="py-3 px-2">
                            <span class="mr-2">${cat.icon}</span>
                            <span class="${cat.catType === 'income' ? 'text-green-600' : 'text-red-500'}">${cat.name}</span>
                        </td>
                        <td class="text-right py-3 px-2">${trans.length} transaksi</td>
                        <td class="text-right py-3 px-2 font-bold ${cat.catType === 'income' ? 'text-green-600' : 'text-red-500'}">${formatCurrency(total)}</td>
                    </tr>
                `;
            }).join('');
        }

        // ===================== HISTORY =====================
        function renderHistory() {
            populateFilterAccount();
            filterTransactions();
        }

        function populateFilterAccount() {
            const select = document.getElementById('filterAccount');
            select.innerHTML = '<option value="all">Semua Akun</option>' + 
                cache.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }

        function filterTransactions() {
            const type = document.getElementById('filterType').value;
            const account = document.getElementById('filterAccount').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            let filtered = [...cache.transactions];

            if (type !== 'all') {
                filtered = filtered.filter(t => t.type === type);
            }

            if (account !== 'all') {
                filtered = filtered.filter(t => t.account_id === account);
            }

            if (dateFrom) {
                filtered = filtered.filter(t => t.transaction_date >= dateFrom);
            }

            if (dateTo) {
                filtered = filtered.filter(t => t.transaction_date <= dateTo + 'T23:59:59');
            }

            if (search) {
                const allCats = [...cache.categories.income, ...cache.categories.expense];
                filtered = filtered.filter(t => {
                    const cat = allCats.find(c => c.id === t.category_id);
                    return (cat?.name.toLowerCase().includes(search)) || (t.note?.toLowerCase().includes(search));
                });
            }

            filtered.sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date));

            const container = document.getElementById('historyList');
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Tidak ada transaksi</p>';
                return;
            }

            container.innerHTML = filtered.map(t => {
                const account = cache.accounts.find(a => a.id === t.account_id);
                const allCats = [...cache.categories.income, ...cache.categories.expense];
                const category = allCats.find(c => c.id === t.category_id);

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${category?.icon || 'ğŸ’³'}</span>
                            <div>
                                <p class="font-medium text-gray-800">${category?.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-500">${account?.name || '-'} â€¢ ${formatDate(t.transaction_date)}</p>
                                ${t.note ? `<p class="text-xs text-gray-400">${t.note}</p>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-500'}">
                                ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                            </p>
                            <div class="flex gap-1 mt-1 justify-end">
                                <button onclick="editTransaction('${t.id}')" class="text-gray-400 hover:text-blue-500 text-sm">âœï¸</button>
                                <button onclick="deleteTransaction('${t.id}')" class="text-gray-400 hover:text-red-500 text-sm">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ===================== DASHBOARD =====================
        function updateDashboard() {
            const totalBalance = cache.accounts.reduce((sum, a) => sum + parseFloat(a.balance || 0), 0);
            document.getElementById('dashTotalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('totalWealth').textContent = formatCurrency(totalBalance);

            const startOfMonth = new Date();
            startOfMonth.setDate(1);
            startOfMonth.setHours(0, 0, 0, 0);

            const monthlyIncome = cache.transactions
                .filter(t => t.type === 'income' && new Date(t.transaction_date) >= startOfMonth)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const monthlyExpense = cache.transactions
                .filter(t => t.type === 'expense' && new Date(t.transaction_date) >= startOfMonth)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            document.getElementById('dashIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('dashExpense').textContent = formatCurrency(monthlyExpense);
            document.getElementById('dashDiff').textContent = formatCurrency(monthlyIncome - monthlyExpense);

            // Account list
            const accountList = document.getElementById('dashAccountList');
            if (cache.accounts.length === 0) {
                accountList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada akun</p>';
            } else {
                accountList.innerHTML = cache.accounts.map(a => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                        <span class="font-medium">${a.name}</span>
                        <span class="font-bold">${formatCurrency(a.balance)}</span>
                    </div>
                `).join('');
            }

            // Category chart
            const expenseByCategory = {};
            cache.transactions.filter(t => t.type === 'expense' && new Date(t.transaction_date) >= startOfMonth).forEach(t => {
                const cat = cache.categories.expense.find(c => c.id === t.category_id);
                const name = cat?.name || 'Lainnya';
                expenseByCategory[name] = (expenseByCategory[name] || 0) + parseFloat(t.amount);
            });

            if (categoryChart) categoryChart.destroy();
            if (Object.keys(expenseByCategory).length > 0) {
                categoryChart = new Chart(document.getElementById('categoryChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(expenseByCategory),
                        datasets: [{
                            data: Object.values(expenseByCategory),
                            backgroundColor: ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#6366f1', '#14b8a6']
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
                });
            }

            // Recent transactions
            const recent = cache.transactions.slice(0, 5);
            renderTransactionList('recentTransactions', recent);
        }

        // ===================== TARGETS =====================
        function calculatePrediction() {
            const targetAmount = parseFloat(document.getElementById('simTargetAmount').value) || 0;
            const targetDate = document.getElementById('simTargetDate').value;
            const currentAmount = parseFloat(document.getElementById('simCurrentAmount').value) || 0;
            
            const resultDiv = document.getElementById('predictionResult');
            
            if (!targetAmount || !targetDate) {
                resultDiv.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-4">ğŸ“Š Hasil Prediksi</h4>
                    <div class="text-gray-500 text-center py-8">
                        <span class="text-4xl">ğŸ§®</span>
                        <p class="mt-2">Masukkan data untuk melihat prediksi</p>
                    </div>
                `;
                return;
            }
            
            const today = new Date();
            const target = new Date(targetDate);
            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 0) {
                resultDiv.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-4">ğŸ“Š Hasil Prediksi</h4>
                    <div class="text-red-500 text-center py-8">
                        <span class="text-4xl">âš ï¸</span>
                        <p class="mt-2">Tanggal target harus di masa depan!</p>
                    </div>
                `;
                return;
            }
            
            const remaining = targetAmount - currentAmount;
            const dailyAmount = remaining / diffDays;
            const weeklyAmount = dailyAmount * 7;
            const monthlyAmount = dailyAmount * 30;
            const diffWeeks = Math.ceil(diffDays / 7);
            const diffMonths = Math.ceil(diffDays / 30);
            
            resultDiv.innerHTML = `
                <h4 class="font-semibold text-gray-800 mb-4">ğŸ“Š Hasil Prediksi</h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                        <span class="text-gray-600">Sisa yang dibutuhkan</span>
                        <span class="font-bold text-purple-600">${formatCurrency(remaining)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                        <span class="text-gray-600">Waktu tersisa</span>
                        <span class="font-bold text-blue-600">${diffDays} hari (${diffMonths} bulan)</span>
                    </div>
                    <div class="border-t pt-3 mt-3">
                        <p class="text-sm text-gray-500 mb-2">Anda harus menabung:</p>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex justify-between items-center p-3 bg-green-100 rounded-lg">
                                <span class="text-green-700">ğŸ“… Per Hari</span>
                                <span class="font-bold text-green-700">${formatCurrency(dailyAmount)}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-100 rounded-lg">
                                <span class="text-blue-700">ğŸ“† Per Minggu</span>
                                <span class="font-bold text-blue-700">${formatCurrency(weeklyAmount)}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-purple-100 rounded-lg">
                                <span class="text-purple-700">ğŸ—“ï¸ Per Bulan</span>
                                <span class="font-bold text-purple-700">${formatCurrency(monthlyAmount)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateModalPrediction() {
            const targetAmount = parseFloat(document.getElementById('targetAmount').value) || 0;
            const targetDate = document.getElementById('targetDate').value;
            const currentAmount = parseFloat(document.getElementById('targetCurrentAmount').value) || 0;
            
            const predDiv = document.getElementById('modalPrediction');
            const contentDiv = document.getElementById('modalPredictionContent');
            
            if (!targetAmount || !targetDate) {
                predDiv.classList.add('hidden');
                return;
            }
            
            const today = new Date();
            const target = new Date(targetDate);
            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 0) {
                predDiv.classList.add('hidden');
                return;
            }
            
            const remaining = targetAmount - currentAmount;
            const dailyAmount = remaining / diffDays;
            const monthlyAmount = dailyAmount * 30;
            
            predDiv.classList.remove('hidden');
            contentDiv.innerHTML = `
                <p>ğŸ“… Waktu: <strong>${diffDays} hari</strong></p>
                <p>ğŸ’° Per hari: <strong>${formatCurrency(dailyAmount)}</strong></p>
                <p>ğŸ—“ï¸ Per bulan: <strong>${formatCurrency(monthlyAmount)}</strong></p>
            `;
        }
        
        // Add event listeners for modal prediction
        document.getElementById('targetAmount').addEventListener('input', updateModalPrediction);
        document.getElementById('targetDate').addEventListener('input', updateModalPrediction);
        document.getElementById('targetCurrentAmount').addEventListener('input', updateModalPrediction);
        
        function renderTargets() {
            const container = document.getElementById('targetList');
            const activeTargets = cache.targets.filter(t => t.status === 'active');
            
            // Update summary
            const totalTarget = cache.targets.reduce((sum, t) => sum + parseFloat(t.target_amount || 0), 0);
            const totalCollected = cache.targets.reduce((sum, t) => sum + parseFloat(t.current_amount || 0), 0);
            
            document.getElementById('totalTargetAmount').textContent = formatCurrency(totalTarget);
            document.getElementById('totalTargetCollected').textContent = formatCurrency(totalCollected);
            document.getElementById('activeTargetCount').textContent = activeTargets.length;
            
            if (cache.targets.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada target. Buat target pertama anda!</p>';
                return;
            }
            
            container.innerHTML = cache.targets.map(t => {
                const percentage = Math.min((parseFloat(t.current_amount) / parseFloat(t.target_amount)) * 100, 100);
                const remaining = parseFloat(t.target_amount) - parseFloat(t.current_amount);
                
                const today = new Date();
                const targetDate = new Date(t.target_date);
                const diffTime = targetDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                const dailyNeeded = diffDays > 0 ? remaining / diffDays : 0;
                const isOverdue = diffDays < 0;
                const isCompleted = t.status === 'completed' || percentage >= 100;
                
                let statusBadge = '';
                if (isCompleted) {
                    statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">âœ… Tercapai</span>';
                } else if (isOverdue) {
                    statusBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">â° Lewat Waktu</span>';
                } else if (diffDays <= 7) {
                    statusBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs">âš¡ Segera</span>';
                }
                
                return `
                    <div class="border rounded-2xl p-6 ${isCompleted ? 'bg-green-50 border-green-200' : 'bg-white'} transition hover:shadow-md">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl">${t.icon || 'ğŸ¯'}</span>
                                <div>
                                    <h4 class="font-semibold text-lg text-gray-800">${t.name}</h4>
                                    <p class="text-sm text-gray-500">Target: ${new Date(t.target_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${statusBadge}
                                <button onclick="deleteTarget('${t.id}')" class="text-gray-400 hover:text-red-500 p-1">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Terkumpul: <strong class="text-green-600">${formatCurrency(t.current_amount)}</strong></span>
                                <span class="text-gray-600">Target: <strong>${formatCurrency(t.target_amount)}</strong></span>
                            </div>
                            <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full ${isCompleted ? 'bg-green-500' : percentage > 80 ? 'bg-blue-500' : percentage > 50 ? 'bg-yellow-500' : 'bg-purple-500'} rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-right text-sm text-gray-500 mt-1">${percentage.toFixed(1)}%</p>
                        </div>
                        
                        ${!isCompleted ? `
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-50 p-3 rounded-xl text-center">
                                <p class="text-xs text-gray-500">Sisa</p>
                                <p class="font-bold text-purple-600">${formatCurrency(remaining)}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl text-center">
                                <p class="text-xs text-gray-500">${isOverdue ? 'Lewat' : 'Tersisa'}</p>
                                <p class="font-bold ${isOverdue ? 'text-red-500' : 'text-blue-600'}">${Math.abs(diffDays)} hari</p>
                            </div>
                        </div>
                        
                        ${diffDays > 0 ? `
                        <div class="bg-purple-50 p-3 rounded-xl mb-4">
                            <p class="text-xs text-purple-600 mb-1">ğŸ’¡ Untuk mencapai target, tabung:</p>
                            <p class="text-sm"><strong>${formatCurrency(dailyNeeded)}</strong>/hari atau <strong>${formatCurrency(dailyNeeded * 30)}</strong>/bulan</p>
                        </div>
                        ` : ''}
                        
                        <button onclick="openAddSavingsModal('${t.id}')" class="w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-2">
                            <span>ğŸ’°</span> Tambah Tabungan
                        </button>
                        ` : `
                        <div class="bg-green-100 p-4 rounded-xl text-center">
                            <span class="text-3xl">ğŸ‰</span>
                            <p class="text-green-700 font-medium mt-2">Selamat! Target tercapai!</p>
                        </div>
                        `}
                        
                        ${t.note ? `<p class="text-xs text-gray-400 mt-3">ğŸ“ ${t.note}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('targetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('targetId').value;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value);
            const currentAmount = parseFloat(document.getElementById('targetCurrentAmount').value) || 0;
            const targetDate = document.getElementById('targetDate').value;
            
            // Calculate daily amount
            const today = new Date();
            const target = new Date(targetDate);
            const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            const dailyAmount = diffDays > 0 ? (targetAmount - currentAmount) / diffDays : 0;
            
            const targetData = {
                name: document.getElementById('targetName').value,
                target_amount: targetAmount,
                current_amount: currentAmount,
                daily_amount: dailyAmount,
                target_date: targetDate,
                start_date: new Date().toISOString().split('T')[0],
                icon: document.querySelector('input[name="targetIcon"]:checked').value,
                note: document.getElementById('targetNote').value,
                status: currentAmount >= targetAmount ? 'completed' : 'active'
            };
            
            setSyncStatus('syncing');
            try {
                if (id) {
                    const { error } = await supabase.from('targets').update(targetData).eq('id', id);
                    if (error) throw error;
                    showToast('Target berhasil diperbarui!');
                } else {
                    const { error } = await supabase.from('targets').insert([targetData]);
                    if (error) throw error;
                    showToast('Target berhasil ditambahkan!');
                }
                
                await loadAllData();
                closeModal('targetModal');
                renderTargets();
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });
        
        function openAddSavingsModal(targetId) {
            const target = cache.targets.find(t => t.id === targetId);
            if (!target) return;
            
            document.getElementById('savingsTargetId').value = targetId;
            document.getElementById('savingsAmount').value = '';
            
            const remaining = parseFloat(target.target_amount) - parseFloat(target.current_amount);
            document.getElementById('savingsTargetInfo').innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-3xl">${target.icon}</span>
                    <div>
                        <h4 class="font-semibold">${target.name}</h4>
                        <p class="text-sm text-gray-500">Target: ${formatCurrency(target.target_amount)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-white p-2 rounded-lg text-center">
                        <p class="text-gray-500">Terkumpul</p>
                        <p class="font-bold text-green-600">${formatCurrency(target.current_amount)}</p>
                    </div>
                    <div class="bg-white p-2 rounded-lg text-center">
                        <p class="text-gray-500">Sisa</p>
                        <p class="font-bold text-purple-600">${formatCurrency(remaining)}</p>
                    </div>
                </div>
            `;
            
            openModal('addSavingsModal');
        }
        
        document.getElementById('addSavingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const targetId = document.getElementById('savingsTargetId').value;
            const amount = parseFloat(document.getElementById('savingsAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Masukkan jumlah yang valid!', true);
                return;
            }
            
            const target = cache.targets.find(t => t.id === targetId);
            if (!target) return;
            
            const newAmount = parseFloat(target.current_amount) + amount;
            const isCompleted = newAmount >= parseFloat(target.target_amount);
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('targets').update({
                    current_amount: newAmount,
                    status: isCompleted ? 'completed' : 'active'
                }).eq('id', targetId);
                
                if (error) throw error;
                
                await loadAllData();
                closeModal('addSavingsModal');
                renderTargets();
                
                if (isCompleted) {
                    showToast('ğŸ‰ Selamat! Target tercapai!');
                } else {
                    showToast('Tabungan berhasil ditambahkan!');
                }
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        });
        
        async function deleteTarget(id) {
            if (!confirm('Yakin ingin menghapus target ini?')) return;
            
            setSyncStatus('syncing');
            try {
                const { error } = await supabase.from('targets').delete().eq('id', id);
                if (error) throw error;
                
                await loadAllData();
                renderTargets();
                showToast('Target berhasil dihapus!');
            } catch (error) {
                showToast('Error: ' + error.message, true);
            }
            setSyncStatus('online');
        }

        // ===================== SETTINGS =====================
        async function exportData(format) {
            const exportObj = {
                accounts: cache.accounts,
                categories: [...cache.categories.income, ...cache.categories.expense],
                transactions: cache.transactions,
                transfers: cache.transfers,
                budgets: cache.budgets,
                exportDate: new Date().toISOString()
            };

            if (format === 'json') {
                const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `keuangan_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showToast('Data berhasil di-export!');
            } else if (format === 'csv') {
                let csv = 'Tanggal,Tipe,Kategori,Akun,Jumlah,Catatan\n';
                const allCats = [...cache.categories.income, ...cache.categories.expense];
                cache.transactions.forEach(t => {
                    const cat = allCats.find(c => c.id === t.category_id);
                    const acc = cache.accounts.find(a => a.id === t.account_id);
                    csv += `"${t.transaction_date}","${t.type}","${cat?.name || '-'}","${acc?.name || '-'}",${t.amount},"${t.note || ''}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `keuangan_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                showToast('Data berhasil di-export!');
            }
        }

        // ===================== INITIALIZATION =====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showPage(this.dataset.page);
                });
            });

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('sidebar');
                const mobileBtn = document.getElementById('mobileMenuBtn');
                if (window.innerWidth < 768 && !sidebar.contains(e.target) && !mobileBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            });

            // Load data from Supabase
            const loaded = await loadAllData();
            if (loaded) {
                updateDashboard();
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            setSyncStatus('online');
            showToast('Kembali online!');
        });

        window.addEventListener('offline', () => {
            setSyncStatus('offline');
            showToast('Anda sedang offline', true);
        });
    </script>
</body>
</html>

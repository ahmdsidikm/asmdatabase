<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Pribadi - Personal Finance Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-link.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .card-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .income-gradient { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .expense-gradient { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .balance-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .savings-gradient { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .wealth-gradient { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gold-gradient { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); }
        .bank-gradient { background: linear-gradient(135deg, #0052D4 0%, #4364F7 50%, #6FB1FC 100%); }
        .wallet-gradient { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .investment-gradient { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .modal-overlay { backdrop-filter: blur(4px); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; }
        code { font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl fixed h-full z-20 flex flex-col">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl card-gradient flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800">FinanceKu</h1>
                        <p class="text-xs text-slate-500">Personal Finance</p>
                    </div>
                </div>
            </div>
            
            <!-- Connection Status -->
            <div class="px-4 py-2 border-b border-slate-100">
                <div class="flex items-center gap-2">
                    <div id="connectionStatus" class="w-2 h-2 rounded-full bg-slate-300"></div>
                    <span id="connectionText" class="text-xs text-slate-500">Offline Mode</span>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto scrollbar-thin">
                <button onclick="showSection('dashboard')" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="dashboard">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                    <span class="font-medium">Dashboard</span>
                </button>
                
                <button onclick="showSection('accounts')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="accounts">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <span class="font-medium">Akun & Aset</span>
                </button>
                
                <button onclick="showSection('transactions')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="transactions">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="font-medium">Transaksi</span>
                </button>
                
                <button onclick="showSection('budget')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="budget">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="font-medium">Anggaran</span>
                </button>
                
                <button onclick="showSection('reports')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="reports">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="font-medium">Laporan</span>
                </button>
                
                <button onclick="showSection('supabase')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="supabase">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                    </svg>
                    <span class="font-medium">Database</span>
                </button>
                
                <button onclick="showSection('settings')" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-100 transition-all" data-section="settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="font-medium">Pengaturan</span>
                </button>
            </nav>
            
            <div class="p-4 border-t border-slate-100">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-4 text-white">
                    <p class="text-sm font-medium mb-2">ðŸ’¡ Tips Keuangan</p>
                    <p class="text-xs opacity-90" id="financeTip">Sisihkan 20% dari pendapatan untuk tabungan darurat.</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8">
            <!-- Header -->
            <header class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800" id="pageTitle">Dashboard</h2>
                    <p class="text-slate-500" id="currentDate"></p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="syncData()" id="syncBtn" class="flex items-center gap-2 bg-slate-100 text-slate-600 px-4 py-2.5 rounded-xl hover:bg-slate-200 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="font-medium">Sync</span>
                    </button>
                    <button onclick="openModal('addTransaction')" class="flex items-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-5 py-2.5 rounded-xl hover:shadow-lg hover:shadow-indigo-200 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="font-medium">Tambah Transaksi</span>
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section">
                <!-- Total Wealth Card -->
                <div class="wealth-gradient rounded-2xl p-8 text-white shadow-lg shadow-pink-200 mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm mb-1">Total Kekayaan Bersih</p>
                            <p class="text-4xl font-bold" id="totalWealth">Rp 0</p>
                            <p class="text-white/70 text-sm mt-2" id="wealthBreakdown">0 Akun Aktif</p>
                        </div>
                        <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="income-gradient rounded-2xl p-6 text-white shadow-lg shadow-emerald-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                </svg>
                            </div>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-lg" id="incomeChange">+0%</span>
                        </div>
                        <p class="text-white/80 text-sm">Total Pemasukan</p>
                        <p class="text-2xl font-bold" id="totalIncome">Rp 0</p>
                    </div>
                    
                    <div class="expense-gradient rounded-2xl p-6 text-white shadow-lg shadow-red-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                                </svg>
                            </div>
                            <span class="text-xs bg-white/20 px-2 py-1 rounded-lg" id="expenseChange">+0%</span>
                        </div>
                        <p class="text-white/80 text-sm">Total Pengeluaran</p>
                        <p class="text-2xl font-bold" id="totalExpense">Rp 0</p>
                    </div>
                    
                    <div class="balance-gradient rounded-2xl p-6 text-white shadow-lg shadow-cyan-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm">Saldo Bulan Ini</p>
                        <p class="text-2xl font-bold" id="currentBalance">Rp 0</p>
                    </div>
                    
                    <div class="savings-gradient rounded-2xl p-6 text-white shadow-lg shadow-amber-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-white/80 text-sm">Target Tabungan</p>
                        <p class="text-2xl font-bold" id="savingsProgress">0%</p>
                    </div>
                </div>

                <!-- Account Summary -->
                <div class="bg-white rounded-2xl p-6 shadow-sm mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-800">Ringkasan Akun</h3>
                        <button onclick="showSection('accounts')" class="text-indigo-600 text-sm font-medium hover:underline">Kelola Akun</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="accountSummary">
                        <p class="text-slate-500 text-center py-4 col-span-4">Belum ada akun</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-4">Tren Keuangan (6 Bulan Terakhir)</h3>
                        <canvas id="trendChart" height="200"></canvas>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-4">Pengeluaran per Kategori</h3>
                        <canvas id="categoryChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Transactions & Quick Stats -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-slate-800">Transaksi Terbaru</h3>
                            <button onclick="showSection('transactions')" class="text-indigo-600 text-sm font-medium hover:underline">Lihat Semua</button>
                        </div>
                        <div class="space-y-3" id="recentTransactions">
                            <p class="text-slate-500 text-center py-8">Belum ada transaksi</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-4">Statistik Cepat</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600 text-sm">Rata-rata Pengeluaran/Hari</span>
                                <span class="font-semibold text-slate-800" id="avgDailyExpense">Rp 0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600 text-sm">Transaksi Bulan Ini</span>
                                <span class="font-semibold text-slate-800" id="monthlyTransCount">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600 text-sm">Kategori Terbesar</span>
                                <span class="font-semibold text-slate-800" id="topCategory">-</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600 text-sm">Rasio Tabungan</span>
                                <span class="font-semibold text-slate-800" id="savingsRatio">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Accounts Section -->
            <section id="section-accounts" class="section hidden">
                <!-- Total Wealth -->
                <div class="wealth-gradient rounded-2xl p-8 text-white shadow-lg shadow-pink-200 mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-sm mb-1">Total Kekayaan Bersih</p>
                            <p class="text-4xl font-bold" id="totalWealthAccounts">Rp 0</p>
                        </div>
                        <button onclick="openModal('addAccount')" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Tambah Akun
                        </button>
                    </div>
                </div>
                
                <!-- Account Types -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="accountsList">
                    <p class="text-slate-500 text-center py-8 col-span-3">Belum ada akun</p>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="section-transactions" class="section hidden">
                <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <div class="flex-1 min-w-64">
                            <div class="relative">
                                <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input type="text" id="searchTransaction" placeholder="Cari transaksi..." class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none">
                            </div>
                        </div>
                        <select id="filterType" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="all">Semua Tipe</option>
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                            <option value="transfer">Transfer</option>
                        </select>
                        <select id="filterCategory" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="all">Semua Kategori</option>
                        </select>
                        <select id="filterAccount" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="all">Semua Akun</option>
                        </select>
                        <input type="month" id="filterMonth" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-slate-100">
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Tanggal</th>
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Deskripsi</th>
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Akun</th>
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Kategori</th>
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Tipe</th>
                                    <th class="text-right py-3 px-4 text-slate-600 font-medium">Jumlah</th>
                                    <th class="text-center py-3 px-4 text-slate-600 font-medium">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList">
                                <tr>
                                    <td colspan="7" class="text-center py-12 text-slate-500">Belum ada transaksi</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Budget Section -->
            <section id="section-budget" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold text-slate-800">Anggaran Bulanan</h3>
                            <button onclick="openModal('addBudget')" class="text-indigo-600 font-medium text-sm hover:underline">+ Tambah Anggaran</button>
                        </div>
                        <div class="space-y-4" id="budgetList">
                            <p class="text-slate-500 text-center py-8">Belum ada anggaran</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-6">Target Tabungan</h3>
                        <div class="space-y-6">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-32 h-32 rounded-full border-8 border-indigo-100 mb-4">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-indigo-600" id="savingsPercentage">0%</p>
                                        <p class="text-xs text-slate-500">Tercapai</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Target</span>
                                    <span class="font-medium text-slate-800" id="savingsTarget">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Terkumpul</span>
                                    <span class="font-medium text-emerald-600" id="savingsCollected">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Sisa</span>
                                    <span class="font-medium text-slate-800" id="savingsRemaining">Rp 0</span>
                                </div>
                            </div>
                            <button onclick="openModal('setSavingsTarget')" class="w-full py-2.5 border-2 border-dashed border-indigo-200 text-indigo-600 rounded-xl hover:bg-indigo-50 transition-all font-medium">
                                Ubah Target Tabungan
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-2">Laporan Bulanan</h3>
                        <p class="text-slate-500 text-sm mb-4">Ringkasan keuangan bulan ini</p>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Pemasukan</span>
                                <span class="font-semibold text-emerald-600" id="reportIncome">Rp 0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Total Pengeluaran</span>
                                <span class="font-semibold text-red-500" id="reportExpense">Rp 0</span>
                            </div>
                            <hr class="border-slate-100">
                            <div class="flex justify-between">
                                <span class="text-slate-600 font-medium">Selisih</span>
                                <span class="font-bold" id="reportDiff">Rp 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-4">Perbandingan Bulanan</h3>
                        <canvas id="monthlyCompareChart" height="150"></canvas>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-semibold text-slate-800">Detail Pengeluaran per Kategori</h3>
                        <select id="reportMonth" class="px-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-slate-100">
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Kategori</th>
                                    <th class="text-right py-3 px-4 text-slate-600 font-medium">Jumlah</th>
                                    <th class="text-right py-3 px-4 text-slate-600 font-medium">Persentase</th>
                                    <th class="text-left py-3 px-4 text-slate-600 font-medium">Grafik</th>
                                </tr>
                            </thead>
                            <tbody id="categoryReportList">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="exportData('csv')" class="flex items-center gap-2 px-5 py-2.5 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="exportData('json')" class="flex items-center gap-2 px-5 py-2.5 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Export JSON
                    </button>
                </div>
            </section>

            <!-- Supabase Section -->
            <section id="section-supabase" class="section hidden">
                <div class="max-w-4xl">
                    <!-- Connection Setup -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <h3 class="font-semibold text-slate-800 mb-6 flex items-center gap-2">
                            <svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                            </svg>
                            Koneksi Supabase
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Supabase Project URL</label>
                                <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Supabase Anon Key</label>
                                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                            </div>
                            <div class="flex gap-3">
                                <button onclick="connectSupabase()" class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                                    Hubungkan ke Supabase
                                </button>
                                <button onclick="testConnection()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-all">
                                    Test
                                </button>
                                <button onclick="disconnectSupabase()" class="px-6 py-3 bg-slate-100 text-slate-600 rounded-xl font-medium hover:bg-slate-200 transition-all">
                                    Putuskan
                                </button>
                            </div>
                            
                            <!-- Debug Info -->
                            <div id="debugInfo" class="hidden mt-4 p-4 bg-slate-800 rounded-xl text-sm font-mono">
                                <p class="text-emerald-400 mb-2">Debug Info:</p>
                                <pre id="debugText" class="text-slate-300 text-xs whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SQL Setup Guide -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Petunjuk Setup SQL
                        </h3>
                        <p class="text-slate-600 mb-4">Jalankan SQL berikut di Supabase SQL Editor untuk membuat tabel yang diperlukan:</p>
                        
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">1. Tabel Akun (accounts)</span>
                                    <button onclick="copySQL('sql1')" class="text-xs text-indigo-600 hover:underline">Copy</button>
                                </div>
                                <pre id="sql1">-- Tabel untuk menyimpan akun/aset
CREATE TABLE accounts (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'bank', 'wallet', 'gold', 'investment', 'crypto', 'other'
    balance DECIMAL(15,2) DEFAULT 0,
    currency VARCHAR(10) DEFAULT 'IDR',
    icon VARCHAR(50),
    color VARCHAR(50),
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE accounts ENABLE ROW LEVEL SECURITY;

-- Policy untuk akses publik (sesuaikan dengan kebutuhan auth)
CREATE POLICY "Allow all access" ON accounts FOR ALL USING (true);</pre>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">2. Tabel Transaksi (transactions)</span>
                                    <button onclick="copySQL('sql2')" class="text-xs text-indigo-600 hover:underline">Copy</button>
                                </div>
                                <pre id="sql2">-- Tabel untuk menyimpan transaksi
CREATE TABLE transactions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    account_id UUID REFERENCES accounts(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL, -- 'income', 'expense', 'transfer'
    amount DECIMAL(15,2) NOT NULL,
    category VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    notes TEXT,
    date DATE NOT NULL,
    to_account_id UUID REFERENCES accounts(id), -- untuk transfer
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Policy untuk akses publik
CREATE POLICY "Allow all access" ON transactions FOR ALL USING (true);</pre>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">3. Tabel Anggaran (budgets)</span>
                                    <button onclick="copySQL('sql3')" class="text-xs text-indigo-600 hover:underline">Copy</button>
                                </div>
                                <pre id="sql3">-- Tabel untuk menyimpan anggaran
CREATE TABLE budgets (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    category VARCHAR(100) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    period VARCHAR(20) DEFAULT 'monthly', -- 'monthly', 'yearly'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE budgets ENABLE ROW LEVEL SECURITY;

-- Policy untuk akses publik
CREATE POLICY "Allow all access" ON budgets FOR ALL USING (true);</pre>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">4. Tabel Pengaturan (settings)</span>
                                    <button onclick="copySQL('sql4')" class="text-xs text-indigo-600 hover:underline">Copy</button>
                                </div>
                                <pre id="sql4">-- Tabel untuk menyimpan pengaturan
CREATE TABLE settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;

-- Policy untuk akses publik
CREATE POLICY "Allow all access" ON settings FOR ALL USING (true);

-- Insert default settings
INSERT INTO settings (key, value) VALUES 
('currency', '"IDR"'),
('savings_target', '0'),
('categories', '{"income": ["Gaji", "Freelance", "Investasi", "Bonus", "Lainnya"], "expense": ["Makanan", "Transportasi", "Belanja", "Tagihan", "Hiburan", "Kesehatan", "Pendidikan", "Lainnya"]}');</pre>
                            </div>
                            
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">5. Function untuk Update Balance (opsional)</span>
                                    <button onclick="copySQL('sql5')" class="text-xs text-indigo-600 hover:underline">Copy</button>
                                </div>
                                <pre id="sql5">-- Function untuk auto-update balance akun
CREATE OR REPLACE FUNCTION update_account_balance()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        IF NEW.type = 'income' THEN
            UPDATE accounts SET balance = balance + NEW.amount WHERE id = NEW.account_id;
        ELSIF NEW.type = 'expense' THEN
            UPDATE accounts SET balance = balance - NEW.amount WHERE id = NEW.account_id;
        ELSIF NEW.type = 'transfer' THEN
            UPDATE accounts SET balance = balance - NEW.amount WHERE id = NEW.account_id;
            UPDATE accounts SET balance = balance + NEW.amount WHERE id = NEW.to_account_id;
        END IF;
    ELSIF TG_OP = 'DELETE' THEN
        IF OLD.type = 'income' THEN
            UPDATE accounts SET balance = balance - OLD.amount WHERE id = OLD.account_id;
        ELSIF OLD.type = 'expense' THEN
            UPDATE accounts SET balance = balance + OLD.amount WHERE id = OLD.account_id;
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger
CREATE TRIGGER transaction_balance_trigger
AFTER INSERT OR DELETE ON transactions
FOR EACH ROW EXECUTE FUNCTION update_account_balance();</pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sync Status -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-4">Status Sinkronisasi</h3>
                        <div class="space-y-3" id="syncStatus">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600">Status Koneksi</span>
                                <span class="font-medium" id="dbConnectionStatus">Tidak Terhubung</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600">Terakhir Sync</span>
                                <span class="font-medium text-slate-800" id="lastSyncTime">-</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-slate-600">Data Lokal</span>
                                <span class="font-medium text-slate-800" id="localDataCount">0 transaksi</span>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-3">
                            <button onclick="syncToSupabase()" class="flex-1 py-2.5 bg-indigo-500 text-white rounded-xl font-medium hover:bg-indigo-600 transition-all">
                                Upload ke Cloud
                            </button>
                            <button onclick="syncFromSupabase()" class="flex-1 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-all">
                                Download dari Cloud
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <div class="max-w-2xl">
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <h3 class="font-semibold text-slate-800 mb-6">Pengaturan Umum</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Mata Uang</label>
                                <select id="currency" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="IDR">IDR - Rupiah Indonesia</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <h3 class="font-semibold text-slate-800 mb-6">Kelola Kategori</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="newCategory" placeholder="Nama kategori baru" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                            <select id="newCategoryType" class="px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="expense">Pengeluaran</option>
                                <option value="income">Pemasukan</option>
                            </select>
                            <button onclick="addCategory()" class="px-5 py-2.5 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 transition-all">Tambah</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-sm font-medium text-slate-600 mb-2">Kategori Pengeluaran</h4>
                                <div class="space-y-2" id="expenseCategoriesList"></div>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-slate-600 mb-2">Kategori Pemasukan</h4>
                                <div class="space-y-2" id="incomeCategoriesList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                        <h3 class="font-semibold text-slate-800 mb-6">Data & Backup</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                                <div>
                                    <p class="font-medium text-slate-800">Import Data</p>
                                    <p class="text-sm text-slate-500">Muat data dari file JSON</p>
                                </div>
                                <label class="px-4 py-2 bg-indigo-500 text-white rounded-lg cursor-pointer hover:bg-indigo-600 transition-all">
                                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
                                    Import
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-red-50 rounded-xl">
                                <div>
                                    <p class="font-medium text-red-800">Hapus Semua Data</p>
                                    <p class="text-sm text-red-500">Tindakan ini tidak dapat dibatalkan</p>
                                </div>
                                <button onclick="clearAllData()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">Hapus</button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                        Simpan Pengaturan
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Transaction Modal -->
    <div id="modal-addTransaction" class="fixed inset-0 bg-black/50 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md fade-in max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-100 sticky top-0 bg-white rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Tambah Transaksi</h3>
                    <button onclick="closeModal('addTransaction')" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="transactionForm" class="p-6 space-y-4">
                <div class="flex gap-2">
                    <button type="button" onclick="setTransactionType('income')" id="btnIncome" class="flex-1 py-2.5 border-2 border-emerald-500 text-emerald-500 rounded-xl font-medium hover:bg-emerald-50 transition-all">Pemasukan</button>
                    <button type="button" onclick="setTransactionType('expense')" id="btnExpense" class="flex-1 py-2.5 border-2 border-red-500 bg-red-500 text-white rounded-xl font-medium transition-all">Pengeluaran</button>
                    <button type="button" onclick="setTransactionType('transfer')" id="btnTransfer" class="flex-1 py-2.5 border-2 border-blue-500 text-blue-500 rounded-xl font-medium hover:bg-blue-50 transition-all">Transfer</button>
                </div>
                <input type="hidden" id="transactionType" value="expense">
                <input type="hidden" id="editTransactionId" value="">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Akun Sumber</label>
                    <select id="transactionAccount" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </select>
                </div>
                
                <div id="transferToAccount" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Akun Tujuan</label>
                    <select id="transactionToAccount" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Jumlah</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">Rp</span>
                        <input type="number" id="transactionAmount" required min="0" placeholder="0" class="w-full pl-12 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div id="categoryField">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Kategori</label>
                    <select id="transactionCategory" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Deskripsi</label>
                    <input type="text" id="transactionDesc" required placeholder="Contoh: Belanja bulanan" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Tanggal</label>
                    <input type="date" id="transactionDate" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Catatan (Opsional)</label>
                    <textarea id="transactionNotes" rows="2" placeholder="Tambahkan catatan..." class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                </div>
                
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                    Simpan Transaksi
                </button>
            </form>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="modal-addAccount" class="fixed inset-0 bg-black/50 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md fade-in">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Tambah Akun</h3>
                    <button onclick="closeModal('addAccount')" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="accountForm" class="p-6 space-y-4">
                <input type="hidden" id="editAccountId" value="">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nama Akun</label>
                    <input type="text" id="accountName" required placeholder="Contoh: Bank BCA" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Tipe Akun</label>
                    <select id="accountType" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="bank">ðŸ¦ Bank</option>
                        <option value="wallet">ðŸ‘› Dompet/E-Wallet</option>
                        <option value="gold">ðŸ¥‡ Emas</option>
                        <option value="investment">ðŸ“ˆ Investasi/Saham</option>
                        <option value="crypto">â‚¿ Crypto</option>
                        <option value="deposit">ðŸ’° Deposito</option>
                        <option value="receivable">ðŸ“‹ Piutang</option>
                        <option value="other">ðŸ“ Lainnya</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Saldo Awal</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">Rp</span>
                        <input type="number" id="accountBalance" required min="0" placeholder="0" class="w-full pl-12 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Deskripsi (Opsional)</label>
                    <input type="text" id="accountDesc" placeholder="Rekening tabungan utama" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                    Simpan Akun
                </button>
            </form>
        </div>
    </div>

    <!-- Add Budget Modal -->
    <div id="modal-addBudget" class="fixed inset-0 bg-black/50 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md fade-in">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Tambah Anggaran</h3>
                    <button onclick="closeModal('addBudget')" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="budgetForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Kategori</label>
                    <select id="budgetCategory" required class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Batas Anggaran</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">Rp</span>
                        <input type="number" id="budgetAmount" required min="0" placeholder="0" class="w-full pl-12 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                    Simpan Anggaran
                </button>
            </form>
        </div>
    </div>

    <!-- Set Savings Target Modal -->
    <div id="modal-setSavingsTarget" class="fixed inset-0 bg-black/50 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md fade-in">
            <div class="p-6 border-b border-slate-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-800">Target Tabungan</h3>
                    <button onclick="closeModal('setSavingsTarget')" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="savingsForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Target Tabungan</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">Rp</span>
                        <input type="number" id="savingsTargetInput" required min="0" placeholder="0" class="w-full pl-12 pr-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                    Simpan Target
                </button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50">
        <p id="toastMessage"></p>
    </div>

    <script>
        // Data Store
        let data = {
            accounts: [],
            transactions: [],
            budgets: [],
            categories: {
                income: ['Gaji', 'Freelance', 'Investasi', 'Bonus', 'Lainnya'],
                expense: ['Makanan', 'Transportasi', 'Belanja', 'Tagihan', 'Hiburan', 'Kesehatan', 'Pendidikan', 'Lainnya']
            },
            settings: {
                currency: 'IDR',
                savingsTarget: 0
            },
            supabase: {
                url: '',
                key: '',
                connected: false,
                lastSync: null
            }
        };

        // Supabase client
        let supabaseClient = null;

        // Finance Tips
        const tips = [
            'Sisihkan 20% dari pendapatan untuk tabungan darurat.',
            'Catat semua pengeluaran, sekecil apapun.',
            'Buat anggaran dan patuhi dengan disiplin.',
            'Hindari utang konsumtif yang tidak perlu.',
            'Investasikan uang Anda untuk masa depan.',
            'Bayar tagihan tepat waktu untuk menghindari denda.',
            'Bedakan antara kebutuhan dan keinginan.',
            'Siapkan dana darurat minimal 3-6 bulan pengeluaran.'
        ];

        // Account type icons and colors
        const accountTypes = {
            bank: { icon: 'ðŸ¦', gradient: 'bank-gradient', label: 'Bank' },
            wallet: { icon: 'ðŸ‘›', gradient: 'wallet-gradient', label: 'Dompet/E-Wallet' },
            gold: { icon: 'ðŸ¥‡', gradient: 'gold-gradient', label: 'Emas' },
            investment: { icon: 'ðŸ“ˆ', gradient: 'investment-gradient', label: 'Investasi' },
            crypto: { icon: 'â‚¿', gradient: 'card-gradient', label: 'Crypto' },
            deposit: { icon: 'ðŸ’°', gradient: 'savings-gradient', label: 'Deposito' },
            receivable: { icon: 'ðŸ“‹', gradient: 'balance-gradient', label: 'Piutang' },
            other: { icon: 'ðŸ“', gradient: 'expense-gradient', label: 'Lainnya' }
        };

        // Chart instances
        let trendChart, categoryChart, monthlyCompareChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateCurrentDate();
            initializeCharts();
            updateDashboard();
            updateCategorySelects();
            updateCategoriesUI();
            setRandomTip();
            setupEventListeners();
            updateConnectionStatus();
            loadSupabaseCredentials();
            
            // Set default date
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            // Set current month filter
            const now = new Date();
            document.getElementById('filterMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        });

        // Load/Save Data
        function loadData() {
            const saved = localStorage.getItem('financeData');
            if (saved) {
                const parsed = JSON.parse(saved);
                data = { ...data, ...parsed };
            }
        }

        function saveData() {
            localStorage.setItem('financeData', JSON.stringify(data));
        }

        // Supabase Functions
        function loadSupabaseCredentials() {
            if (data.supabase.url && data.supabase.key) {
                document.getElementById('supabaseUrl').value = data.supabase.url;
                document.getElementById('supabaseKey').value = data.supabase.key;
                if (data.supabase.connected) {
                    initSupabase();
                    updateConnectionStatus();
                }
            }
        }
        
        // Auto-reconnect on page load if was connected
        async function autoReconnect() {
            if (data.supabase.url && data.supabase.key && data.supabase.connected) {
                if (initSupabase()) {
                    console.log('Auto-reconnected to Supabase');
                }
            }
        }

        function initSupabase() {
            try {
                // Clean URL - remove trailing slash if exists
                let url = data.supabase.url.trim();
                if (url.endsWith('/')) {
                    url = url.slice(0, -1);
                }
                data.supabase.url = url;
                
                // Check if supabase library is loaded
                const supabaseLib = window.supabase;
                if (!supabaseLib || !supabaseLib.createClient) {
                    console.error('Supabase library not loaded');
                    return false;
                }
                
                supabaseClient = supabaseLib.createClient(url, data.supabase.key, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false
                    }
                });
                console.log('Supabase client initialized:', url);
                return true;
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        async function connectSupabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showToast('Masukkan URL dan API Key!');
                return;
            }
            
            // Validate URL format
            if (!url.includes('supabase.co')) {
                showToast('URL tidak valid! Gunakan format: https://xxxxx.supabase.co');
                return;
            }
            
            data.supabase.url = url;
            data.supabase.key = key;
            
            showToast('Menghubungkan ke Supabase...');
            
            if (initSupabase()) {
                try {
                    // Test connection with multiple methods
                    let connected = false;
                    let errorMsg = '';
                    
                    // Method 1: Try to query accounts table
                    try {
                        const { data: accData, error: accError } = await supabaseClient
                            .from('accounts')
                            .select('id')
                            .limit(1);
                        
                        if (!accError) {
                            connected = true;
                        } else {
                            errorMsg = accError.message;
                        }
                    } catch (e) {
                        errorMsg = e.message;
                    }
                    
                    // Method 2: If accounts failed, try settings table
                    if (!connected) {
                        try {
                            const { data: setData, error: setError } = await supabaseClient
                                .from('settings')
                                .select('id')
                                .limit(1);
                            
                            if (!setError) {
                                connected = true;
                            }
                        } catch (e) {
                            // Keep original error
                        }
                    }
                    
                    // Method 3: Try a simple RPC or REST health check
                    if (!connected) {
                        try {
                            // Try to access the REST API directly
                            const response = await fetch(`${url}/rest/v1/`, {
                                headers: {
                                    'apikey': key,
                                    'Authorization': `Bearer ${key}`
                                }
                            });
                            
                            if (response.ok || response.status === 200 || response.status === 404) {
                                connected = true;
                            }
                        } catch (e) {
                            // Network error
                        }
                    }
                    
                    if (connected) {
                        data.supabase.connected = true;
                        saveData();
                        updateConnectionStatus();
                        showToast('âœ… Berhasil terhubung ke Supabase!');
                    } else {
                        throw new Error(errorMsg || 'Tidak dapat terhubung. Pastikan tabel sudah dibuat.');
                    }
                    
                } catch (error) {
                    console.error('Connection error:', error);
                    data.supabase.connected = false;
                    
                    // More helpful error messages
                    let msg = error.message;
                    if (msg.includes('JWT')) {
                        msg = 'API Key tidak valid!';
                    } else if (msg.includes('fetch') || msg.includes('network')) {
                        msg = 'Gagal menghubungi server. Periksa koneksi internet.';
                    } else if (msg.includes('relation') || msg.includes('does not exist')) {
                        // Table doesn't exist but connection works!
                        data.supabase.connected = true;
                        saveData();
                        updateConnectionStatus();
                        showToast('âœ… Terhubung! Tabel belum dibuat - jalankan SQL di bawah.');
                        return;
                    }
                    
                    showToast('âŒ Gagal: ' + msg);
                }
            } else {
                showToast('âŒ Gagal inisialisasi Supabase client');
            }
        }

        function disconnectSupabase() {
            data.supabase.connected = false;
            supabaseClient = null;
            saveData();
            updateConnectionStatus();
            document.getElementById('debugInfo').classList.add('hidden');
            showToast('Koneksi Supabase diputus');
        }
        
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            const debugDiv = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            debugDiv.classList.remove('hidden');
            
            let logs = [];
            logs.push(`URL: ${url}`);
            logs.push(`Key: ${key.substring(0, 20)}...`);
            logs.push(`---`);
            
            if (!url || !key) {
                logs.push('âŒ URL atau Key kosong!');
                debugText.textContent = logs.join('\n');
                return;
            }
            
            // Test 1: Basic fetch to Supabase
            logs.push('Test 1: Ping REST API...');
            debugText.textContent = logs.join('\n');
            
            try {
                const response = await fetch(`${url}/rest/v1/`, {
                    method: 'GET',
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });
                logs.push(`  Status: ${response.status} ${response.statusText}`);
                
                if (response.status === 200) {
                    logs.push('  âœ… REST API OK');
                } else if (response.status === 401) {
                    logs.push('  âŒ API Key tidak valid!');
                } else {
                    logs.push('  âš ï¸ Response tidak standar');
                }
            } catch (e) {
                logs.push(`  âŒ Error: ${e.message}`);
            }
            
            debugText.textContent = logs.join('\n');
            
            // Test 2: Initialize client and query
            logs.push('---');
            logs.push('Test 2: Supabase Client...');
            debugText.textContent = logs.join('\n');
            
            try {
                const supabaseLib = window.supabase;
                if (!supabaseLib || !supabaseLib.createClient) {
                    throw new Error('Library Supabase belum dimuat. Refresh halaman.');
                }
                const testClient = supabaseLib.createClient(url, key);
                logs.push('  âœ… Client dibuat');
                
                // Try accounts table
                logs.push('Test 3: Query tabel accounts...');
                debugText.textContent = logs.join('\n');
                
                const { data: accData, error: accError } = await testClient
                    .from('accounts')
                    .select('*')
                    .limit(1);
                
                if (accError) {
                    logs.push(`  âš ï¸ Error: ${accError.message}`);
                    if (accError.message.includes('does not exist')) {
                        logs.push('  ðŸ“ Tabel belum dibuat - jalankan SQL');
                    } else if (accError.message.includes('JWSError') || accError.message.includes('JWT')) {
                        logs.push('  âŒ API Key tidak valid!');
                    }
                } else {
                    logs.push(`  âœ… OK - ${accData ? accData.length : 0} row(s)`);
                }
                
            } catch (e) {
                logs.push(`  âŒ Error: ${e.message}`);
            }
            
            logs.push('---');
            logs.push('Test selesai!');
            debugText.textContent = logs.join('\n');
        }

        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            const dbStatus = document.getElementById('dbConnectionStatus');
            
            if (data.supabase.connected) {
                status.className = 'w-2 h-2 rounded-full bg-emerald-500';
                text.textContent = 'Connected to Supabase';
                text.className = 'text-xs text-emerald-600';
                dbStatus.textContent = 'Terhubung';
                dbStatus.className = 'font-medium text-emerald-600';
            } else {
                status.className = 'w-2 h-2 rounded-full bg-slate-300';
                text.textContent = 'Offline Mode';
                text.className = 'text-xs text-slate-500';
                dbStatus.textContent = 'Tidak Terhubung';
                dbStatus.className = 'font-medium text-slate-500';
            }
            
            document.getElementById('lastSyncTime').textContent = data.supabase.lastSync 
                ? new Date(data.supabase.lastSync).toLocaleString('id-ID') 
                : '-';
            document.getElementById('localDataCount').textContent = `${data.transactions.length} transaksi, ${data.accounts.length} akun`;
        }

        async function syncToSupabase() {
            if (!data.supabase.connected) {
                showToast('Hubungkan ke Supabase terlebih dahulu!');
                return;
            }
            
            // Re-initialize client if needed
            if (!supabaseClient) {
                initSupabase();
            }
            
            try {
                showToast('Mengupload data...');
                
                let successCount = 0;
                let errorCount = 0;
                
                // Sync accounts
                if (data.accounts.length > 0) {
                    for (const account of data.accounts) {
                        try {
                            const { error } = await supabaseClient.from('accounts').upsert({
                                id: account.id,
                                name: account.name,
                                type: account.type,
                                balance: account.balance,
                                description: account.description || '',
                                is_active: true
                            }, { onConflict: 'id' });
                            
                            if (error) {
                                console.error('Account sync error:', error);
                                errorCount++;
                            } else {
                                successCount++;
                            }
                        } catch (e) {
                            console.error('Account sync exception:', e);
                            errorCount++;
                        }
                    }
                }
                
                // Sync transactions
                if (data.transactions.length > 0) {
                    for (const trans of data.transactions) {
                        try {
                            const { error } = await supabaseClient.from('transactions').upsert({
                                id: trans.id,
                                account_id: trans.accountId,
                                type: trans.type,
                                amount: trans.amount,
                                category: trans.category,
                                description: trans.description,
                                notes: trans.notes || '',
                                date: trans.date,
                                to_account_id: trans.toAccountId || null
                            }, { onConflict: 'id' });
                            
                            if (error) {
                                console.error('Transaction sync error:', error);
                                errorCount++;
                            } else {
                                successCount++;
                            }
                        } catch (e) {
                            console.error('Transaction sync exception:', e);
                            errorCount++;
                        }
                    }
                }
                
                // Sync budgets
                if (data.budgets.length > 0) {
                    for (const budget of data.budgets) {
                        try {
                            const { error } = await supabaseClient.from('budgets').upsert({
                                id: budget.id,
                                category: budget.category,
                                amount: budget.amount
                            }, { onConflict: 'id' });
                            
                            if (error) {
                                console.error('Budget sync error:', error);
                                errorCount++;
                            } else {
                                successCount++;
                            }
                        } catch (e) {
                            console.error('Budget sync exception:', e);
                            errorCount++;
                        }
                    }
                }
                
                data.supabase.lastSync = new Date().toISOString();
                saveData();
                updateConnectionStatus();
                
                if (errorCount === 0) {
                    showToast(`âœ… ${successCount} item berhasil diupload!`);
                } else {
                    showToast(`âš ï¸ ${successCount} OK, ${errorCount} gagal. Cek console.`);
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('âŒ Gagal sync: ' + error.message);
            }
        }

        async function syncFromSupabase() {
            if (!data.supabase.connected) {
                showToast('Hubungkan ke Supabase terlebih dahulu!');
                return;
            }
            
            // Re-initialize client if needed
            if (!supabaseClient) {
                initSupabase();
            }
            
            try {
                showToast('Mengdownload data...');
                
                let hasData = false;
                
                // Get accounts
                try {
                    const { data: accounts, error: accError } = await supabaseClient
                        .from('accounts')
                        .select('*');
                    
                    if (accError) {
                        console.error('Accounts fetch error:', accError);
                        if (accError.message.includes('does not exist')) {
                            showToast('âš ï¸ Tabel accounts belum dibuat');
                        }
                    } else if (accounts && accounts.length > 0) {
                        data.accounts = accounts.map(a => ({
                            id: a.id,
                            name: a.name,
                            type: a.type,
                            balance: parseFloat(a.balance) || 0,
                            description: a.description || ''
                        }));
                        hasData = true;
                    }
                } catch (e) {
                    console.error('Accounts exception:', e);
                }
                
                // Get transactions
                try {
                    const { data: transactions, error: transError } = await supabaseClient
                        .from('transactions')
                        .select('*');
                    
                    if (transError) {
                        console.error('Transactions fetch error:', transError);
                    } else if (transactions && transactions.length > 0) {
                        data.transactions = transactions.map(t => ({
                            id: t.id,
                            accountId: t.account_id,
                            type: t.type,
                            amount: parseFloat(t.amount) || 0,
                            category: t.category,
                            description: t.description,
                            notes: t.notes || '',
                            date: t.date,
                            toAccountId: t.to_account_id
                        }));
                        hasData = true;
                    }
                } catch (e) {
                    console.error('Transactions exception:', e);
                }
                
                // Get budgets
                try {
                    const { data: budgets, error: budError } = await supabaseClient
                        .from('budgets')
                        .select('*');
                    
                    if (budError) {
                        console.error('Budgets fetch error:', budError);
                    } else if (budgets && budgets.length > 0) {
                        data.budgets = budgets.map(b => ({
                            id: b.id,
                            category: b.category,
                            amount: parseFloat(b.amount) || 0
                        }));
                        hasData = true;
                    }
                } catch (e) {
                    console.error('Budgets exception:', e);
                }
                
                data.supabase.lastSync = new Date().toISOString();
                saveData();
                updateDashboard();
                updateAccountsUI();
                updateConnectionStatus();
                
                if (hasData) {
                    showToast(`âœ… Data berhasil didownload! ${data.accounts.length} akun, ${data.transactions.length} transaksi`);
                } else {
                    showToast('â„¹ï¸ Tidak ada data di cloud atau tabel belum dibuat');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('âŒ Gagal sync: ' + error.message);
            }
        }

        async function syncData() {
            if (data.supabase.connected) {
                await syncToSupabase();
            } else {
                showToast('Mode offline - data tersimpan di browser');
            }
        }

        function copySQL(id) {
            const sql = document.getElementById(id).textContent;
            navigator.clipboard.writeText(sql);
            showToast('SQL berhasil dicopy!');
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: data.settings.currency || 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function setRandomTip() {
            const tip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('financeTip').textContent = tip;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === section) {
                    link.classList.add('active');
                }
            });

            const titles = {
                dashboard: 'Dashboard',
                accounts: 'Akun & Aset',
                transactions: 'Transaksi',
                budget: 'Anggaran',
                reports: 'Laporan',
                supabase: 'Database',
                settings: 'Pengaturan'
            };
            document.getElementById('pageTitle').textContent = titles[section];

            if (section === 'accounts') updateAccountsUI();
            if (section === 'transactions') updateTransactionsList();
            if (section === 'budget') updateBudgetUI();
            if (section === 'reports') updateReports();
            if (section === 'settings') loadSettings();
            if (section === 'supabase') updateConnectionStatus();
        }

        // Modal Functions
        function openModal(modal) {
            document.getElementById(`modal-${modal}`).classList.remove('hidden');
            if (modal === 'addTransaction') {
                setTransactionType('expense');
                document.getElementById('editTransactionId').value = '';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').valueAsDate = new Date();
                updateAccountSelects();
            }
            if (modal === 'addAccount') {
                document.getElementById('editAccountId').value = '';
                document.getElementById('accountForm').reset();
            }
        }

        function closeModal(modal) {
            document.getElementById(`modal-${modal}`).classList.add('hidden');
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('translate-y-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }

        // Account Functions
        function addAccount(e) {
            e.preventDefault();
            
            const account = {
                id: document.getElementById('editAccountId').value || generateId(),
                name: document.getElementById('accountName').value,
                type: document.getElementById('accountType').value,
                balance: parseFloat(document.getElementById('accountBalance').value),
                description: document.getElementById('accountDesc').value
            };

            const editId = document.getElementById('editAccountId').value;
            if (editId) {
                const index = data.accounts.findIndex(a => a.id === editId);
                if (index !== -1) data.accounts[index] = account;
            } else {
                data.accounts.push(account);
            }

            saveData();
            updateDashboard();
            updateAccountsUI();
            closeModal('addAccount');
            showToast('Akun berhasil disimpan!');
        }

        function editAccount(id) {
            const account = data.accounts.find(a => a.id === id);
            if (!account) return;

            document.getElementById('editAccountId').value = id;
            document.getElementById('accountName').value = account.name;
            document.getElementById('accountType').value = account.type;
            document.getElementById('accountBalance').value = account.balance;
            document.getElementById('accountDesc').value = account.description || '';
            
            openModal('addAccount');
        }

        function deleteAccount(id) {
            if (!confirm('Hapus akun ini? Semua transaksi terkait akan tetap ada.')) return;
            
            data.accounts = data.accounts.filter(a => a.id !== id);
            saveData();
            updateDashboard();
            updateAccountsUI();
            showToast('Akun berhasil dihapus!');
        }

        function updateAccountsUI() {
            const container = document.getElementById('accountsList');
            
            if (data.accounts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-12">
                        <p class="text-slate-500 mb-4">Belum ada akun</p>
                        <button onclick="openModal('addAccount')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Tambah Akun Pertama</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.accounts.map(account => {
                const type = accountTypes[account.type] || accountTypes.other;
                return `
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        <div class="${type.gradient} p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-3xl">${type.icon}</span>
                                <div class="flex gap-2">
                                    <button onclick="editAccount('${account.id}')" class="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-all">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="deleteAccount('${account.id}')" class="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-all">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p class="text-white/80 text-sm">${type.label}</p>
                            <p class="text-2xl font-bold">${formatCurrency(account.balance)}</p>
                        </div>
                        <div class="p-4">
                            <p class="font-semibold text-slate-800">${account.name}</p>
                            ${account.description ? `<p class="text-sm text-slate-500">${account.description}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Update total wealth
            const totalWealth = data.accounts.reduce((sum, a) => sum + a.balance, 0);
            document.getElementById('totalWealthAccounts').textContent = formatCurrency(totalWealth);
        }

        function updateAccountSummary() {
            const container = document.getElementById('accountSummary');
            
            if (data.accounts.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-4 col-span-4">Belum ada akun</p>';
                return;
            }

            // Group by type
            const grouped = {};
            data.accounts.forEach(acc => {
                if (!grouped[acc.type]) grouped[acc.type] = 0;
                grouped[acc.type] += acc.balance;
            });

            container.innerHTML = Object.entries(grouped).map(([type, balance]) => {
                const typeInfo = accountTypes[type] || accountTypes.other;
                return `
                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">${typeInfo.icon}</span>
                            <span class="text-sm text-slate-600">${typeInfo.label}</span>
                        </div>
                        <p class="font-bold text-slate-800">${formatCurrency(balance)}</p>
                    </div>
                `;
            }).join('');
        }

        function updateAccountSelects() {
            const selects = ['transactionAccount', 'transactionToAccount', 'filterAccount'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                if (id === 'filterAccount') {
                    select.innerHTML = '<option value="all">Semua Akun</option>';
                } else {
                    select.innerHTML = '';
                }
                
                data.accounts.forEach(acc => {
                    const type = accountTypes[acc.type] || accountTypes.other;
                    select.innerHTML += `<option value="${acc.id}">${type.icon} ${acc.name}</option>`;
                });
            });
        }

        // Transaction Functions
        function setTransactionType(type) {
            document.getElementById('transactionType').value = type;
            const btnIncome = document.getElementById('btnIncome');
            const btnExpense = document.getElementById('btnExpense');
            const btnTransfer = document.getElementById('btnTransfer');
            const transferField = document.getElementById('transferToAccount');
            const categoryField = document.getElementById('categoryField');
            
            // Reset all buttons
            btnIncome.classList.remove('bg-emerald-500', 'text-white');
            btnIncome.classList.add('text-emerald-500');
            btnExpense.classList.remove('bg-red-500', 'text-white');
            btnExpense.classList.add('text-red-500');
            btnTransfer.classList.remove('bg-blue-500', 'text-white');
            btnTransfer.classList.add('text-blue-500');
            
            if (type === 'income') {
                btnIncome.classList.add('bg-emerald-500', 'text-white');
                btnIncome.classList.remove('text-emerald-500');
                transferField.classList.add('hidden');
                categoryField.classList.remove('hidden');
            } else if (type === 'expense') {
                btnExpense.classList.add('bg-red-500', 'text-white');
                btnExpense.classList.remove('text-red-500');
                transferField.classList.add('hidden');
                categoryField.classList.remove('hidden');
            } else {
                btnTransfer.classList.add('bg-blue-500', 'text-white');
                btnTransfer.classList.remove('text-blue-500');
                transferField.classList.remove('hidden');
                categoryField.classList.add('hidden');
            }
            
            updateCategorySelect();
        }

        function updateCategorySelect() {
            const type = document.getElementById('transactionType').value;
            const select = document.getElementById('transactionCategory');
            
            if (type === 'transfer') {
                select.innerHTML = '<option value="Transfer">Transfer</option>';
            } else {
                select.innerHTML = data.categories[type].map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            }
        }

        function updateCategorySelects() {
            updateCategorySelect();
            updateAccountSelects();
            
            // Filter category select
            const filterCat = document.getElementById('filterCategory');
            filterCat.innerHTML = '<option value="all">Semua Kategori</option>';
            [...new Set([...data.categories.income, ...data.categories.expense])].forEach(cat => {
                filterCat.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Budget category select
            const budgetCat = document.getElementById('budgetCategory');
            budgetCat.innerHTML = data.categories.expense.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
        }

        function addTransaction(e) {
            e.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const accountId = document.getElementById('transactionAccount').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            
            const transaction = {
                id: document.getElementById('editTransactionId').value || generateId(),
                type: type,
                accountId: accountId,
                toAccountId: type === 'transfer' ? document.getElementById('transactionToAccount').value : null,
                amount: amount,
                category: type === 'transfer' ? 'Transfer' : document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDesc').value,
                date: document.getElementById('transactionDate').value,
                notes: document.getElementById('transactionNotes').value,
                createdAt: new Date().toISOString()
            };

            const editId = document.getElementById('editTransactionId').value;
            
            // Update account balances
            if (!editId) {
                const account = data.accounts.find(a => a.id === accountId);
                if (account) {
                    if (type === 'income') {
                        account.balance += amount;
                    } else if (type === 'expense') {
                        account.balance -= amount;
                    } else if (type === 'transfer') {
                        account.balance -= amount;
                        const toAccount = data.accounts.find(a => a.id === transaction.toAccountId);
                        if (toAccount) toAccount.balance += amount;
                    }
                }
            }

            if (editId) {
                const index = data.transactions.findIndex(t => t.id === editId);
                if (index !== -1) data.transactions[index] = transaction;
            } else {
                data.transactions.push(transaction);
            }

            saveData();
            updateDashboard();
            closeModal('addTransaction');
            showToast('Transaksi berhasil disimpan!');
        }

        function editTransaction(id) {
            const transaction = data.transactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('editTransactionId').value = id;
            setTransactionType(transaction.type);
            updateAccountSelects();
            document.getElementById('transactionAccount').value = transaction.accountId;
            if (transaction.toAccountId) {
                document.getElementById('transactionToAccount').value = transaction.toAccountId;
            }
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDesc').value = transaction.description;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionNotes').value = transaction.notes || '';
            
            openModal('addTransaction');
        }

        function deleteTransaction(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;
            
            const transaction = data.transactions.find(t => t.id === id);
            if (transaction) {
                // Reverse the balance change
                const account = data.accounts.find(a => a.id === transaction.accountId);
                if (account) {
                    if (transaction.type === 'income') {
                        account.balance -= transaction.amount;
                    } else if (transaction.type === 'expense') {
                        account.balance += transaction.amount;
                    } else if (transaction.type === 'transfer') {
                        account.balance += transaction.amount;
                        const toAccount = data.accounts.find(a => a.id === transaction.toAccountId);
                        if (toAccount) toAccount.balance -= transaction.amount;
                    }
                }
            }
            
            data.transactions = data.transactions.filter(t => t.id !== id);
            saveData();
            updateDashboard();
            updateTransactionsList();
            showToast('Transaksi berhasil dihapus!');
        }

        function updateTransactionsList() {
            const search = document.getElementById('searchTransaction').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const accountFilter = document.getElementById('filterAccount').value;
            const monthFilter = document.getElementById('filterMonth').value;

            let filtered = data.transactions.filter(t => {
                const matchSearch = t.description.toLowerCase().includes(search) || 
                                   t.category.toLowerCase().includes(search);
                const matchType = typeFilter === 'all' || t.type === typeFilter;
                const matchCategory = categoryFilter === 'all' || t.category === categoryFilter;
                const matchAccount = accountFilter === 'all' || t.accountId === accountFilter;
                const matchMonth = !monthFilter || t.date.startsWith(monthFilter);
                return matchSearch && matchType && matchCategory && matchAccount && matchMonth;
            });

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('transactionsList');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-slate-500">Tidak ada transaksi ditemukan</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(t => {
                const account = data.accounts.find(a => a.id === t.accountId);
                const accountName = account ? account.name : 'Unknown';
                const typeInfo = accountTypes[account?.type] || accountTypes.other;
                
                return `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-all">
                    <td class="py-3 px-4 text-slate-600">${formatDate(t.date)}</td>
                    <td class="py-3 px-4">
                        <p class="font-medium text-slate-800">${t.description}</p>
                        ${t.notes ? `<p class="text-xs text-slate-500">${t.notes}</p>` : ''}
                    </td>
                    <td class="py-3 px-4">
                        <span class="text-sm">${typeInfo.icon} ${accountName}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs">${t.category}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : t.type === 'expense' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} rounded-lg text-xs font-medium">
                            ${t.type === 'income' ? 'Pemasukan' : t.type === 'expense' ? 'Pengeluaran' : 'Transfer'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-right font-semibold ${t.type === 'income' ? 'text-emerald-600' : t.type === 'expense' ? 'text-red-500' : 'text-blue-600'}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="editTransaction('${t.id}')" class="p-2 text-slate-400 hover:text-indigo-600 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteTransaction('${t.id}')" class="p-2 text-slate-400 hover:text-red-600 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        // Dashboard Update
        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Total Wealth
            const totalWealth = data.accounts.reduce((sum, a) => sum + a.balance, 0);
            document.getElementById('totalWealth').textContent = formatCurrency(totalWealth);
            document.getElementById('wealthBreakdown').textContent = `${data.accounts.length} Akun Aktif`;

            const monthlyTransactions = data.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const totalIncome = monthlyTransactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = monthlyTransactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('currentBalance').textContent = formatCurrency(balance);

            // Savings progress
            const savingsTarget = data.settings.savingsTarget || 0;
            const savingsProgress = savingsTarget > 0 ? Math.min(100, (totalWealth / savingsTarget) * 100) : 0;
            document.getElementById('savingsProgress').textContent = `${savingsProgress.toFixed(0)}%`;

            // Quick stats
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const avgDaily = totalExpense / daysInMonth;
            document.getElementById('avgDailyExpense').textContent = formatCurrency(avgDaily);
            document.getElementById('monthlyTransCount').textContent = monthlyTransactions.length;

            // Top category
            const categoryTotals = {};
            monthlyTransactions.filter(t => t.type === 'expense').forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';

            // Savings ratio
            const savingsRatio = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome * 100) : 0;
            document.getElementById('savingsRatio').textContent = `${savingsRatio.toFixed(1)}%`;

            // Update account summary
            updateAccountSummary();
            updateRecentTransactions();
            updateCharts();
        }

        function updateRecentTransactions() {
            const recent = [...data.transactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recentTransactions');
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-8">Belum ada transaksi</p>';
                return;
            }

            container.innerHTML = recent.map(t => {
                const account = data.accounts.find(a => a.id === t.accountId);
                const typeInfo = accountTypes[account?.type] || accountTypes.other;
                
                return `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${t.type === 'income' ? 'bg-emerald-100' : t.type === 'expense' ? 'bg-red-100' : 'bg-blue-100'} flex items-center justify-center">
                            <svg class="w-5 h-5 ${t.type === 'income' ? 'text-emerald-600' : t.type === 'expense' ? 'text-red-500' : 'text-blue-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${t.type === 'income' ? 'M7 11l5-5m0 0l5 5m-5-5v12' : t.type === 'expense' ? 'M17 13l-5 5m0 0l-5-5m5 5V6' : 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4'}"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-slate-800">${t.description}</p>
                            <p class="text-xs text-slate-500">${t.category} â€¢ ${account ? typeInfo.icon + ' ' + account.name : ''} â€¢ ${formatDate(t.date)}</p>
                        </div>
                    </div>
                    <p class="font-semibold ${t.type === 'income' ? 'text-emerald-600' : t.type === 'expense' ? 'text-red-500' : 'text-blue-600'}">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </p>
                </div>
            `}).join('');
        }

        // Charts
        function initializeCharts() {
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pemasukan',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Pengeluaran',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
                            '#ec4899', '#f43f5e', '#f97316', '#eab308'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            const compareCtx = document.getElementById('monthlyCompareChart').getContext('2d');
            monthlyCompareChart = new Chart(compareCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pemasukan',
                        data: [],
                        backgroundColor: '#10b981'
                    }, {
                        label: 'Pengeluaran',
                        data: [],
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateCharts() {
            // Trend chart - last 6 months
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const month = d.getMonth();
                const year = d.getFullYear();
                
                months.push(d.toLocaleDateString('id-ID', { month: 'short' }));
                
                const monthTrans = data.transactions.filter(t => {
                    const td = new Date(t.date);
                    return td.getMonth() === month && td.getFullYear() === year;
                });
                
                incomeData.push(monthTrans.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0));
                expenseData.push(monthTrans.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0));
            }

            trendChart.data.labels = months;
            trendChart.data.datasets[0].data = incomeData;
            trendChart.data.datasets[1].data = expenseData;
            trendChart.update();

            // Category chart - current month
            const now = new Date();
            const currentMonthTrans = data.transactions.filter(t => {
                const td = new Date(t.date);
                return td.getMonth() === now.getMonth() && td.getFullYear() === now.getFullYear() && t.type === 'expense';
            });

            const categoryTotals = {};
            currentMonthTrans.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });

            categoryChart.data.labels = Object.keys(categoryTotals);
            categoryChart.data.datasets[0].data = Object.values(categoryTotals);
            categoryChart.update();

            // Monthly compare chart
            monthlyCompareChart.data.labels = months;
            monthlyCompareChart.data.datasets[0].data = incomeData;
            monthlyCompareChart.data.datasets[1].data = expenseData;
            monthlyCompareChart.update();
        }

        // Budget Functions
        function addBudget(e) {
            e.preventDefault();
            
            const budget = {
                id: generateId(),
                category: document.getElementById('budgetCategory').value,
                amount: parseFloat(document.getElementById('budgetAmount').value)
            };

            const existing = data.budgets.findIndex(b => b.category === budget.category);
            if (existing !== -1) {
                data.budgets[existing] = budget;
            } else {
                data.budgets.push(budget);
            }

            saveData();
            updateBudgetUI();
            closeModal('addBudget');
            showToast('Anggaran berhasil disimpan!');
        }

        function deleteBudget(id) {
            data.budgets = data.budgets.filter(b => b.id !== id);
            saveData();
            updateBudgetUI();
            showToast('Anggaran berhasil dihapus!');
        }

        function updateBudgetUI() {
            const now = new Date();
            const container = document.getElementById('budgetList');
            
            if (data.budgets.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-8">Belum ada anggaran</p>';
                return;
            }

            container.innerHTML = data.budgets.map(b => {
                const spent = data.transactions.filter(t => {
                    const td = new Date(t.date);
                    return t.type === 'expense' && 
                           t.category === b.category && 
                           td.getMonth() === now.getMonth() && 
                           td.getFullYear() === now.getFullYear();
                }).reduce((s, t) => s + t.amount, 0);
                
                const percentage = Math.min(100, (spent / b.amount) * 100);
                const isOver = spent > b.amount;

                return `
                    <div class="p-4 border border-slate-100 rounded-xl">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-slate-800">${b.category}</span>
                            <button onclick="deleteBudget('${b.id}')" class="text-slate-400 hover:text-red-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="${isOver ? 'text-red-500' : 'text-slate-600'}">${formatCurrency(spent)} / ${formatCurrency(b.amount)}</span>
                            <span class="${isOver ? 'text-red-500 font-medium' : 'text-slate-500'}">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full ${isOver ? 'bg-red-500' : percentage > 80 ? 'bg-amber-500' : 'bg-emerald-500'} rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update savings
            const savingsTarget = data.settings.savingsTarget || 0;
            const totalWealth = data.accounts.reduce((sum, a) => sum + a.balance, 0);
            const savingsPercentage = savingsTarget > 0 ? Math.min(100, (totalWealth / savingsTarget) * 100) : 0;

            document.getElementById('savingsTarget').textContent = formatCurrency(savingsTarget);
            document.getElementById('savingsCollected').textContent = formatCurrency(totalWealth);
            document.getElementById('savingsRemaining').textContent = formatCurrency(Math.max(0, savingsTarget - totalWealth));
            document.getElementById('savingsPercentage').textContent = `${savingsPercentage.toFixed(0)}%`;
        }

        function setSavingsTarget(e) {
            e.preventDefault();
            data.settings.savingsTarget = parseFloat(document.getElementById('savingsTargetInput').value);
            saveData();
            updateBudgetUI();
            updateDashboard();
            closeModal('setSavingsTarget');
            showToast('Target tabungan berhasil disimpan!');
        }

        // Reports
        function updateReports() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const monthlyTrans = data.transactions.filter(t => {
                const td = new Date(t.date);
                return td.getMonth() === currentMonth && td.getFullYear() === currentYear;
            });

            const income = monthlyTrans.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = monthlyTrans.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const diff = income - expense;

            document.getElementById('reportIncome').textContent = formatCurrency(income);
            document.getElementById('reportExpense').textContent = formatCurrency(expense);
            document.getElementById('reportDiff').textContent = formatCurrency(diff);
            document.getElementById('reportDiff').className = `font-bold ${diff >= 0 ? 'text-emerald-600' : 'text-red-500'}`;

            // Category report
            updateCategoryReport();
            
            // Month selector
            const select = document.getElementById('reportMonth');
            const months = [...new Set(data.transactions.map(t => t.date.substring(0, 7)))].sort().reverse();
            select.innerHTML = months.map(m => {
                const [y, mo] = m.split('-');
                const date = new Date(y, mo - 1);
                return `<option value="${m}">${date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}</option>`;
            }).join('') || '<option>Tidak ada data</option>';
        }

        function updateCategoryReport() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;

            const monthTrans = data.transactions.filter(t => t.date.startsWith(month) && t.type === 'expense');
            const total = monthTrans.reduce((s, t) => s + t.amount, 0);

            const categoryTotals = {};
            monthTrans.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });

            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

            document.getElementById('categoryReportList').innerHTML = sorted.map(([cat, amount]) => {
                const percentage = total > 0 ? (amount / total * 100) : 0;
                return `
                    <tr class="border-b border-slate-50">
                        <td class="py-3 px-4 font-medium text-slate-800">${cat}</td>
                        <td class="py-3 px-4 text-right text-slate-600">${formatCurrency(amount)}</td>
                        <td class="py-3 px-4 text-right text-slate-600">${percentage.toFixed(1)}%</td>
                        <td class="py-3 px-4">
                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" class="text-center py-8 text-slate-500">Tidak ada data</td></tr>';
        }

        // Category Management
        function addCategory() {
            const name = document.getElementById('newCategory').value.trim();
            const type = document.getElementById('newCategoryType').value;
            
            if (!name) {
                showToast('Nama kategori tidak boleh kosong!');
                return;
            }

            if (data.categories[type].includes(name)) {
                showToast('Kategori sudah ada!');
                return;
            }

            data.categories[type].push(name);
            saveData();
            updateCategoriesUI();
            updateCategorySelects();
            document.getElementById('newCategory').value = '';
            showToast('Kategori berhasil ditambahkan!');
        }

        function deleteCategory(name, type) {
            if (data.categories[type].length <= 1) {
                showToast('Minimal harus ada satu kategori!');
                return;
            }

            data.categories[type] = data.categories[type].filter(c => c !== name);
            saveData();
            updateCategoriesUI();
            updateCategorySelects();
            showToast('Kategori berhasil dihapus!');
        }

        function updateCategoriesUI() {
            document.getElementById('expenseCategoriesList').innerHTML = data.categories.expense.map(cat => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                    <span class="text-sm text-slate-700">${cat}</span>
                    <button onclick="deleteCategory('${cat}', 'expense')" class="text-slate-400 hover:text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');

            document.getElementById('incomeCategoriesList').innerHTML = data.categories.income.map(cat => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                    <span class="text-sm text-slate-700">${cat}</span>
                    <button onclick="deleteCategory('${cat}', 'income')" class="text-slate-400 hover:text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Settings
        function loadSettings() {
            document.getElementById('currency').value = data.settings.currency || 'IDR';
            document.getElementById('savingsTargetInput').value = data.settings.savingsTarget || '';
        }

        function saveSettings() {
            data.settings.currency = document.getElementById('currency').value;
            saveData();
            updateDashboard();
            showToast('Pengaturan berhasil disimpan!');
        }

        // Export/Import
        function exportData(format) {
            let content, filename, type;
            
            if (format === 'csv') {
                const headers = ['Tanggal', 'Tipe', 'Akun', 'Kategori', 'Deskripsi', 'Jumlah', 'Catatan'];
                const rows = data.transactions.map(t => {
                    const account = data.accounts.find(a => a.id === t.accountId);
                    return [t.date, t.type, account?.name || '', t.category, t.description, t.amount, t.notes || ''];
                });
                content = [headers, ...rows].map(r => r.join(',')).join('\n');
                filename = 'keuangan.csv';
                type = 'text/csv';
            } else {
                content = JSON.stringify(data, null, 2);
                filename = 'keuangan.json';
                type = 'application/json';
            }

            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Data berhasil diekspor ke ${filename}!`);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    data = { ...data, ...imported };
                    saveData();
                    updateDashboard();
                    updateCategorySelects();
                    updateCategoriesUI();
                    showToast('Data berhasil diimpor!');
                } catch (error) {
                    showToast('Format file tidak valid!');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('PERINGATAN: Semua data akan dihapus permanen. Lanjutkan?')) return;
            
            data = {
                accounts: [],
                transactions: [],
                budgets: [],
                categories: {
                    income: ['Gaji', 'Freelance', 'Investasi', 'Bonus', 'Lainnya'],
                    expense: ['Makanan', 'Transportasi', 'Belanja', 'Tagihan', 'Hiburan', 'Kesehatan', 'Pendidikan', 'Lainnya']
                },
                settings: {
                    currency: 'IDR',
                    savingsTarget: 0
                },
                supabase: data.supabase // Keep supabase settings
            };
            saveData();
            updateDashboard();
            updateCategorySelects();
            updateCategoriesUI();
            showToast('Semua data telah dihapus!');
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
            document.getElementById('accountForm').addEventListener('submit', addAccount);
            document.getElementById('budgetForm').addEventListener('submit', addBudget);
            document.getElementById('savingsForm').addEventListener('submit', setSavingsTarget);
            
            document.getElementById('searchTransaction').addEventListener('input', updateTransactionsList);
            document.getElementById('filterType').addEventListener('change', updateTransactionsList);
            document.getElementById('filterCategory').addEventListener('change', updateTransactionsList);
            document.getElementById('filterAccount').addEventListener('change', updateTransactionsList);
            document.getElementById('filterMonth').addEventListener('change', updateTransactionsList);
            document.getElementById('reportMonth').addEventListener('change', updateCategoryReport);

            // Close modal on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        }
    </script>
</body>
</html>

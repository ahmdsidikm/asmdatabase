<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Supabase Storage Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23E2E8F0FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%236366F1FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            background-color: #F5F3FF;
            transform: scale(1.01);
        }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        .gallery-img:hover { transform: scale(1.05); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

    <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-10">
        
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 mb-8 fade-in">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200 text-white shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Supabase Storage</h1>
                    <p class="text-sm text-slate-500 font-medium">Image Manager</p>
                </div>
            </div>
            
            <button onclick="openSettings()" class="group flex items-center gap-2.5 px-5 py-2.5 bg-white hover:bg-slate-50 border border-slate-200 rounded-xl shadow-sm hover:shadow transition-all w-full sm:w-auto justify-center sm:justify-start cursor-pointer">
                <div class="w-2 h-2 rounded-full bg-slate-300" id="connectionStatusDot"></div>
                <span class="text-sm font-semibold text-slate-600 group-hover:text-slate-900">Settings</span>
                <svg class="w-4 h-4 text-slate-400 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
        </div>

        <div class="grid lg:grid-cols-12 gap-6 sm:gap-8">
            <!-- Left Column: Upload -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Upload Card -->
                <div class="bg-white rounded-3xl p-6 shadow-xl shadow-slate-200/60 border border-slate-100 fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                            Upload
                        </h2>
                    </div>

                    <div id="dropZone" class="drop-zone rounded-3xl p-8 text-center cursor-pointer mb-6 relative group overflow-hidden">
                        <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                        <div class="relative z-10 transition-transform duration-300 group-hover:-translate-y-1">
                            <div class="w-14 h-14 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform duration-300 group-hover:shadow-lg group-hover:shadow-indigo-100">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            </div>
                            <p class="text-slate-700 font-semibold text-sm">Tap or Drag images</p>
                            <p class="text-slate-400 text-xs mt-1">Supports JPG, PNG, WEBP</p>
                        </div>
                    </div>

                    <div id="previewArea" class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar mb-4 hidden"></div>

                    <button onclick="uploadFiles()" id="btnUpload" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 hidden cursor-pointer">
                        <span>Upload Now</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
                    </button>
                </div>
                
                <!-- Recent Uploads -->
                <div id="uploadedSection" class="bg-white rounded-3xl p-6 shadow-xl shadow-slate-200/60 border border-slate-100 hidden fade-in">
                     <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Successfully Uploaded</h3>
                     <div id="uploadedList" class="space-y-3"></div>
                </div>
            </div>

            <!-- Right Column: Gallery -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-3xl p-6 shadow-xl shadow-slate-200/60 border border-slate-100 fade-in h-full flex flex-col min-h-[500px]">
                    <!-- Gallery Header -->
                    <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center mb-6">
                        <div class="flex items-center gap-3">
                            <h2 class="text-lg font-bold text-slate-800">Gallery</h2>
                            <span id="galleryCount" class="hidden px-2 py-0.5 bg-indigo-50 text-indigo-600 text-xs font-bold rounded-md">0</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                            <div class="relative flex-1 md:w-48 min-w-[140px]">
                                <input type="text" id="gallerySearch" placeholder="Search files..." oninput="filterGallery()" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
                                <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <div class="flex bg-slate-100 p-1 rounded-xl shrink-0">
                                <button onclick="setGalleryView('grid')" id="viewGridBtn" class="p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 transition-colors active bg-white shadow-sm cursor-pointer"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg></button>
                                <button onclick="setGalleryView('list')" id="viewListBtn" class="p-1.5 rounded-lg text-slate-500 hover:text-indigo-600 transition-colors cursor-pointer"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg></button>
                            </div>
                             <button onclick="loadGallery()" id="btnRefreshGallery" class="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl transition-colors shrink-0 cursor-pointer"><svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                        </div>
                    </div>

                    <!-- States -->
                    <div id="gallerySkeleton" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                         <div class="aspect-square bg-slate-100 rounded-2xl animate-pulse"></div>
                         <div class="aspect-square bg-slate-100 rounded-2xl animate-pulse"></div>
                         <div class="aspect-square bg-slate-100 rounded-2xl animate-pulse"></div>
                         <div class="aspect-square bg-slate-100 rounded-2xl animate-pulse"></div>
                    </div>

                    <div id="galleryEmpty" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                        <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                        <p class="text-slate-500 font-medium">No images found</p>
                        <button onclick="loadGallery()" class="text-indigo-600 text-sm font-semibold hover:underline mt-2 cursor-pointer">Refresh Gallery</button>
                    </div>
                    
                    <div id="galleryGrid" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 content-start"></div>
                    <div id="galleryList" class="hidden space-y-2"></div>
                    
                    <!-- Pagination -->
                    <div id="galleryPagination" class="hidden mt-auto pt-6 flex items-center justify-between border-t border-slate-100">
                        <span id="galleryInfo" class="text-xs text-slate-400 font-medium"></span>
                        <div class="flex gap-2">
                            <button onclick="galleryPrevPage()" id="btnPrev" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer">←</button>
                            <button onclick="galleryNextPage()" id="btnNext" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer">→</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" onclick="if(event.target===this) closeSettings()">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 transition-transform duration-300" id="settingsContent">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-lg font-bold text-slate-800">Supabase Configuration</h2>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600 transition-colors cursor-pointer">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Project URL</label>
                    <input type="url" id="supabaseUrl" placeholder="https://xxx.supabase.co" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all font-mono text-sm text-slate-700">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Anon / Service Key</label>
                    <input type="password" id="supabaseKey" placeholder="eyJ..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all font-mono text-sm text-slate-700">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Bucket Name</label>
                    <input type="text" id="bucketName" value="images" placeholder="images" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all text-sm text-slate-700">
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                <button onclick="testConnection()" id="btnTest" class="px-4 py-2 text-slate-600 hover:text-indigo-600 font-medium text-sm flex items-center gap-2 transition-colors cursor-pointer">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Test Connection
                </button>
                <button onclick="closeSettings()" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 cursor-pointer">
                    Save Config
                </button>
            </div>
        </div>
    </div>

    <!-- QR MODAL -->
    <div id="qrModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300" onclick="if(event.target===this) closeQrModal()">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full flex flex-col items-center transform scale-95 transition-transform duration-300" id="qrContent">
            <h3 class="text-lg font-bold text-slate-800 mb-6">Scan QR Code</h3>
            <div id="qrCodeContainer" class="p-4 bg-white rounded-2xl shadow-inner border border-slate-100 mb-6"></div>
            <p id="qrUrlText" class="text-xs text-slate-400 text-center break-all mb-6 font-mono bg-slate-50 p-2 rounded-lg w-full"></p>
            <button onclick="closeQrModal()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition-colors cursor-pointer">
                Close
            </button>
        </div>
    </div>

    <script>
        // Constants & Config
        const DEFAULT_SUPABASE_URL = "https://sdpkszleuubddfovgkfy.supabase.co/";
        const DEFAULT_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcGtzemxldXViZGRmb3Zna2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDU5OTMsImV4cCI6MjA4NTk4MTk5M30.Ir5ftpwkYLGI6r516cxhN0xac2cQNb38200jKOTDKv0";
        const DEFAULT_BUCKET = "images";
        
        let supabaseClient = null;
        let selectedFiles = [];
        let galleryFiles = [];
        let galleryFiltered = [];
        let galleryView = 'grid';
        let galleryPage = 0;
        const GALLERY_PER_PAGE = 20;

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            // Load saved or default config
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            const savedBucket = localStorage.getItem('bucketName');

            if (!savedUrl && !savedKey) {
                // Apply defaults if fresh
                document.getElementById('supabaseUrl').value = DEFAULT_SUPABASE_URL;
                document.getElementById('supabaseKey').value = DEFAULT_SUPABASE_KEY;
                localStorage.setItem('supabaseUrl', DEFAULT_SUPABASE_URL);
                localStorage.setItem('supabaseKey', DEFAULT_SUPABASE_KEY);
            } else {
                if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
                if (savedKey) document.getElementById('supabaseKey').value = savedKey;
            }
            
            if (savedBucket) document.getElementById('bucketName').value = savedBucket;
            else document.getElementById('bucketName').value = DEFAULT_BUCKET;

            initSupabase();
        });

        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (url && key) {
                supabaseClient = window.supabase.createClient(url, key);
                checkConnection(false); // Silent check
                loadGallery();
            } else {
                updateConnectionStatus('error');
            }
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('connectionStatusDot');
            if (status === 'success') {
                dot.classList.remove('bg-slate-300', 'bg-red-500');
                dot.classList.add('bg-green-500', 'animate-pulse');
            } else if (status === 'error') {
                dot.classList.remove('bg-slate-300', 'bg-green-500', 'animate-pulse');
                dot.classList.add('bg-red-500');
            } else {
                dot.classList.remove('bg-green-500', 'bg-red-500', 'animate-pulse');
                dot.classList.add('bg-slate-300');
            }
        }

        // --- Settings Modal ---
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            modal.classList.remove('hidden');
            // Allow display:none to unapply before animating opacity
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            // Save settings
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const bucket = document.getElementById('bucketName').value.trim();
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            localStorage.setItem('bucketName', bucket);

            // Re-init if changed
            if (supabaseClient?.supabaseUrl !== url || supabaseClient?.supabaseKey !== key) {
                initSupabase();
            }

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function testConnection() {
            const btn = document.getElementById('btnTest');
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const bucket = document.getElementById('bucketName').value.trim();

            if (!url || !key) return showToast('URL and Key required', 'error');

            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spin w-4 h-4 border-2 border-slate-400 border-t-indigo-600 rounded-full inline-block"></span> Testing...';
            btn.disabled = true;

            try {
                const tempClient = window.supabase.createClient(url, key);
                const { data, error } = await tempClient.storage.getBucket(bucket);
                
                if (error && error.message && !error.message.includes('not found')) {
                    throw error;
                }
                // Note: getBucket usually fails for anon unless specific policies, but list buckets might work
                // Alternative: Try to list files in bucket
                const { error: listError } = await tempClient.storage.from(bucket).list('', { limit: 1 });
                
                if (listError && listError.statusCode !== 404) {
                     // If bucket doesn't exist, we might get an error, but connection is technically OK if not 401
                     if(listError.message.includes('violates row-level security')) {
                         showToast('Connected! (RLS restricted)', 'success');
                     } else {
                         throw listError;
                     }
                }
                
                showToast('Connection Successful!', 'success');
                updateConnectionStatus('success');
            } catch (err) {
                console.error(err);
                showToast('Connection Failed', 'error');
                updateConnectionStatus('error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function checkConnection(notify = true) {
            if (!supabaseClient) return;
            const bucket = document.getElementById('bucketName').value.trim();
            try {
                const { error } = await supabaseClient.storage.from(bucket).list('', { limit: 1 });
                if (!error) {
                    updateConnectionStatus('success');
                    if (notify) showToast('Connected to Supabase', 'success');
                } else {
                    updateConnectionStatus('error');
                }
            } catch(e) { updateConnectionStatus('error'); }
        }

        // --- Upload Logic ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = '';
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    if (file.size > 10 * 1024 * 1024) showToast(`${file.name} too large (>10MB)`, 'error');
                    else selectedFiles.push(file);
                }
            });
            renderPreviews();
        }

        function renderPreviews() {
            const area = document.getElementById('previewArea');
            const btn = document.getElementById('btnUpload');
            
            if (selectedFiles.length === 0) {
                area.classList.add('hidden');
                btn.classList.add('hidden');
                return;
            }

            area.classList.remove('hidden');
            btn.classList.remove('hidden');
            btn.querySelector('span').textContent = `Upload ${selectedFiles.length} File${selectedFiles.length>1?'s':''}`;

            area.innerHTML = selectedFiles.map((file, i) => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 fade-in relative group" id="preview-${i}">
                    <img src="${URL.createObjectURL(file)}" class="w-10 h-10 object-cover rounded-lg border border-slate-200">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-700 truncate">${file.name}</p>
                        <p class="text-xs text-slate-400">${(file.size/1024).toFixed(1)} KB</p>
                        <div class="h-1 bg-slate-200 mt-2 rounded-full overflow-hidden hidden" id="progress-${i}">
                            <div class="h-full bg-indigo-500 w-0 transition-all duration-300" id="bar-${i}"></div>
                        </div>
                    </div>
                    <button onclick="removeFile(${i})" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors cursor-pointer">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(i) {
            selectedFiles.splice(i, 1);
            renderPreviews();
        }

        async function uploadFiles() {
            if (!supabaseClient) {
                showToast('Please configure Supabase first', 'error');
                openSettings();
                return;
            }
            
            const bucket = document.getElementById('bucketName').value.trim();
            const btn = document.getElementById('btnUpload');
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Uploading...';

            let success = 0;
            const uploadedSection = document.getElementById('uploadedSection');
            const uploadedList = document.getElementById('uploadedList');

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                document.getElementById(`progress-${i}`).classList.remove('hidden');
                const bar = document.getElementById(`bar-${i}`);
                
                // Mock progress
                let p = 10;
                bar.style.width = '10%';
                const interval = setInterval(() => { p+=Math.random()*20; if(p>90) p=90; bar.style.width=p+'%'; }, 200);

                try {
                    const ext = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${ext}`;
                    
                    const { error } = await supabaseClient.storage.from(bucket).upload(fileName, file);
                    clearInterval(interval);
                    
                    if (error) throw error;
                    
                    bar.style.width = '100%';
                    bar.classList.add('bg-green-500');
                    
                    // Add to success list
                    const { data: { publicUrl } } = supabaseClient.storage.from(bucket).getPublicUrl(fileName);
                    uploadedSection.classList.remove('hidden');
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-3 bg-green-50/50 border border-green-100 rounded-xl fade-in';
                    div.innerHTML = `
                         <img src="${publicUrl}" class="w-10 h-10 object-cover rounded-lg border border-green-200">
                         <div class="flex-1 min-w-0">
                             <p class="text-xs font-medium text-green-800 truncate">${file.name}</p>
                             <div class="flex gap-2 mt-1">
                                 <button onclick="copyToClipboard('${publicUrl}')" class="text-[10px] font-bold text-indigo-600 hover:underline uppercase cursor-pointer">Copy URL</button>
                                 <button onclick="showQr('${publicUrl}', '${fileName}')" class="text-[10px] font-bold text-indigo-600 hover:underline uppercase cursor-pointer">QR</button>
                             </div>
                         </div>
                    `;
                    uploadedList.prepend(div);
                    success++;

                } catch (err) {
                    clearInterval(interval);
                    bar.classList.add('bg-red-500');
                    showToast(`Failed: ${file.name}`, 'error');
                }
            }

            if (success > 0) {
                showToast(`Uploaded ${success} files!`, 'success');
                selectedFiles = [];
                setTimeout(renderPreviews, 1000);
                setTimeout(loadGallery, 1500);
            }
            
            btn.disabled = false;
            btn.querySelector('span').textContent = 'Upload Now';
        }

        // --- Gallery Logic ---
        async function loadGallery() {
            if (!supabaseClient) return;
            const bucket = document.getElementById('bucketName').value.trim();
            const btn = document.getElementById('btnRefreshGallery');
            const icon = document.getElementById('refreshIcon');
            
            icon.classList.add('spin');
            btn.disabled = true;
            
            // UI States
            document.getElementById('galleryEmpty').classList.add('hidden');
            document.getElementById('galleryGrid').classList.add('hidden');
            document.getElementById('galleryList').classList.add('hidden');
            document.getElementById('galleryPagination').classList.add('hidden');
            document.getElementById('gallerySkeleton').classList.remove('hidden');

            try {
                const { data, error } = await supabaseClient.storage.from(bucket).list('', {
                    limit: 1000,
                    sortBy: { column: 'created_at', order: 'desc' }
                });

                if (error) throw error;

                galleryFiles = data.filter(f => f.name !== '.emptyFolderPlaceholder');
                galleryFiltered = [...galleryFiles];
                galleryPage = 0;
                
                document.getElementById('galleryCount').textContent = galleryFiles.length;
                document.getElementById('galleryCount').classList.remove('hidden');

                if (galleryFiles.length === 0) {
                    document.getElementById('galleryEmpty').classList.remove('hidden');
                } else {
                    renderGallery();
                }
            } catch (err) {
                showToast('Failed to load gallery', 'error');
                document.getElementById('galleryEmpty').classList.remove('hidden');
            } finally {
                icon.classList.remove('spin');
                btn.disabled = false;
                document.getElementById('gallerySkeleton').classList.add('hidden');
            }
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            const list = document.getElementById('galleryList');
            const pagination = document.getElementById('galleryPagination');
            
            // Filter logic
            const start = galleryPage * GALLERY_PER_PAGE;
            const end = start + GALLERY_PER_PAGE;
            const pageFiles = galleryFiltered.slice(start, end);
            const bucket = document.getElementById('bucketName').value.trim();

            if (galleryFiltered.length === 0) {
                document.getElementById('galleryEmpty').classList.remove('hidden');
                grid.classList.add('hidden');
                list.classList.add('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            document.getElementById('galleryEmpty').classList.add('hidden');

            if (galleryFiltered.length > GALLERY_PER_PAGE) {
                pagination.classList.remove('hidden');
                document.getElementById('galleryInfo').textContent = `${start+1}-${Math.min(end, galleryFiltered.length)} of ${galleryFiltered.length}`;
                document.getElementById('btnPrev').disabled = galleryPage === 0;
                document.getElementById('btnNext').disabled = end >= galleryFiltered.length;
            } else {
                pagination.classList.add('hidden');
            }

            const getUrl = (name) => supabaseClient.storage.from(bucket).getPublicUrl(name).data.publicUrl;

            if (galleryView === 'grid') {
                list.classList.add('hidden');
                grid.classList.remove('hidden');
                grid.innerHTML = pageFiles.map((file, i) => `
                    <div class="group relative rounded-xl overflow-hidden bg-slate-100 border border-slate-200 aspect-square fade-in" style="animation-delay: ${i*50}ms">
                        <img src="${getUrl(file.name)}" loading="lazy" class="w-full h-full object-cover gallery-img transition-transform duration-500 cursor-pointer" onclick="openLightbox('${getUrl(file.name)}', '${file.name}')">
                        <div class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-between">
                            <div class="min-w-0 flex-1 mr-2">
                                <p class="text-white text-xs font-medium truncate">${file.name}</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="copyToClipboard('${getUrl(file.name)}')" class="p-1.5 bg-white/20 backdrop-blur-md hover:bg-white text-white hover:text-indigo-600 rounded-lg transition-colors cursor-pointer"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg></button>
                                <button onclick="deleteFile('${file.name}')" class="p-1.5 bg-red-500/80 backdrop-blur-md hover:bg-red-500 text-white rounded-lg transition-colors cursor-pointer"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.classList.add('hidden');
                list.classList.remove('hidden');
                list.innerHTML = pageFiles.map((file, i) => `
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-slate-50 border border-slate-200 hover:bg-white hover:shadow-md transition-all fade-in" style="animation-delay: ${i*50}ms">
                         <img src="${getUrl(file.name)}" loading="lazy" class="w-12 h-12 object-cover rounded-lg bg-slate-200 shrink-0 cursor-pointer" onclick="openLightbox('${getUrl(file.name)}', '${file.name}')">
                         <div class="flex-1 min-w-0">
                             <p class="text-sm font-medium text-slate-700 truncate">${file.name}</p>
                             <p class="text-xs text-slate-400 mt-0.5">${new Date(file.created_at).toLocaleDateString()} • ${(file.metadata?.size/1024).toFixed(1)} KB</p>
                         </div>
                         <div class="flex items-center gap-2">
                             <button onclick="copyToClipboard('${getUrl(file.name)}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors cursor-pointer" title="Copy URL"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg></button>
                             <button onclick="showQr('${getUrl(file.name)}', '${file.name}')" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors cursor-pointer" title="QR Code"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM6 18h2v4H6v-4zM4 6h4v4H4V6zm12 0h4v4h-4V6zM4 18h4v4H4v-4zM6 6h1v1H6V6zm13 0h1v1h-1V6zM6 18h1v1H6v-1z"/></svg></button>
                             <button onclick="deleteFile('${file.name}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors cursor-pointer" title="Delete"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                         </div>
                    </div>
                `).join('');
            }
        }

        function filterGallery() {
            const term = document.getElementById('gallerySearch').value.toLowerCase();
            galleryFiltered = galleryFiles.filter(f => f.name.toLowerCase().includes(term));
            galleryPage = 0;
            renderGallery();
        }

        function galleryPrevPage() { if(galleryPage>0) { galleryPage--; renderGallery(); } }
        function galleryNextPage() { 
            if((galleryPage+1)*GALLERY_PER_PAGE < galleryFiltered.length) { galleryPage++; renderGallery(); } 
        }

        async function deleteFile(fileName) {
            if(!confirm(`Are you sure you want to delete ${fileName}?`)) return;
            
            const bucket = document.getElementById('bucketName').value.trim();
            const { error } = await supabaseClient.storage.from(bucket).remove([fileName]);
            
            if(error) showToast('Delete failed', 'error');
            else {
                showToast('Deleted successfully', 'success');
                galleryFiles = galleryFiles.filter(f => f.name !== fileName);
                galleryFiltered = galleryFiltered.filter(f => f.name !== fileName);
                renderGallery();
                document.getElementById('galleryCount').textContent = galleryFiles.length;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!', 'success');
        }

        function setGalleryView(view) {
            galleryView = view;
            document.getElementById('viewGridBtn').classList.toggle('bg-white', view==='grid');
            document.getElementById('viewGridBtn').classList.toggle('shadow-sm', view==='grid');
            document.getElementById('viewGridBtn').classList.toggle('text-indigo-600', view==='grid');
            
            document.getElementById('viewListBtn').classList.toggle('bg-white', view==='list');
            document.getElementById('viewListBtn').classList.toggle('shadow-sm', view==='list');
            document.getElementById('viewListBtn').classList.toggle('text-indigo-600', view==='list');
            
            renderGallery();
        }

        // --- Utils ---
        function showToast(msg, type='info') {
            const container = document.getElementById('toastContainer');
            const div = document.createElement('div');
            const color = type==='success'?'bg-green-500':type==='error'?'bg-red-500':'bg-indigo-600';
            div.className = `${color} text-white px-4 py-3 rounded-xl shadow-lg shadow-gray-300/50 flex items-center gap-3 text-sm font-medium fade-in backdrop-blur-sm`;
            div.innerHTML = `<span>${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateY(-10px)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function showQr(url, name) {
            const modal = document.getElementById('qrModal');
            const content = document.getElementById('qrContent');
            const container = document.getElementById('qrCodeContainer');
            document.getElementById('qrUrlText').textContent = url;
            
            container.innerHTML = '';
            new QRCode(container, { text: url, width: 200, height: 200 });
            
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function closeQrModal() {
            const modal = document.getElementById('qrModal');
            const content = document.getElementById('qrContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function openLightbox(url, name) {
            const div = document.createElement('div');
            div.className = 'fixed inset-0 bg-black/95 z-[60] flex flex-col p-4 fade-in';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4 text-white">
                    <h3 class="font-medium truncate pr-4">${name}</h3>
                    <button onclick="this.parentElement.parentElement.remove()" class="p-2 hover:bg-white/10 rounded-full transition-colors cursor-pointer">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="flex-1 flex items-center justify-center overflow-hidden">
                    <img src="${url}" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
                </div>
            `;
            document.body.appendChild(div);
        }
    </script>
</body>
</html>

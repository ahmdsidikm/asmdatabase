<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediaScan</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:#f5f5f7;color:#1a1a1a;height:100vh;overflow:hidden;user-select:none}
        .app{display:flex;flex-direction:column;height:100vh;align-items:center;justify-content:center}
        #vid{position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none}
        .main{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;flex:1}

        .icon-wrap{width:120px;height:120px;border-radius:50%;background:#fff;border:2px solid #e8e8ed;display:flex;align-items:center;justify-content:center;margin-bottom:28px;position:relative;transition:border-color .3s;box-shadow:0 4px 20px rgba(0,0,0,.04)}
        .icon-wrap::after{content:'';position:absolute;inset:-8px;border-radius:50%;border:1px solid rgba(102,126,234,.1);animation:pulse 3s ease-in-out infinite}
        .icon-wrap.step1{border-color:rgba(102,126,234,.4)}
        .icon-wrap.step2{border-color:rgba(74,222,128,.4)}
        @keyframes pulse{0%,100%{transform:scale(1);opacity:.5}50%{transform:scale(1.08);opacity:1}}
        .hand-icon{font-size:52px;transition:transform .3s}

        .title{font-size:22px;font-weight:700;margin-bottom:8px;color:#1a1a1a}
        .desc{font-size:13px;color:#888;line-height:1.6;margin-bottom:24px;max-width:280px}

        .steps{display:flex;gap:12px;margin-bottom:24px}
        .step{display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid #e8e8ed;background:#fff;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.03)}
        .step.active{border-color:rgba(102,126,234,.4);background:rgba(102,126,234,.05)}
        .step.done{border-color:rgba(74,222,128,.4);background:rgba(74,222,128,.05)}
        .step-num{width:24px;height:24px;border-radius:50%;background:#f0f0f5;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#aaa;transition:all .3s}
        .step.active .step-num{background:rgba(102,126,234,.15);color:#667eea}
        .step.done .step-num{background:rgba(74,222,128,.15);color:#22c55e}
        .step-label{font-size:11px;color:#aaa;transition:color .3s}
        .step.active .step-label{color:#555}
        .step.done .step-label{color:#22c55e}

        .status-box{padding:12px 24px;border-radius:14px;border:1px solid #e8e8ed;background:#fff;display:flex;align-items:center;gap:10px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
        .dot{width:8px;height:8px;border-radius:50%;background:#ccc;flex-shrink:0;transition:background .3s}
        .dot.on{background:#22c55e;animation:bl 1.5s infinite}
        @keyframes bl{50%{opacity:.3}}
        .status-txt{font-size:12px;color:#888}
        .finger-display{font-size:11px;color:#aaa;height:16px}

        .btn-start{padding:14px 36px;border:none;border-radius:14px;font-size:14px;font-weight:600;color:#fff;background:linear-gradient(135deg,#667eea,#764ba2);cursor:pointer;margin-top:20px;transition:all .2s;box-shadow:0 4px 16px rgba(102,126,234,.25)}
        .btn-start:hover{box-shadow:0 6px 24px rgba(102,126,234,.35);transform:translateY(-1px)}
        .btn-start:active{transform:scale(.96)}
        .btn-start.hide{display:none}

        .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);padding:10px 20px;background:#fff;border-radius:10px;font-size:12px;z-index:999;transition:all .3s;opacity:0;border:1px solid #e8e8ed;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.ok{border-color:rgba(34,197,94,.3);color:#16a34a}
        .toast.err{border-color:rgba(239,68,68,.3);color:#dc2626}
        .toast.inf{border-color:rgba(102,126,234,.3);color:#667eea}

        .dm{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:900;padding:20px}
        .dm.on{display:flex}
        .dc{background:#fff;border-radius:20px;padding:28px;width:100%;max-width:380px;text-align:center;border:1px solid #e8e8ed;box-shadow:0 20px 60px rgba(0,0,0,.1)}
        .dc h3{font-size:16px;margin-bottom:4px;color:#1a1a1a}
        .dc .ds{font-size:12px;color:#888;margin-bottom:16px}
        .pw{width:100%;height:4px;background:#f0f0f5;border-radius:2px;overflow:hidden;margin-bottom:8px}
        .pb{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:2px;width:0%;transition:width .3s}
        .pt{font-size:11px;color:#aaa}
        .fl{margin-top:14px;max-height:180px;overflow-y:auto;text-align:left}
        .fi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fafafc;border-radius:10px;margin-bottom:4px;border:1px solid #f0f0f5}
        .fi-n{font-size:11px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#333}
        .fi-s{font-size:10px;font-weight:700;flex-shrink:0}
        .fi-s.w{color:#ccc}.fi-s.dl{color:#667eea}.fi-s.ok{color:#22c55e}.fi-s.er{color:#dc2626}
        .d-cls{margin-top:16px;padding:10px 26px;border:1px solid #e8e8ed;border-radius:12px;background:#fff;color:#888;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
        .d-cls:hover{background:#f5f5f7;color:#333}
    </style>
</head>
<body>
<div class="app">
    <video id="vid" autoplay playsinline muted></video>
    <div class="main">
        <div class="icon-wrap" id="iconWrap"><div class="hand-icon" id="handIcon">‚úã</div></div>
        <div class="title">Terima File dengan Gesture</div>
        <div class="desc">Kepalkan tangan lalu buka 5 jari untuk download file dari cloud</div>

        <div class="steps">
            <div class="step" id="s1">
                <div class="step-num">1</div>
                <span class="step-label">‚úä Kepal</span>
            </div>
            <div class="step" id="s2">
                <div class="step-num">2</div>
                <span class="step-label">üñêÔ∏è Buka 5 jari</span>
            </div>
        </div>

        <div class="status-box">
            <div class="dot" id="dot"></div>
            <span class="status-txt" id="stTxt">Kamera mati</span>
        </div>
        <div class="finger-display" id="fDisp"></div>
        <button class="btn-start" id="startBtn" onclick="start()">üé• Mulai</button>
    </div>
</div>

<div class="dm" id="dMod">
    <div class="dc">
        <h3 id="dTit">Mengunduh...</h3>
        <p class="ds" id="dSub">Mohon tunggu</p>
        <div class="pw"><div class="pb" id="pBar"></div></div>
        <span class="pt" id="pTxt">0%</span>
        <div class="fl" id="fList"></div>
        <button class="d-cls" id="dCls" style="display:none" onclick="closeDl()">Tutup</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.min.js"></script>
<script>
const SB='https://xgsxiednpuxqhcqerdzu.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhnc3hpZWRucHV4cWhjcWVyZHp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjE3MTcsImV4cCI6MjA4NjQ5NzcxN30.3TF2asecsxafYmscgEz60ty1iBsosjSjOiVBoTrZjVU';
const BK='media-files';
let stream=null,active=false,running=false,hands=null,af=null,busy=false;
let gestureStep=0;

const $=id=>document.getElementById(id);
function toast(m,t='ok'){const e=$('toast');e.textContent=m;e.className='toast '+t+' show';setTimeout(()=>e.classList.remove('show'),2500)}

function resetSteps(){
    gestureStep=0;
    $('s1').className='step';
    $('s2').className='step';
    $('iconWrap').className='icon-wrap';
    $('handIcon').textContent='‚úã';
}

function setStep(n){
    gestureStep=n;
    if(n===1){
        $('s1').className='step done';
        $('s2').className='step active';
        $('iconWrap').className='icon-wrap step1';
        $('handIcon').textContent='‚úä';
        $('stTxt').textContent='‚úä Kepal! Sekarang buka 5 jari';
        toast('‚úä Tahap 1 ‚Äî sekarang buka tangan!','inf');
    }
    if(n===2){
        $('s1').className='step done';
        $('s2').className='step done';
        $('iconWrap').className='icon-wrap step2';
        $('handIcon').textContent='üñêÔ∏è';
        $('stTxt').textContent='üñêÔ∏è Download!';
    }
}

async function start(){
    if(active)return;
    try{
        $('stTxt').textContent='Memulai...';
        resetSteps();
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}});
        $('vid').srcObject=stream;await $('vid').play();
        active=running=true;
        $('dot').classList.add('on');
        $('stTxt').textContent='Tunjukkan tangan...';
        $('startBtn').classList.add('hide');
        if(!hands){
            hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/${f}`});
            hands.setOptions({maxNumHands:1,modelComplexity:0,minDetectionConfidence:.6,minTrackingConfidence:.4});
            hands.onResults(onRes);
        }
        const v=$('vid');
        const loop=async()=>{if(!running)return;if(v.readyState>=2){try{await hands.send({image:v})}catch(e){}}af=requestAnimationFrame(loop)};loop();
        toast('Kepalkan tangan dulu ‚úä','inf');
    }catch(e){$('stTxt').textContent='Gagal';toast('Gagal: '+e.message,'err')}
}

function onRes(r){
    if(!running)return;
    if(r.multiHandLandmarks?.length){
        const l=r.multiHandLandmarks[0],fc=countF(l);
        $('fDisp').textContent=fc>0?'üñêÔ∏è '+fc+' jari':'‚úä Kepal';

        if(gestureStep===0){
            $('s1').className='step active';
            $('stTxt').textContent='Kepalkan tangan... ('+fc+' jari)';
            if(fc===0) setStep(1);
        }else if(gestureStep===1){
            if(fc===5&&!busy){
                setStep(2);
                busy=true;stop();
                toast('üñêÔ∏è Download dimulai!');
                dlAll();
            }else if(fc>0&&fc<5){
                $('stTxt').textContent='Buka 5 jari! ('+fc+' jari)';
            }else if(fc===0){
                $('stTxt').textContent='‚úä Bagus! Sekarang buka 5 jari';
            }
        }
    }else{
        $('fDisp').textContent='';
        if(gestureStep===0) $('stTxt').textContent='Tunjukkan tangan...';
        else if(gestureStep===1) $('stTxt').textContent='Tangan hilang ‚Äî tunjukkan lagi';
    }
}

function countF(l){
    let n=0;const rx=l[5].x<l[17].x;
    if(rx?l[4].x<l[3].x:l[4].x>l[3].x)n++;
    if(l[8].y<l[6].y)n++;if(l[12].y<l[10].y)n++;
    if(l[16].y<l[14].y)n++;if(l[20].y<l[18].y)n++;return n;
}

function stop(){
    running=active=false;
    if(af){cancelAnimationFrame(af);af=null}
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
    $('vid').srcObject=null;
    $('dot').classList.remove('on');
    $('stTxt').textContent='Kamera mati';
    $('fDisp').textContent='';
    $('startBtn').classList.remove('hide');
    resetSteps();
}

function closeDl(){$('dMod').classList.remove('on')}

const hd=()=>({'apikey':SK,'Authorization':`Bearer ${SK}`,'Content-Type':'application/json'});

async function dlAll(){
    const bar=$('pBar'),pt=$('pTxt'),fl=$('fList'),cls=$('dCls');
    $('dMod').classList.add('on');
    $('dTit').textContent='Mengambil...';$('dSub').textContent='';
    bar.style.width='5%';pt.textContent='...';fl.innerHTML='';cls.style.display='none';
    try{
        const r=await fetch(`${SB}/rest/v1/shared_files?select=*&order=shared_at.desc`,{headers:hd()});
        if(!r.ok)throw new Error('HTTP '+r.status);
        const files=await r.json();bar.style.width='15%';
        if(!files.length){
            $('dTit').textContent='Kosong';$('dSub').textContent='Tidak ada file';
            bar.style.width='100%';pt.textContent='‚Äî';cls.style.display='inline-block';busy=false;return;
        }
        $('dTit').textContent=`Unduh ${files.length} file`;
        files.forEach(f=>{fl.innerHTML+=`<div class="fi"><span class="fi-n">${f.file_name}</span><span class="fi-s w" id="s${f.id}">‚è≥</span></div>`});
        let dn=0,err=0;
        for(const f of files){
            const s=$('s'+f.id);s.textContent='‚¨áÔ∏è';s.className='fi-s dl';
            try{
                await dl(f.file_url,f.file_name);s.textContent='‚úÖ';s.className='fi-s ok';
                fetch(`${SB}/rest/v1/shared_files?id=eq.${f.id}`,{method:'DELETE',headers:{'apikey':SK,'Authorization':`Bearer ${SK}`}}).catch(()=>{});
                const p=exPath(f.file_url);if(p)fetch(`${SB}/storage/v1/object/${BK}/${p}`,{method:'DELETE',headers:{'apikey':SK,'Authorization':`Bearer ${SK}`}}).catch(()=>{});
            }catch(e){s.textContent='‚ùå';s.className='fi-s er';err++}
            dn++;bar.style.width=(15+dn/files.length*85)+'%';pt.textContent=`${dn}/${files.length}`;
        }
        $('dTit').textContent=err?'‚ö†Ô∏è Selesai':'‚úÖ Selesai';
        $('dSub').textContent=`${dn-err} berhasil${err?', '+err+' gagal':''}`;
        bar.style.width='100%';pt.textContent='100%';cls.style.display='inline-block';
        toast((dn-err)+' file diunduh!',err?'err':'ok');
    }catch(e){
        $('dTit').textContent='‚ùå Gagal';$('dSub').textContent=e.message;
        bar.style.width='100%';cls.style.display='inline-block';toast('Gagal','err');
    }
    busy=false;
}

async function dl(url,name){
    try{const r=await fetch(url);if(r.ok){save(await r.blob(),name);return}}catch(e){}
    try{const p=exPath(url);if(p){const s=await fetch(`${SB}/storage/v1/object/sign/${BK}/${p}`,{method:'POST',headers:hd(),body:JSON.stringify({expiresIn:3600})});if(s.ok){const d=await s.json();const r=await fetch(`${SB}/storage/v1${d.signedURL}`);if(r.ok){save(await r.blob(),name);return}}}}catch(e){}
    const a=document.createElement('a');a.href=url;a.download=name;a.target='_blank';document.body.appendChild(a);a.click();a.remove();
    await new Promise(r=>setTimeout(r,500));
}

function save(b,n){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),3000)}

function exPath(u){const m=`/storage/v1/object/public/${BK}/`;let i=u.indexOf(m);if(i!==-1)return decodeURIComponent(u.substring(i+m.length));const p=u.split(`${BK}/`);return p.length>1?decodeURIComponent(p.slice(1).join(`${BK}/`)):null}

window.addEventListener('beforeunload',stop);
</script>
</body>
</html>

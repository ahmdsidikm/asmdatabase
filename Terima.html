<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan & Gesture App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== HOME SCREEN ========== */
        .home-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .home-screen.hidden {
            display: none;
        }

        .app-logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .app-logo svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 50px;
            text-align: center;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 350px;
        }

        .btn-main {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn-main:hover::before {
            left: 100%;
        }

        .btn-main:active {
            transform: scale(0.97);
        }

        .btn-scan {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .btn-scan:hover {
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .btn-gesture {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 10px 40px rgba(245, 87, 108, 0.3);
        }

        .btn-gesture:hover {
            box-shadow: 0 15px 50px rgba(245, 87, 108, 0.5);
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .btn-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .btn-text small {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 400;
        }

        /* ========== SCANNER SCREEN ========== */
        .scanner-screen,
        .gesture-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .scanner-screen.active,
        .gesture-screen.active {
            display: flex;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-back {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid #333;
            background: rgba(255,255,255,0.05);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: rgba(255,255,255,0.1);
            border-color: #555;
        }

        .btn-back svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .top-bar-title {
            font-size: 16px;
            font-weight: 600;
        }

        .top-bar-spacer {
            width: 40px;
        }

        /* ========== CAMERA AREA ========== */
        .camera-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111;
            overflow: hidden;
        }

        .camera-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Scanner overlay */
        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scan-frame {
            width: 260px;
            height: 260px;
            position: relative;
        }

        .scan-frame::before,
        .scan-frame::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #667eea;
            border-style: solid;
        }

        .scan-frame::before {
            top: 0;
            left: 0;
            border-width: 3px 0 0 3px;
            border-radius: 8px 0 0 0;
        }

        .scan-frame::after {
            top: 0;
            right: 0;
            border-width: 3px 3px 0 0;
            border-radius: 0 8px 0 0;
        }

        .scan-frame-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
        }

        .scan-frame-bottom::before,
        .scan-frame-bottom::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #667eea;
            border-style: solid;
        }

        .scan-frame-bottom::before {
            bottom: 0;
            left: 0;
            border-width: 0 0 3px 3px;
            border-radius: 0 0 0 8px;
        }

        .scan-frame-bottom::after {
            bottom: 0;
            right: 0;
            border-width: 0 3px 3px 0;
            border-radius: 0 0 8px 0;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            animation: scanLine 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        @keyframes scanLine {
            0%, 100% { top: 10px; }
            50% { top: calc(100% - 10px); }
        }

        /* ========== GESTURE AREA ========== */
        .gesture-info {
            position: absolute;
            bottom: 40px;
            left: 20px;
            right: 20px;
            text-align: center;
            z-index: 50;
        }

        .gesture-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .gesture-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f5576c;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .gesture-dot.active {
            background: #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .finger-count-display {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 24px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .finger-count-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .finger-count-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        /* ========== STATUS BAR BOTTOM ========== */
        .bottom-status {
            padding: 16px 20px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            text-align: center;
            border-top: 1px solid #222;
        }

        .bottom-status p {
            font-size: 13px;
            color: #888;
        }

        /* ========== MODAL / TOAST ========== */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 28px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 14px;
            font-size: 14px;
            z-index: 9999;
            transition: transform 0.4s ease, opacity 0.4s ease;
            opacity: 0;
            border: 1px solid #333;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #4ade80;
            color: #4ade80;
        }

        .toast.error {
            border-color: #f5576c;
            color: #f5576c;
        }

        .toast.info {
            border-color: #667eea;
            color: #667eea;
        }

        /* ========== DOWNLOAD PROGRESS ========== */
        .download-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            padding: 20px;
        }

        .download-modal.active {
            display: flex;
        }

        .download-card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 380px;
            text-align: center;
            border: 1px solid #333;
        }

        .download-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .download-card p {
            font-size: 13px;
            color: #888;
            margin-bottom: 24px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #888;
        }

        .download-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .download-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .download-icon.success-icon {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid #222;
        }

        .file-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-item-icon.image {
            background: rgba(102, 126, 234, 0.15);
        }

        .file-item-icon.video {
            background: rgba(245, 87, 108, 0.15);
        }

        .file-item-icon svg {
            width: 18px;
            height: 18px;
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-size {
            font-size: 11px;
            color: #666;
        }

        .file-item-status {
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .file-item-status.downloading {
            color: #667eea;
        }

        .file-item-status.done {
            color: #4ade80;
        }

        .file-item-status.error {
            color: #f5576c;
        }

        /* ========== LOADING SPINNER ========== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== RESPONSIVE ========== */
        @media (min-width: 768px) {
            .btn-container {
                flex-direction: row;
            }

            .btn-main {
                flex: 1;
            }

            .scan-frame {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>
<body>

    <!-- ===================== HOME SCREEN ===================== -->
    <div class="home-screen" id="homeScreen">
        <div class="app-logo">
            <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
        </div>
        <h1 class="app-title">MediaScan</h1>
        <p class="app-subtitle">Scan barcode atau gunakan gesture tangan<br>untuk mengunduh media</p>

        <div class="btn-container">
            <button class="btn-main btn-scan" onclick="openScanner()">
                <div class="btn-icon">
                    <svg viewBox="0 0 24 24"><path d="M4 6h2V4H2v4h2V6zm16-2h-4v2h2v2h2V4zM4 18H2v4h4v-2H4v-2zM18 18v2h-4v2h4a2 2 0 002-2v-2h-2zM12 6a6 6 0 100 12 6 6 0 000-12zm0 10a4 4 0 110-8 4 4 0 010 8zm0-6a2 2 0 100 4 2 2 0 000-4z"/></svg>
                </div>
                <div class="btn-text">
                    Scan Barcode
                    <small>Pindai QR / Barcode</small>
                </div>
            </button>

            <button class="btn-main btn-gesture" onclick="openGesture()">
                <div class="btn-icon">
                    <svg viewBox="0 0 24 24"><path d="M18 8c-.28 0-.55.04-.81.12L15 4.47A1.98 1.98 0 0013 3c-.69 0-1.28.35-1.64.88L9.54 2.06A1.98 1.98 0 007.5 1C6.12 1 5 2.12 5 3.5V15l-1.29-1.29a2 2 0 00-2.83 0 2 2 0 000 2.83l4.24 4.24A5.98 5.98 0 009.34 23h5.16A5.5 5.5 0 0020 17.5V10c0-1.1-.9-2-2-2zm0 9.5a3.5 3.5 0 01-3.5 3.5H9.34a3.98 3.98 0 01-2.83-1.17L3.17 16.5l.71-.71L7 18.91V3.5c0-.28.22-.5.5-.5s.5.22.5.5v8h2V3c0-.28.22-.5.5-.5s.5.22.5.5v9h2V4.47c0-.28.22-.5.5-.5s.5.22.5.5V13h2v-3c0-.28.22-.5.5-.5s.5.22.5.5v7.5z"/></svg>
                </div>
                <div class="btn-text">
                    Gunakan Tangan
                    <small>Gesture 5 jari untuk download</small>
                </div>
            </button>
        </div>
    </div>

    <!-- ===================== SCANNER SCREEN ===================== -->
    <div class="scanner-screen" id="scannerScreen">
        <div class="top-bar">
            <button class="btn-back" onclick="goHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <span class="top-bar-title">Scan Barcode</span>
            <div class="top-bar-spacer"></div>
        </div>

        <div class="camera-container" id="scannerCameraContainer">
            <video id="scannerVideo" autoplay playsinline muted></video>
            <canvas id="scannerCanvas" style="display:none;"></canvas>
            <div class="scan-overlay">
                <div class="scan-frame">
                    <div class="scan-line"></div>
                    <div class="scan-frame-bottom"></div>
                </div>
            </div>
        </div>

        <div class="bottom-status">
            <p id="scannerStatus">Arahkan kamera ke barcode atau QR Code...</p>
        </div>
    </div>

    <!-- ===================== GESTURE SCREEN ===================== -->
    <div class="gesture-screen" id="gestureScreen">
        <div class="top-bar">
            <button class="btn-back" onclick="goHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <span class="top-bar-title">Gesture Tangan</span>
            <div class="top-bar-spacer"></div>
        </div>

        <div class="camera-container" id="gestureCameraContainer">
            <video id="gestureVideo" autoplay playsinline muted></video>
            <canvas id="gestureCanvas"></canvas>

            <div class="finger-count-display" id="fingerCountDisplay">
                <div class="finger-count-number" id="fingerCountNumber">0</div>
                <div class="finger-count-label">Jari Terbuka</div>
            </div>

            <div class="gesture-info">
                <div class="gesture-status">
                    <div class="gesture-dot" id="gestureDot"></div>
                    <span id="gestureStatusText">Mendeteksi tangan...</span>
                </div>
            </div>
        </div>

        <div class="bottom-status">
            <p>Buka 5 jari untuk mengunduh media dari Supabase</p>
        </div>
    </div>

    <!-- ===================== DOWNLOAD MODAL ===================== -->
    <div class="download-modal" id="downloadModal">
        <div class="download-card" id="downloadCard">
            <div class="download-icon" id="downloadIconContainer">
                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </div>
            <h3 id="downloadTitle">Mengunduh Media...</h3>
            <p id="downloadSubtitle">Mohon tunggu sebentar</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <span class="progress-text" id="progressText">0%</span>
            <div class="file-list" id="fileList"></div>
        </div>
    </div>

    <!-- ===================== TOAST ===================== -->
    <div class="toast" id="toast"></div>

    <!-- ===================== SCRIPTS ===================== -->
    <!-- ZXing Library for Barcode Scanning -->
    <script src="https://unpkg.com/@nicolo-ribaudo/chokidar-2@2.1.8-no-fsevents.3/upath/package.json"></script>
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://xgsxiednpuxqhcqerdzu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhnc3hpZWRucHV4cWhjcWVyZHp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjE3MTcsImV4cCI6MjA4NjQ5NzcxN30.3TF2asecsxafYmscgEz60ty1iBsosjSjOiVBoTrZjVU';

        let currentStream = null;
        let scannerActive = false;
        let gestureActive = false;
        let isDownloading = false;
        let fiveFingerHoldTimer = null;
        let lastFingerCount = 0;
        let codeReader = null;

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function goHome() {
            stopCamera();
            scannerActive = false;
            gestureActive = false;

            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }

            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('scannerScreen').classList.remove('active');
            document.getElementById('gestureScreen').classList.remove('active');
        }

        // ==========================================
        // BARCODE SCANNER
        // ==========================================
        function openScanner() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('scannerScreen').classList.add('active');
            scannerActive = true;
            startBarcodeScanner();
        }

        async function startBarcodeScanner() {
            const video = document.getElementById('scannerVideo');
            const statusEl = document.getElementById('scannerStatus');

            try {
                // Get rear camera
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;

                statusEl.textContent = 'Arahkan kamera ke barcode atau QR Code...';

                // Use ZXing for barcode detection
                if (typeof ZXing !== 'undefined') {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    
                    codeReader.decodeFromVideoDevice(undefined, 'scannerVideo', (result, err) => {
                        if (result && scannerActive) {
                            const text = result.getText();
                            statusEl.textContent = 'Ditemukan: ' + text;
                            scannerActive = false;

                            if (codeReader) {
                                codeReader.reset();
                            }
                            
                            handleBarcodeResult(text);
                        }
                    });
                } else {
                    // Fallback: Use BarcodeDetector API
                    if ('BarcodeDetector' in window) {
                        const barcodeDetector = new BarcodeDetector({
                            formats: ['qr_code', 'ean_13', 'ean_8', 'code_128', 'code_39', 'code_93', 'upc_a', 'upc_e', 'data_matrix', 'pdf417']
                        });

                        const scanLoop = async () => {
                            if (!scannerActive) return;

                            try {
                                const barcodes = await barcodeDetector.detect(video);
                                if (barcodes.length > 0) {
                                    const rawValue = barcodes[0].rawValue;
                                    statusEl.textContent = 'Ditemukan: ' + rawValue;
                                    scannerActive = false;
                                    handleBarcodeResult(rawValue);
                                    return;
                                }
                            } catch (e) {
                                console.error('Scan error:', e);
                            }

                            if (scannerActive) {
                                requestAnimationFrame(scanLoop);
                            }
                        };

                        scanLoop();
                    } else {
                        statusEl.textContent = 'Browser tidak mendukung scanner. Coba gunakan Chrome.';
                        showToast('Browser tidak mendukung barcode scanner', 'error');
                    }
                }

            } catch (err) {
                console.error('Camera error:', err);
                statusEl.textContent = 'Gagal mengakses kamera: ' + err.message;
                showToast('Gagal mengakses kamera', 'error');
            }
        }

        function handleBarcodeResult(text) {
            showToast('Barcode terdeteksi: ' + text, 'success');

            // Check if it's a URL
            try {
                const url = new URL(text);
                setTimeout(() => {
                    if (confirm('Buka URL ini?\n\n' + text)) {
                        window.open(text, '_blank');
                    }
                    goHome();
                }, 500);
            } catch {
                // Not a URL, just show result
                setTimeout(() => {
                    alert('Hasil scan:\n\n' + text);
                    goHome();
                }, 500);
            }
        }

        // ==========================================
        // GESTURE DETECTION (MediaPipe)
        // ==========================================
        function openGesture() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('gestureScreen').classList.add('active');
            gestureActive = true;
            startGestureDetection();
        }

        async function startGestureDetection() {
            const videoElement = document.getElementById('gestureVideo');
            const canvasElement = document.getElementById('gestureCanvas');
            const canvasCtx = canvasElement.getContext('2d');

            try {
                // Initialize MediaPipe Hands
                const hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.5
                });

                hands.onResults((results) => {
                    if (!gestureActive) return;
                    onGestureResults(results, canvasElement, canvasCtx);
                });

                // Setup camera with rear-facing
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;

                await videoElement.play();

                // Set canvas size
                canvasElement.width = videoElement.videoWidth || 1280;
                canvasElement.height = videoElement.videoHeight || 720;

                // Process frames
                const processFrame = async () => {
                    if (!gestureActive) return;

                    if (videoElement.readyState >= 2) {
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                        await hands.send({ image: videoElement });
                    }

                    requestAnimationFrame(processFrame);
                };

                processFrame();

                showToast('Kamera gesture siap', 'success');

            } catch (err) {
                console.error('Gesture camera error:', err);
                showToast('Gagal mengakses kamera: ' + err.message, 'error');
                document.getElementById('gestureStatusText').textContent = 'Error: ' + err.message;
            }
        }

        function onGestureResults(results, canvasElement, canvasCtx) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // Don't draw camera feed on canvas (it's behind as video element)
            
            const fingerCountEl = document.getElementById('fingerCountNumber');
            const gestureDot = document.getElementById('gestureDot');
            const gestureText = document.getElementById('gestureStatusText');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                // Draw hand landmarks
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                    color: 'rgba(102, 126, 234, 0.6)',
                    lineWidth: 2
                });
                drawLandmarks(canvasCtx, landmarks, {
                    color: '#f093fb',
                    lineWidth: 1,
                    radius: 4
                });

                // Count open fingers
                const fingerCount = countFingers(landmarks);
                fingerCountEl.textContent = fingerCount;
                gestureDot.classList.add('active');

                if (fingerCount === 5) {
                    gestureText.textContent = '✋ 5 Jari terbuka! Menahan...';
                    
                    if (lastFingerCount !== 5) {
                        // Start hold timer
                        fiveFingerHoldTimer = setTimeout(() => {
                            if (!isDownloading && gestureActive) {
                                gestureText.textContent = '⬇️ Memulai download...';
                                triggerDownloadFromSupabase();
                            }
                        }, 1500); // Hold 1.5 seconds
                    }
                } else {
                    gestureText.textContent = `Terdeteksi: ${fingerCount} jari terbuka`;
                    
                    if (fiveFingerHoldTimer) {
                        clearTimeout(fiveFingerHoldTimer);
                        fiveFingerHoldTimer = null;
                    }
                }

                lastFingerCount = fingerCount;

            } else {
                fingerCountEl.textContent = '0';
                gestureDot.classList.remove('active');
                gestureText.textContent = 'Mendeteksi tangan...';
                lastFingerCount = 0;

                if (fiveFingerHoldTimer) {
                    clearTimeout(fiveFingerHoldTimer);
                    fiveFingerHoldTimer = null;
                }
            }

            canvasCtx.restore();
        }

        function countFingers(landmarks) {
            let count = 0;

            // Tip and PIP/MCP indices for each finger
            // Thumb: compare tip (4) x with MCP (2) x (for right hand) or y-based
            // We'll use a simplified approach

            // Thumb (4 vs 2) - use x-distance from wrist
            const thumbTip = landmarks[4];
            const thumbIP = landmarks[3];
            const thumbMCP = landmarks[2];
            const wrist = landmarks[0];

            // Calculate hand orientation
            const indexMCP = landmarks[5];
            const pinkyMCP = landmarks[17];
            
            // Simple thumb detection: check if thumb tip is far from palm center
            const palmCenterX = (landmarks[0].x + landmarks[5].x + landmarks[17].x) / 3;
            const thumbDist = Math.abs(thumbTip.x - palmCenterX);
            const thumbMCPDist = Math.abs(thumbMCP.x - palmCenterX);
            
            if (thumbDist > thumbMCPDist * 1.2) {
                count++;
            }

            // Index finger (8 vs 6)
            if (landmarks[8].y < landmarks[6].y) count++;
            
            // Middle finger (12 vs 10)
            if (landmarks[12].y < landmarks[10].y) count++;
            
            // Ring finger (16 vs 14)
            if (landmarks[16].y < landmarks[14].y) count++;
            
            // Pinky (20 vs 18)
            if (landmarks[20].y < landmarks[18].y) count++;

            return count;
        }

        // ==========================================
        // SUPABASE DOWNLOAD
        // ==========================================
        async function triggerDownloadFromSupabase() {
            if (isDownloading) return;
            isDownloading = true;

            const modal = document.getElementById('downloadModal');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const downloadTitle = document.getElementById('downloadTitle');
            const downloadSubtitle = document.getElementById('downloadSubtitle');
            const fileListEl = document.getElementById('fileList');
            const downloadIcon = document.getElementById('downloadIconContainer');

            // Show modal
            modal.classList.add('active');
            downloadTitle.textContent = 'Mengambil Data...';
            downloadSubtitle.textContent = 'Membaca media dari Supabase';
            progressBar.style.width = '10%';
            progressText.textContent = 'Menghubungi server...';
            fileListEl.innerHTML = '';
            downloadIcon.className = 'download-icon';
            downloadIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>';

            try {
                // Fetch media files from Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/media_files?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const mediaFiles = await response.json();
                
                progressBar.style.width = '20%';
                progressText.textContent = `Ditemukan ${mediaFiles.length} file`;

                if (mediaFiles.length === 0) {
                    downloadTitle.textContent = 'Tidak Ada Media';
                    downloadSubtitle.textContent = 'Belum ada file media di database';
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Selesai';
                    
                    setTimeout(() => {
                        modal.classList.remove('active');
                        isDownloading = false;
                        showToast('Tidak ada media untuk diunduh', 'info');
                    }, 2000);
                    return;
                }

                downloadTitle.textContent = `Mengunduh ${mediaFiles.length} File`;
                downloadSubtitle.textContent = 'Mohon tunggu...';

                // Display file list
                mediaFiles.forEach(file => {
                    const iconClass = file.file_type === 'video' ? 'video' : 'image';
                    const iconSvg = file.file_type === 'video' 
                        ? '<svg fill="#f5576c" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>'
                        : '<svg fill="#667eea" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';

                    fileListEl.innerHTML += `
                        <div class="file-item" id="file-${file.id}">
                            <div class="file-item-icon ${iconClass}">${iconSvg}</div>
                            <div class="file-item-info">
                                <div class="file-item-name">${file.file_name}</div>
                                <div class="file-item-size">${formatFileSize(file.file_size)}</div>
                            </div>
                            <span class="file-item-status downloading" id="status-${file.id}">Menunggu...</span>
                        </div>
                    `;
                });

                // Download each file
                let completed = 0;
                const total = mediaFiles.length;

                for (const file of mediaFiles) {
                    const statusEl = document.getElementById(`status-${file.id}`);
                    statusEl.textContent = 'Mengunduh...';
                    statusEl.className = 'file-item-status downloading';

                    try {
                        // Download the file
                        await downloadFile(file.public_url, file.file_name);

                        statusEl.textContent = '✓ Selesai';
                        statusEl.className = 'file-item-status done';

                        // Record to shared_media
                        await recordSharedMedia(file);

                        // Delete from media_files
                        await deleteMediaFile(file.id);

                        completed++;
                        const progress = 20 + (completed / total * 80);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${completed}/${total} file selesai`;

                    } catch (dlError) {
                        console.error('Download error for', file.file_name, dlError);
                        statusEl.textContent = '✗ Gagal';
                        statusEl.className = 'file-item-status error';
                        completed++;
                    }
                }

                // Complete
                downloadTitle.textContent = 'Download Selesai!';
                downloadSubtitle.textContent = `${completed} file berhasil diunduh`;
                progressBar.style.width = '100%';
                progressText.textContent = '100% Selesai';
                downloadIcon.className = 'download-icon success-icon';
                downloadIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';

                showToast(`${completed} file berhasil diunduh!`, 'success', 4000);

                setTimeout(() => {
                    modal.classList.remove('active');
                    isDownloading = false;
                }, 3000);

            } catch (error) {
                console.error('Supabase fetch error:', error);
                downloadTitle.textContent = 'Terjadi Kesalahan';
                downloadSubtitle.textContent = error.message;
                progressBar.style.width = '100%';
                progressText.textContent = 'Error';
                downloadIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';

                showToast('Gagal mengambil data: ' + error.message, 'error', 5000);

                setTimeout(() => {
                    modal.classList.remove('active');
                    isDownloading = false;
                }, 3000);
            }
        }

        async function downloadFile(url, fileName) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Download failed');
                
                const blob = await response.blob();
                
                // Create download link
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                
                // Small delay between downloads
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.error('File download error:', error);
                throw error;
            }
        }

        async function recordSharedMedia(file) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/shared_media`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        media_file_id: file.id,
                        file_name: file.file_name,
                        file_type: file.file_type,
                        public_url: file.public_url,
                        shared_method: 'fist_gesture',
                        notes: 'Downloaded via 5-finger gesture'
                    })
                });
            } catch (err) {
                console.warn('Failed to record shared media:', err);
            }
        }

        async function deleteMediaFile(fileId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/media_files?id=eq.${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.warn('Failed to delete media file:', fileId);
                }
            } catch (err) {
                console.warn('Delete error:', err);
            }
        }

        // ==========================================
        // CLEANUP ON PAGE UNLOAD
        // ==========================================
        window.addEventListener('beforeunload', () => {
            stopCamera();
            if (codeReader) {
                codeReader.reset();
            }
        });

        // Prevent back button issues
        window.addEventListener('popstate', () => {
            if (document.getElementById('scannerScreen').classList.contains('active') ||
                document.getElementById('gestureScreen').classList.contains('active')) {
                goHome();
            }
        });
    </script>
</body>
</html>
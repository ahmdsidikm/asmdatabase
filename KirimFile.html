<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unggah Gambar/Video/Teks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JavaScript Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Library QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #1f2937; color: #f3f4f6; }
    .table-container { overflow-x: auto; }
    input[type="file"]::file-selector-button {
      background-color: #374151;
      color: #f3f4f6;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    input[type="file"]::file-selector-button:hover {
      background-color: #4b5563;
    }
    .custom-confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      transition: opacity 0.3s ease-in-out;
    }
    .custom-confirm-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      cursor: pointer;
      font-weight: 500;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: inherit;
      width: 100%;
      height: 100%;
    }
    .file-input-label {
      display: inline-block;
      padding: 0.5rem 1.5rem;
      border-radius: 0.5rem;
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .file-input-label:hover {
      background-color: #2563eb;
    }
    .countdown-timer {
      font-size: 0.8rem;
      color: #fca5a5;
      font-weight: 500;
    }
    .popup-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
      transition: opacity 0.3s ease-in-out;
    }
    .popup-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .popup-content {
      background-color: #1f2937;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 90%;
      width: 600px;
      position: relative;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .close-button:hover {
      color: #f3f4f6;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-start justify-center min-h-screen p-4 sm:p-6">
  <div class="bg-gray-800 rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-sm md:max-w-4xl border border-gray-700">
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-white mb-2 sm:mb-4">Kirim File Instan</h1>
    <p class="text-center text-gray-400 text-sm sm:text-base mb-4 sm:mb-6">
      Pilih gambar, video, dokumen, atau ketik teks untuk diunggah.
    </p>
    <!-- Tombol untuk membuka popup unggahan -->
    <div class="flex justify-center mb-6">
      <button id="openUploadPopupBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
        Unggah File & Teks
      </button>
    </div>
    <!-- Popup untuk area upload file dan teks -->
    <div id="uploadPopup" class="popup-modal hidden">
      <div class="popup-content">
        <button id="closeUploadPopupBtn" class="close-button">&times;</button>
        <h2 class="text-xl font-bold mb-4 text-white">Unggah File atau Teks</h2>
        <!-- Upload area for Files -->
        <div id="fileUploadArea" class="space-y-4">
          <div class="flex flex-col sm:flex-row gap-4 items-center">
            <div class="file-input-wrapper flex-1">
              <span id="fileInputLabel" class="file-input-label w-full block sm:inline-block">Pilih File</span>
              <input id="fileInput" type="file" />
            </div>
            <select id="expiryTimeSelect" class="w-full sm:w-auto p-2 border border-gray-600 bg-gray-700 rounded-lg text-white">
              <option value="5">5 Menit</option>
              <option value="15">15 Menit</option>
              <option value="30">30 Menit</option>
              <option value="60">1 Jam</option>
              <option value="240">4 Jam</option>
              <option value="1440">1 Hari</option>
            </select>
            <button id="uploadButton" disabled class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 opacity-50 cursor-not-allowed">
              Unggah File
            </button>
          </div>
          <!-- Ringkasan file terpilih (responsif) -->
          <div id="fileSummary" class="hidden flex-col sm:flex-row items-center gap-4 p-4 border border-blue-700 rounded-lg bg-blue-950/40 transition-all duration-300">
            <div class="flex-shrink-0">
              <img id="imgThumb" alt="thumbnail" class="w-28 h-28 object-cover rounded-lg border border-blue-700 shadow-sm hidden" />
              <video id="videoThumb" controls class="w-28 h-28 sm:w-48 sm:h-28 rounded-lg border border-blue-700 shadow-sm hidden"></video>
            </div>
            <div class="flex-1 text-center sm:text-left">
              <div id="summaryName" class="font-bold text-gray-200 break-words"></div>
              <div id="summarySize" class="text-sm text-gray-400 mt-1"></div>
              <div id="summaryMime" class="text-sm text-gray-400 mt-1"></div>
            </div>
          </div>
        </div>
        <!-- Upload area for Text -->
        <div id="textUploadArea" class="mt-8 space-y-4">
          <h2 class="text-lg font-semibold text-gray-200">Unggah Teks</h2>
          <textarea id="textInput" rows="5" placeholder="Ketik teks yang ingin diunggah di sini..." class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
          <div class="flex items-center gap-4">
            <select id="expiryTextSelect" class="w-full sm:w-auto p-2 border border-gray-600 bg-gray-700 rounded-lg text-white">
              <option value="5">5 Menit</option>
              <option value="15">15 Menit</option>
              <option value="30">30 Menit</option>
              <option value="60">1 Jam</option>
              <option value="240">4 Jam</option>
              <option value="1440">1 Hari</option>
            </select>
            <button id="uploadTextButton" disabled class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 opacity-50 cursor-not-allowed">
              Unggah Teks
            </button>
          </div>
        </div>
        <!-- Checkbox untuk mengunggah ke ID server yang dimasukkan -->
        <div class="mt-6 flex flex-col items-center">
            <div class="checkbox-container">
                <input type="checkbox" id="useInputServerId" class="form-checkbox text-blue-600 h-5 w-5 rounded-md focus:ring-blue-500">
                <label for="useInputServerId" class="text-sm sm:text-base text-gray-300">Unggah ke ID Server yang dimasukkan</label>
            </div>
        </div>
      </div>
    </div>
    <!-- Message box (untuk error/detailed info) -->
    <div id="messageBox" class="custom-confirm-modal hidden">
      <div class="bg-gray-800 rounded-xl p-6 shadow-2xl max-w-lg text-center w-full border border-gray-700">
        <h3 class="text-xl font-bold mb-4 text-white">Pesan Aplikasi</h3>
        <pre id="messageText" class="text-left text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto bg-gray-700 p-3 rounded-md border border-gray-600 text-gray-200"></pre>
        <div class="mt-6 flex justify-center">
          <button id="messageCloseBtn" class="bg-gray-700 text-gray-200 font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Tutup</button>
        </div>
      </div>
    </div>
    <!-- Daftar file -->
    <div class="mt-8">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-3 gap-2">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-200">Daftar file diserver</h2>
        <div class="items-center gap-2">
          <span id="listStatus" class="text-sm text-gray-400"></span>
        </div>
      </div>
      <!-- Kontainer responsif untuk tabel -->
      <div class="overflow-x-auto rounded-lg border border-gray-700 shadow-sm">
        <table class="w-full table-auto border-collapse">
          <thead>
            <tr class="bg-gray-700 text-xs sm:text-sm text-gray-300">
              <th class="text-left p-3 border-b border-gray-700">ID Server</th>
              <th class="text-left p-3 border-b border-gray-700">Filename</th>
              <th class="text-left p-3 border-b border-gray-700">MIME</th>
              <th class="text-left p-3 border-b border-gray-700 whitespace-nowrap">Waktu Habis</th>
              <th class="p-3 border-b border-gray-700 whitespace-nowrap">Aksi</th>
            </tr>
          </thead>
          <tbody id="filesTbody" class="bg-gray-800 text-xs sm:text-sm divide-y divide-gray-700">
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
      <!-- Input untuk memasukkan server_id -->
      <div class="mt-4">
        <label for="serverIdInput" class="text-sm font-semibold text-gray-200">Masukkan ID Server:</label>
        <div class="flex flex-col sm:flex-row gap-2 mt-2">
          <input id="serverIdInput" type="text" placeholder="Ketik ID Server untuk memfilter..." class="w-full p-3 border border-gray-600 bg-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" />
          <button id="filterServerIdButton" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
            Filter
          </button>
        </div>
      </div>
    </div>
    <!-- QR Code -->
    <div class="mt-8 flex flex-col items-center">
      <h3 class="text-lg font-semibold text-gray-200 mb-4"> ID Server saat ini: <span id="currentServerId"></span></h3>
      <div id="qrCodeContainer" class="p-2 bg-white rounded-lg shadow-md"></div>
    </div>
  </div>
  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://nqvgnmmvlfogouvdxkkr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xdmdubW12bGZvZ291dmR4a2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTEzMTgsImV4cCI6MjA3MTk2NzMxOH0.rliklScLWkzcC_qVNsCEus9b96DTravbfnfCILQXBWQ';
    const MAX_SAFE_SIZE_BYTES = 100 * 1024 * 1024; // 100 MB
    // =================
    // Inisialisasi Supabase Client
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const expiryTimeSelect = document.getElementById('expiryTimeSelect');
    const expiryTextSelect = document.getElementById('expiryTextSelect');
    const uploadButton = document.getElementById('uploadButton');
    const uploadTextButton = document.getElementById('uploadTextButton');
    const openUploadPopupBtn = document.getElementById('openUploadPopupBtn');
    const closeUploadPopupBtn = document.getElementById('closeUploadPopupBtn');
    const uploadPopup = document.getElementById('uploadPopup');
    const fileSummary = document.getElementById('fileSummary');
    const imgThumb = document.getElementById('imgThumb');
    const videoThumb = document.getElementById('videoThumb');
    const summaryName = document.getElementById('summaryName');
    const summarySize = document.getElementById('summarySize');
    const summaryMime = document.getElementById('summaryMime');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageCloseBtn = document.getElementById('messageCloseBtn');
    const listStatus = document.getElementById('listStatus');
    const filesTbody = document.getElementById('filesTbody');
    const serverIdInput = document.getElementById('serverIdInput');
    const filterServerIdButton = document.getElementById('filterServerIdButton');
    const currentServerIdDisplay = document.getElementById('currentServerId');
    const useInputServerIdCheckbox = document.getElementById('useInputServerId');
    const textInput = document.getElementById('textInput');
    let currentBase64 = '';
    let currentFileName = '';
    let currentMime = '';
    let sessionServerId = ''; // Store session-wide server_id
    let filterServerId = ''; // Store the user-entered server_id for filtering
    const countdownIntervals = {};
    // Function to generate random server_id
    function generateServerId() {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return result;
    }
    function showMessage(text) {
      messageText.textContent = text;
      messageBox.classList.remove('hidden');
    }
    function closeMessageBox() {
      messageBox.classList.add('hidden');
    }
    messageCloseBtn.addEventListener('click', closeMessageBox);
    openUploadPopupBtn.addEventListener('click', () => {
      uploadPopup.classList.remove('hidden');
    });
    closeUploadPopupBtn.addEventListener('click', () => {
      uploadPopup.classList.add('hidden');
    });
    fileInput.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) { resetSelection(); return; }
      fileInputLabel.textContent = file.name;
      const objectUrl = URL.createObjectURL(file);
      summaryName.textContent = file.name;
      summarySize.textContent = `Ukuran: ${formatBytes(file.size)}`;
      summaryMime.textContent = `MIME: ${file.type || 'unknown'}`;
      fileSummary.classList.remove('hidden');
      if (file.type.startsWith('image/')) {
        imgThumb.src = objectUrl;
        imgThumb.classList.remove('hidden');
        videoThumb.classList.add('hidden');
        videoThumb.pause();
        videoThumb.removeAttribute('src');
      } else if (file.type.startsWith('video/')) {
        videoThumb.src = objectUrl;
        videoThumb.classList.remove('hidden');
        imgThumb.classList.add('hidden');
        imgThumb.src = '';
      } else {
        imgThumb.src = '';
        imgThumb.classList.add('hidden');
        videoThumb.classList.add('hidden');
      }
      if (file.size > MAX_SAFE_SIZE_BYTES) {
        const ok = await new Promise((resolve) => {
          const message = `File lebih besar dari ${formatBytes(MAX_SAFE_SIZE_BYTES)}. Membaca & mengupload file besar dapat memakan waktu / kuota. Lanjutkan?`;
          showMessage(message);
          const closeBtn = messageBox.querySelector('#messageCloseBtn');
          const confirmBtn = document.createElement('button');
          confirmBtn.textContent = "Lanjutkan";
          confirmBtn.className = "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors ml-2";
          messageBox.querySelector('.mt-6').appendChild(confirmBtn);
          confirmBtn.addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(confirmBtn);
            closeMessageBox();
            resolve(true);
          }, { once: true });
          closeBtn.addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(confirmBtn);
            closeMessageBox();
            resolve(false);
          }, { once: true });
        });
        if (!ok) { resetSelection(); return; }
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        currentBase64 = e.target.result;
        currentFileName = file.name || `file_${Date.now()}`;
        currentMime = file.type || 'application/octet-stream';
        uploadButton.disabled = false;
        uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
      };
      reader.onerror = () => {
        showMessage('Gagal membaca file. Coba lagi.');
        resetSelection();
      };
      reader.readAsDataURL(file);
    });
    textInput.addEventListener('input', () => {
      if (textInput.value.trim().length > 0) {
        uploadTextButton.disabled = false;
        uploadTextButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        uploadTextButton.disabled = true;
        uploadTextButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    });
    function resetSelection() {
      currentBase64 = '';
      currentFileName = '';
      currentMime = '';
      fileSummary.classList.add('hidden');
      imgThumb.src = '';
      imgThumb.classList.add('hidden');
      videoThumb.pause();
      videoThumb.removeAttribute('src');
      videoThumb.classList.add('hidden');
      summaryName.textContent = '';
      summarySize.textContent = '';
      summaryMime.textContent = '';
      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
      fileInput.value = '';
      fileInputLabel.textContent = "Pilih File";
    }
    function formatBytes(bytes, decimals = 2) {
      if (!bytes) return '0 B';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    uploadButton.addEventListener('click', async () => {
      if (!currentBase64) { showMessage('Tidak ada data untuk diunggah. Pilih file terlebih dahulu.'); return; }
      const base64Data = currentBase64.split(',')[1];
      const expirationMinutes = parseInt(expiryTimeSelect.value, 10);
      let targetServerId = sessionServerId;
      if (useInputServerIdCheckbox.checked) {
        const inputId = serverIdInput.value.trim();
        if (inputId) {
          targetServerId = inputId;
        } else {
          showMessage('Silakan masukkan ID Server tujuan di kotak input di bawah.');
          return;
        }
      }
      await performUpload(currentFileName, currentMime, base64Data, expirationMinutes, uploadButton, targetServerId);
    });
    uploadTextButton.addEventListener('click', async () => {
      const text = textInput.value.trim();
      if (!text) {
        showMessage('Kotak teks kosong. Silakan ketik sesuatu untuk diunggah.');
        return;
      }
      const fileName = `text_${Date.now()}.txt`;
      const mimeType = 'text/plain';
      const base64Data = btoa(text);
      const expirationMinutes = parseInt(expiryTextSelect.value, 10);
      let targetServerId = sessionServerId;
      if (useInputServerIdCheckbox.checked) {
        const inputId = serverIdInput.value.trim();
        if (inputId) {
          targetServerId = inputId;
        } else {
          showMessage('Silakan masukkan ID Server tujuan di kotak input di bawah.');
          return;
        }
      }
      await performUpload(fileName, mimeType, base64Data, expirationMinutes, uploadTextButton, targetServerId);
      textInput.value = '';
      uploadTextButton.disabled = true;
      uploadTextButton.classList.add('opacity-50', 'cursor-not-allowed');
    });
    async function performUpload(filename, mimeType, base64Data, expirationMinutes, btn, serverIdToUse) {
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      const prevText = btn.textContent;
      btn.textContent = 'Mengunggah...';
      const expiresAt = new Date(new Date().getTime() + expirationMinutes * 60 * 1000).toISOString();
      try {
        const { data, error } = await supabaseClient
          .from('images')
          .insert([{ filename, mime_type: mimeType, base64: base64Data, server_id: serverIdToUse, expires_at: expiresAt }]);
        if (error) {
          showMessage(`Gagal unggah: ${error.message}`);
        } else {
          listStatus.textContent = 'Unggah sukses';
          setTimeout(() => { if (listStatus.textContent === 'Unggah sukses') listStatus.textContent = ''; }, 3000);
          if (btn === uploadButton) {
            resetSelection();
          }
        }
      } catch (err) {
        showMessage('Kesalahan jaringan: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.textContent = prevText;
      }
    }
    function startCountdown(fileId, expiresAt) {
      const row = document.querySelector(`tr[data-id="${fileId}"]`);
      if (!row) return;
      const timerElement = row.querySelector('.countdown-timer');
      if (!timerElement) return;
      
      const expirationTime = new Date(expiresAt).getTime();
      
      // Clear existing interval to prevent duplicates
      if (countdownIntervals[fileId]) {
        clearInterval(countdownIntervals[fileId]);
      }
      
      countdownIntervals[fileId] = setInterval(async () => {
        const now = new Date().getTime();
        const distance = expirationTime - now;
        
        if (distance < 0) {
          clearInterval(countdownIntervals[fileId]);
          timerElement.textContent = 'Menghapus...';
          await deleteFile(fileId, null); // Call delete function on expiration
          return;
        }
        
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        timerElement.textContent = `(${minutes}m ${seconds}s)`;
      }, 1000);
    }
    
    async function fetchFiles() {
      listStatus.textContent = 'Memuat...';
      filesTbody.innerHTML = '';
      // Clear all countdown intervals
      for (const id in countdownIntervals) {
          clearInterval(countdownIntervals[id]);
      }
      try {
        let query = supabaseClient
          .from('images')
          .select('id,server_id,filename,mime_type,created_at,expires_at')
          .order('created_at', { ascending: false });
        // Filter by sessionServerId if no filterServerId is set, otherwise filter by filterServerId
        if (filterServerId) {
          query = query.eq('server_id', filterServerId);
        } else {
          query = query.eq('server_id', sessionServerId);
        }
        const { data: files, error } = await query;
        if (error) {
          showMessage(`Gagal mengambil daftar file: ${error.message}`);
          listStatus.textContent = 'Gagal';
          return;
        }
        if (!Array.isArray(files) || files.length === 0) {
          filesTbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada file untuk ID Server ini.</td></tr>`;
          listStatus.textContent = 'Selesai';
          return;
        }
        filesTbody.innerHTML = files.map(f => {
          return `
            <tr data-id="${f.id}" class="hover:bg-gray-700 transition-colors">
              <td class="p-3 break-words text-gray-200">${escapeHtml(f.server_id || '')}</td>
              <td class="p-3 break-words text-gray-200">${escapeHtml(f.filename)}</td>
              <td class="p-3 break-words text-gray-400">${escapeHtml(f.mime_type || '')}</td>
              <td class="p-3 whitespace-nowrap text-gray-400">
                <span class="countdown-timer"></span>
              </td>
              <td class="p-3">
                <div class="flex flex-col sm:flex-row gap-2 items-center">
                  <button data-id="${f.id}" class="viewBtn bg-green-500 text-white px-3 py-1.5 rounded-md text-sm hover:bg-green-600 transition-colors">Lihat</button>
                  <button data-id="${f.id}" class="deleteBtn bg-red-500 text-white px-3 py-1.5 rounded-md text-sm hover:bg-red-600 transition-colors">Hapus</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        // Start countdown for each file
        files.forEach(f => {
          startCountdown(f.id, f.expires_at);
        });
        
        listStatus.textContent = `Terlihat ${files.length} file`;
      } catch (err) {
        showMessage('Kesalahan saat mengambil daftar: ' + err.message);
        listStatus.textContent = 'Gagal';
      }
    }
    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }
    filesTbody.addEventListener('click', async (ev) => {
      const viewBtn = ev.target.closest('.viewBtn');
      if (viewBtn) {
        const id = viewBtn.dataset.id;
        await viewFile(id);
        return;
      }
      const deleteBtn = ev.target.closest('.deleteBtn');
      if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        const ok = await new Promise((resolve) => {
          const message = "Hapus file ini dari database? Tindakan tidak dapat dibatalkan.";
          showMessage(message);
          messageBox.querySelector('#messageCloseBtn').textContent = "Batal";
          const deleteConfirmBtn = document.createElement('button');
          deleteConfirmBtn.textContent = "Hapus";
          deleteConfirmBtn.className = "bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors ml-2";
          messageBox.querySelector('.mt-6').appendChild(deleteConfirmBtn);
          deleteConfirmBtn.addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(deleteConfirmBtn);
            messageBox.querySelector('#messageCloseBtn').textContent = "Tutup";
            closeMessageBox();
            resolve(true);
          });
          messageBox.querySelector('#messageCloseBtn').addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(deleteConfirmBtn);
            messageBox.querySelector('#messageCloseBtn').textContent = "Tutup";
            closeMessageBox();
            resolve(false);
          }, { once: true });
        });
        if (ok) {
          await deleteFile(id, deleteBtn);
        }
        return;
      }
    });
    async function viewFile(id) {
      try {
        const { data: rows, error } = await supabaseClient
          .from('images')
          .select('base64,mime_type,filename')
          .eq('id', id)
          .limit(1);
        if (error) {
          showMessage(`Gagal mengambil file: ${error.message}`);
          return;
        }
        if (!rows || rows.length === 0) { showMessage('Data file tidak ditemukan.'); return; }
        const row = rows[0];
        const dataUri = `data:${row.mime_type || 'application/octet-stream'};base64,${row.base64}`;
        const w = window.open();
        try {
          w.document.write(`<title>${escapeHtml(row.filename || 'file')}</title>`);
          if ((row.mime_type || '').startsWith('image/')) {
            w.document.write(`<img src="${dataUri}" style="max-width:100%;height:auto;display:block;margin:0 auto" />`);
          } else if ((row.mime_type || '').startsWith('video/')) {
            w.document.write(`<video controls src="${dataUri}" style="width:100%;height:auto;display:block;margin:0 auto"></video>`);
          } else if ((row.mime_type || '').startsWith('text/')) {
            const textContent = atob(row.base64);
            w.document.write(`<pre style="font-family:monospace; white-space:pre-wrap; word-wrap:break-word; padding:1rem; background-color:#2a3443; color:white; border-radius:8px;">${escapeHtml(textContent)}</pre>`);
          } else {
            w.document.write(`<a href="${dataUri}" download="${escapeHtml(row.filename || 'file')}">Unduh file</a>`);
          }
        } catch (e) {
          const a = document.createElement('a');
          a.href = dataUri;
          a.download = row.filename || 'file';
          a.click();
        }
      } catch (err) {
        showMessage('Kesalahan saat mengambil file: ' + err.message);
      }
    }
    async function deleteFile(id, btnElement) {
      if (btnElement) {
        btnElement.disabled = true;
        const prev = btnElement.textContent;
        btnElement.textContent = 'Menghapus...';
      }
      try {
        const { error } = await supabaseClient
          .from('images')
          .delete()
          .eq('id', id);
        if (error) {
          showMessage(`Gagal menghapus: ${error.message}`);
        } else {
          listStatus.textContent = 'Hapus sukses';
          setTimeout(() => { if (listStatus.textContent === 'Hapus sukses') listStatus.textContent = ''; }, 3000);
        }
      } catch (err) {
        showMessage('Kesalahan saat menghapus: ' + err.message);
      } finally {
        if (btnElement) {
          btnElement.disabled = false;
          btnElement.textContent = 'Hapus';
        }
      }
    }
    // Filter files by server_id
    filterServerIdButton.addEventListener('click', () => {
      filterServerId = serverIdInput.value.trim();
      if (!filterServerId) {
        filterServerId = sessionServerId; // Revert to sessionServerId if input is empty
        serverIdInput.value = '';
      }
      fetchFiles();
    });
    // Allow Enter key to trigger filter
    serverIdInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        filterServerId = serverIdInput.value.trim();
        if (!filterServerId) {
          filterServerId = sessionServerId;
          serverIdInput.value = '';
        }
        fetchFiles();
      }
    });
    async function init() {
      // Generate session-wide server_id
      sessionServerId = generateServerId();
      currentServerIdDisplay.textContent = sessionServerId;
      
      supabaseClient
        .channel('images_channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'images' }, payload => {
          fetchFiles();
        })
        .subscribe();
      
      fetchFiles();
      
      const qrCodeContainer = document.getElementById('qrCodeContainer');
      new QRCode(qrCodeContainer, {
        text: `https://asmdatabase.vercel.app/KirimFile.html?server_id=${sessionServerId}`,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
      // Check for server_id in URL query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const urlServerId = urlParams.get('server_id');
      if (urlServerId) {
        filterServerId = urlServerId;
        serverIdInput.value = urlServerId;
        fetchFiles();
      }
    }
    init();
  </script>
</body>
</html>

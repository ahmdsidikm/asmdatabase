<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unggah Gambar/Video/Teks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JavaScript Client Library, dibutuhkan untuk fitur real-time -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    /* Pastikan tabel tidak meluap di perangkat kecil */
    .table-container { overflow-x: auto; }
    /* Style kustom untuk placeholder file input */
    input[type="file"]::file-selector-button {
      background-color: #e5e7eb;
      color: #374151;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    input[type="file"]::file-selector-button:hover {
      background-color: #d1d5db;
    }
    /* Sembunyikan konfirmasi bawaan browser */
    .custom-confirm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      transition: opacity 0.3s ease-in-out;
    }
    .custom-confirm-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }
    /* Style kustom untuk tombol pilih file */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      cursor: pointer;
      font-weight: 500;
    }
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: inherit;
      width: 100%;
      height: 100%;
    }
    .file-input-label {
      display: inline-block;
      padding: 0.5rem 1.5rem;
      border-radius: 0.5rem;
      background-color: #3b82f6; /* Warna biru */
      color: white;
      transition: background-color 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .file-input-label:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4 sm:p-6">
  <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-sm md:max-w-4xl border border-gray-200">
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2 sm:mb-4">Unggah Gambar, Video, & Teks ke Supabase</h1>
    <p class="text-center text-gray-600 text-sm sm:text-base mb-4 sm:mb-6">
      Pilih gambar atau video, atau ketik teks untuk diunggah.
    </p>

    <!-- Tombol untuk menyembunyikan/menampilkan area unggahan -->
    <div class="flex justify-center mb-6">
      <button id="toggleUploadsButton" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
        Tampilkan Unggahan
      </button>
    </div>

    <!-- Area untuk upload file dan teks -->
    <div id="uploadAreasContainer" class="hidden">
      <!-- Upload area for Files -->
      <div id="fileUploadArea" class="space-y-4">
        <div class="flex flex-col sm:flex-row gap-4 items-center">
          <!-- Tombol Pilih File -->
          <div class="file-input-wrapper flex-1">
            <span id="fileInputLabel" class="file-input-label w-full block sm:inline-block">Pilih File</span>
            <input id="fileInput" type="file" accept="image/*,video/*" />
          </div>
          <button id="uploadButton" disabled class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 opacity-50 cursor-not-allowed">
            Unggah File
          </button>
        </div>
        
        <!-- Ringkasan file terpilih (responsif) -->
        <div id="fileSummary" class="hidden flex-col sm:flex-row items-center gap-4 p-4 border border-blue-200 rounded-lg bg-blue-50 transition-all duration-300">
          <div class="flex-shrink-0">
            <img id="imgThumb" alt="thumbnail" class="w-28 h-28 object-cover rounded-lg border border-blue-300 shadow-sm hidden" />
            <video id="videoThumb" controls class="w-28 h-28 sm:w-48 sm:h-28 rounded-lg border border-blue-300 shadow-sm hidden"></video>
          </div>
          <div class="flex-1 text-center sm:text-left">
            <div id="summaryName" class="font-bold text-gray-800 break-words"></div>
            <div id="summarySize" class="text-sm text-gray-600 mt-1"></div>
            <div id="summaryMime" class="text-sm text-gray-600 mt-1"></div>
          </div>
        </div>
      </div>

      <!-- Upload area for Text -->
      <div id="textUploadArea" class="mt-8 space-y-4">
        <h2 class="text-lg font-semibold text-gray-800">Unggah Teks</h2>
        <textarea id="textInput" rows="5" placeholder="Ketik teks yang ingin diunggah di sini..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"></textarea>
        <button id="uploadTextButton" disabled class="w-full bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 opacity-50 cursor-not-allowed">
          Unggah Teks
        </button>
      </div>
    </div>

    <!-- Message box (untuk error/detailed info) -->
    <div id="messageBox" class="custom-confirm-modal hidden">
      <div class="bg-white rounded-xl p-6 shadow-2xl max-w-lg text-center w-full border border-gray-200">
        <h3 class="text-xl font-bold mb-4 text-gray-800">Pesan Aplikasi</h3>
        <pre id="messageText" class="text-left text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200"></pre>
        <div class="mt-6 flex justify-center">
          <button id="messageCloseBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">Tutup</button>
        </div>
      </div>
    </div>

    <!-- Daftar file -->
    <div class="mt-8">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-3 gap-2">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">Daftar file diserver</h2>
        <div class="flex items-center gap-2">
          <span id="listStatus" class="text-sm text-gray-500"></span>
        </div>
      </div>

      <!-- Kontainer responsif untuk tabel -->
      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="w-full table-auto border-collapse">
          <thead>
            <tr class="bg-gray-100 text-xs sm:text-sm text-gray-600">
              <th class="text-left p-3 border-b border-gray-200">Filename</th>
              <th class="text-left p-3 border-b border-gray-200">MIME</th>
              <th class="text-left p-3 border-b border-gray-200 whitespace-nowrap">Dibuat Pada</th>
              <th class="p-3 border-b border-gray-200 whitespace-nowrap">Aksi</th>
            </tr>
          </thead>
          <tbody id="filesTbody" class="bg-white text-xs sm:text-sm divide-y divide-gray-200">
            <!-- Rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIG ====
    const SUPABASE_URL = 'https://nqvgnmmvlfogouvdxkkr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xdmdubW12bGZvZ291dmR4a2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTEzMTgsImV4cCI6MjA3MTk2NzMxOH0.rliklScLWkzcC_qVNsCEus9b96DTravbfnfCILQXBWQ';
    const MAX_SAFE_SIZE_BYTES = 100 * 1024 * 1024; // 100 MB - tunable
    // =================
    
    // Inisialisasi Supabase Client
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const uploadButton = document.getElementById('uploadButton');
    const textInput = document.getElementById('textInput');
    const uploadTextButton = document.getElementById('uploadTextButton');
    const toggleUploadsButton = document.getElementById('toggleUploadsButton');
    const uploadAreasContainer = document.getElementById('uploadAreasContainer');

    const fileSummary = document.getElementById('fileSummary');
    const imgThumb = document.getElementById('imgThumb');
    const videoThumb = document.getElementById('videoThumb');
    const summaryName = document.getElementById('summaryName');
    const summarySize = document.getElementById('summarySize');
    const summaryMime = document.getElementById('summaryMime');

    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageCloseBtn = document.getElementById('messageCloseBtn');

    const listStatus = document.getElementById('listStatus');
    const filesTbody = document.getElementById('filesTbody');

    // Base64 only in JS variable (never rendered)
    let currentBase64 = '';
    let currentFileName = '';
    let currentMime = '';

    function showMessage(text) {
      messageText.textContent = text;
      messageBox.classList.remove('hidden');
    }
    function closeMessageBox() {
      messageBox.classList.add('hidden');
    }
    messageCloseBtn.addEventListener('click', closeMessageBox);

    // Toggle logic for upload areas
    toggleUploadsButton.addEventListener('click', () => {
      uploadAreasContainer.classList.toggle('hidden');
      if (uploadAreasContainer.classList.contains('hidden')) {
        toggleUploadsButton.textContent = 'Tampilkan Unggahan';
      } else {
        toggleUploadsButton.textContent = 'Sembunyikan Unggahan';
      }
    });

    // File selection: preview via object URL, then read as dataURL into currentBase64
    fileInput.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) { resetSelection(); return; }

      fileInputLabel.textContent = file.name;

      // show lightweight preview
      const objectUrl = URL.createObjectURL(file);
      summaryName.textContent = file.name;
      summarySize.textContent = `Ukuran: ${formatBytes(file.size)}`;
      summaryMime.textContent = `MIME: ${file.type || 'unknown'}`;
      fileSummary.classList.remove('hidden');

      if (file.type.startsWith('image/')) {
        imgThumb.src = objectUrl;
        imgThumb.classList.remove('hidden');
        videoThumb.classList.add('hidden');
        videoThumb.pause();
        videoThumb.removeAttribute('src');
      } else if (file.type.startsWith('video/')) {
        videoThumb.src = objectUrl;
        videoThumb.classList.remove('hidden');
        imgThumb.classList.add('hidden');
        imgThumb.src = '';
      } else {
        // generic fallback
        imgThumb.src = '';
        imgThumb.classList.add('hidden');
        videoThumb.classList.add('hidden');
      }

      // If file very large, confirm
      if (file.size > MAX_SAFE_SIZE_BYTES) {
          // Using custom modal instead of confirm()
        const ok = await new Promise((resolve) => {
            const message = `File lebih besar dari ${formatBytes(MAX_SAFE_SIZE_BYTES)}. Membaca & mengupload file besar dapat memakan waktu / kuota. Lanjutkan?`;
            showMessage(message);
            const closeBtn = messageBox.querySelector('#messageCloseBtn');
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = "Lanjutkan";
            confirmBtn.className = "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors ml-2";
            messageBox.querySelector('.mt-6').appendChild(confirmBtn);

            confirmBtn.addEventListener('click', () => {
                messageBox.querySelector('.mt-6').removeChild(confirmBtn);
                closeMessageBox();
                resolve(true);
            }, { once: true });
            closeBtn.addEventListener('click', () => {
                messageBox.querySelector('.mt-6').removeChild(confirmBtn);
                closeMessageBox();
                resolve(false);
            }, { once: true });
        });
        if (!ok) { resetSelection(); return; }
      }

      // Read DataURL into JS variable only (may be heavy for video)
      const reader = new FileReader();
      reader.onload = (e) => {
        currentBase64 = e.target.result; // data:[mime];base64,....
        currentFileName = file.name || `file_${Date.now()}`;
        currentMime = file.type || 'application/octet-stream';
        uploadButton.disabled = false;
        uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
      };
      reader.onerror = () => {
        showMessage('Gagal membaca file. Coba lagi.');
        resetSelection();
      };
      reader.readAsDataURL(file);
    });
    
    // Listen for text input to enable/disable button
    textInput.addEventListener('input', () => {
      if (textInput.value.trim().length > 0) {
        uploadTextButton.disabled = false;
        uploadTextButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        uploadTextButton.disabled = true;
        uploadTextButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    });

    function resetSelection() {
      currentBase64 = '';
      currentFileName = '';
      currentMime = '';
      fileSummary.classList.add('hidden');
      imgThumb.src = '';
      imgThumb.classList.add('hidden');
      videoThumb.pause();
      videoThumb.removeAttribute('src');
      videoThumb.classList.add('hidden');
      summaryName.textContent = '';
      summarySize.textContent = '';
      summaryMime.textContent = '';
      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
      fileInput.value = '';
      fileInputLabel.textContent = "Pilih File";
    }

    function formatBytes(bytes, decimals = 2) {
      if (!bytes) return '0 B';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Upload file handler
    uploadButton.addEventListener('click', async () => {
      if (!currentBase64) { showMessage('Tidak ada data untuk diunggah. Pilih file terlebih dahulu.'); return; }
      
      const base64Data = currentBase64.split(',')[1];
      await performUpload(currentFileName, currentMime, base64Data, uploadButton);
    });
    
    // Upload text handler
    uploadTextButton.addEventListener('click', async () => {
      const text = textInput.value.trim();
      if (!text) {
        showMessage('Kotak teks kosong. Silakan ketik sesuatu untuk diunggah.');
        return;
      }
      
      const fileName = `text_${Date.now()}.txt`;
      const mimeType = 'text/plain';
      const base64Data = btoa(text); // Mengubah teks menjadi base64

      await performUpload(fileName, mimeType, base64Data, uploadTextButton);
      textInput.value = '';
      uploadTextButton.disabled = true;
      uploadTextButton.classList.add('opacity-50', 'cursor-not-allowed');
    });
    
    async function performUpload(filename, mimeType, base64Data, btn) {
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      const prevText = btn.textContent;
      btn.textContent = 'Mengunggah...';

      try {
        const { data, error } = await supabaseClient
          .from('images')
          .insert([{ filename: filename, mime_type: mimeType, base64: base64Data }]);

        if (error) {
          showMessage(`Gagal unggah: ${error.message}`);
        } else {
          listStatus.textContent = 'Unggah sukses';
          setTimeout(() => { if (listStatus.textContent === 'Unggah sukses') listStatus.textContent = ''; }, 3000);
          if (btn === uploadButton) {
            resetSelection();
          }
        }
      } catch (err) {
        showMessage('Kesalahan jaringan: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.textContent = prevText;
      }
    }

    // --- Fetch file list (no base64) ---
    async function fetchFiles() {
      listStatus.textContent = 'Memuat...';
      filesTbody.innerHTML = '';
      try {
        const { data: files, error } = await supabaseClient
          .from('images')
          .select('id,filename,mime_type,created_at')
          .order('created_at', { ascending: false });

        if (error) {
          showMessage(`Gagal mengambil daftar file: ${error.message}`);
          listStatus.textContent = 'Gagal';
          return;
        }

        if (!Array.isArray(files) || files.length === 0) {
          filesTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Belum ada file.</td></tr>`;
          listStatus.textContent = 'Selesai';
          return;
        }

        filesTbody.innerHTML = files.map(f => {
          const created = f.created_at ? (new Date(f.created_at)).toLocaleString() : '-';
          return `
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="p-3 break-words">${escapeHtml(f.filename)}</td>
              <td class="p-3 break-words">${escapeHtml(f.mime_type || '')}</td>
              <td class="p-3 whitespace-nowrap">${escapeHtml(created)}</td>
              <td class="p-3">
                <div class="flex flex-col sm:flex-row gap-2 items-center">
                  <button data-id="${f.id}" class="viewBtn bg-green-500 text-white px-3 py-1.5 rounded-md text-sm hover:bg-green-600 transition-colors">Lihat</button>
                  <button data-id="${f.id}" class="deleteBtn bg-red-500 text-white px-3 py-1.5 rounded-md text-sm hover:bg-red-600 transition-colors">Hapus</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        listStatus.textContent = `Terlihat ${files.length} file`;
      } catch (err) {
        showMessage('Kesalahan saat mengambil daftar: ' + err.message);
        listStatus.textContent = 'Gagal';
      }
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // Event delegation for view & delete
    filesTbody.addEventListener('click', async (ev) => {
      const viewBtn = ev.target.closest('.viewBtn');
      if (viewBtn) {
        const id = viewBtn.dataset.id;
        await viewFile(id);
        return;
      }
      const deleteBtn = ev.target.closest('.deleteBtn');
      if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        // Ganti konfirmasi dengan custom modal
        const ok = await new Promise((resolve) => {
          const message = "Hapus file ini dari database? Tindakan tidak dapat dibatalkan.";
          showMessage(message);
          messageBox.querySelector('#messageCloseBtn').textContent = "Batal";
          const deleteConfirmBtn = document.createElement('button');
          deleteConfirmBtn.textContent = "Hapus";
          deleteConfirmBtn.className = "bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors ml-2";
          messageBox.querySelector('.mt-6').appendChild(deleteConfirmBtn);
          deleteConfirmBtn.addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(deleteConfirmBtn);
            messageBox.querySelector('#messageCloseBtn').textContent = "Tutup";
            closeMessageBox();
            resolve(true);
          });
          messageBox.querySelector('#messageCloseBtn').addEventListener('click', () => {
            messageBox.querySelector('.mt-6').removeChild(deleteConfirmBtn);
            messageBox.querySelector('#messageCloseBtn').textContent = "Tutup";
            closeMessageBox();
            resolve(false);
          }, { once: true });
        });
        if (ok) {
          await deleteFile(id, deleteBtn);
        }
        return;
      }
    });

    // --- View: fetch base64 from Supabase and open in new tab (works for images, videos & text) ---
    async function viewFile(id) {
      try {
        const { data: rows, error } = await supabaseClient
          .from('images')
          .select('base64,mime_type,filename')
          .eq('id', id)
          .limit(1);

        if (error) {
          showMessage(`Gagal mengambil file: ${error.message}`);
          return;
        }
        
        if (!rows || rows.length === 0) { showMessage('Data file tidak ditemukan.'); return; }
        const row = rows[0];
        const dataUri = `data:${row.mime_type || 'application/octet-stream'};base64,${row.base64}`;
        
        // Cek tipe MIME dan tampilkan dengan cara yang sesuai
        const w = window.open();
        try {
          w.document.write(`<title>${escapeHtml(row.filename || 'file')}</title>`);
          if ((row.mime_type || '').startsWith('image/')) {
            w.document.write(`<img src="${dataUri}" style="max-width:100%;height:auto;display:block;margin:0 auto" />`);
          } else if ((row.mime_type || '').startsWith('video/')) {
            w.document.write(`<video controls src="${dataUri}" style="width:100%;height:auto;display:block;margin:0 auto"></video>`);
          } else if ((row.mime_type || '').startsWith('text/')) {
            // Menampilkan konten teks
            const textContent = atob(row.base64);
            w.document.write(`<pre style="font-family:monospace; white-space:pre-wrap; word-wrap:break-word; padding:1rem; background-color:#f4f4f4; border-radius:8px;">${escapeHtml(textContent)}</pre>`);
          } else {
            // fallback: link download
            w.document.write(`<a href="${dataUri}" download="${escapeHtml(row.filename || 'file')}">Unduh file</a>`);
          }
        } catch (e) {
          // fallback: trigger download
          const a = document.createElement('a');
          a.href = dataUri;
          a.download = row.filename || 'file';
          a.click();
        }
      } catch (err) {
        showMessage('Kesalahan saat mengambil file: ' + err.message);
      }
    }

    // --- Delete file ---
    async function deleteFile(id, btnElement) {
      if (btnElement) {
        btnElement.disabled = true;
        const prev = btnElement.textContent;
        btnElement.textContent = 'Menghapus...';
      }
      try {
        const { data, error } = await supabaseClient
          .from('images')
          .delete()
          .eq('id', id);

        if (error) {
          showMessage(`Gagal menghapus: ${error.message}`);
        } else {
          listStatus.textContent = 'Hapus sukses';
          setTimeout(() => { if (listStatus.textContent === 'Hapus sukses') listStatus.textContent = ''; }, 3000);
        }
      } catch (err) {
        showMessage('Kesalahan saat menghapus: ' + err.message);
      } finally {
        if (btnElement) {
          btnElement.disabled = false;
          btnElement.textContent = 'Hapus';
        }
      }
    }

    // Inisialisasi: pasang listener real-time dan ambil daftar file awal
    async function init() {
      // Langganan (subscribe) ke event perubahan pada tabel 'images'
      supabaseClient
        .channel('images_channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'images' }, payload => {
          // Ketika ada perubahan (sisipkan, hapus, perbarui), muat ulang daftar
          fetchFiles();
        })
        .subscribe();
      
      // Ambil daftar file awal
      fetchFiles();
    }
    
    // Panggil fungsi inisialisasi
    init();

  </script>
</body>
</html>

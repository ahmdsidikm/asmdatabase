<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pemindai QR & Barcode (buka hasil di tab baru)</title>

<!-- Library untuk QR (jsQR) dan QR generator (qrious) -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<!-- Quagga untuk fallback decoding barcode 1D -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
/* ---------- Umum ---------- */
body {
    font-family: 'VT323', monospace;
    background: #d3d3d3;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
}
.container {
    background: #e0e0e0;
    border: 3px solid #808080;
    padding: 20px;
    box-shadow: 5px 5px 0px 0px rgba(0,0,0,0.75);
    max-width: 500px;
    width: 90%;
    text-align: center;
    border-radius: 0;
}
h1 { color: #333; margin: 0 0 12px 0; }

/* video + canvas */
#video-stream-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto 15px auto; }
#liveVideo { width: 100%; max-width: 400px; border: 2px solid #555; background: #000; margin: 0 auto; display: none; object-fit: cover; }
#snapshot { display: none; }

/* controls */
.controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
.controls .row { display:flex; gap:8px; justify-content:center; }
button, #fileInputBtn {
    padding: 12px; font-size: 1.05em; border: 2px solid #808080;
    background: #c0c0c0; color: #333; cursor: pointer; font-family: 'VT323', monospace;
    text-transform: uppercase; box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.75);
    transition: all 0.1s ease;
}
button[disabled], button.disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
button:hover:not([disabled]), #fileInputBtn:hover { background: #a0a0a0; transform: translate(1px, 1px); }
button:active:not([disabled]), #fileInputBtn:active { background: #909090; transform: translate(2px, 2px); }
input[type="file"] { display: none; }

/* output area */
#output {
    background: #000000;
    padding: 15px;
    border: 2px solid #808080;
    margin-top: 15px;
    font-size: 1.05em;
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00;
    min-height: 48px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: anywhere;
    word-break: break-word;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
    max-height: 200px;
    overflow-y: auto;
}

/* action buttons */
.action-buttons { display: flex; justify-content: space-between; gap: 10px; width: 100%; max-width: 360px; margin: 12px auto 0 auto; }
.action-buttons button { flex: 1 1 48%; display: inline-block; margin: 0; }

/* checkbox classic */
.checkbox-wrapper { margin-top: 10px; font-size: 1.1em; display:flex; justify-content:center; align-items:center; gap:8px; position: relative; }
.checkbox-wrapper input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; margin: 0; left: -9999px; }
.checkbox-wrapper label { position: relative; padding-left: 34px; cursor: pointer; user-select: none; color: #333; display: inline-block; line-height: 20px; font-size: 1.05em; }
.checkbox-wrapper label::before { content: ""; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; border: 2px solid #555; background: #ffffff; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); border-radius: 3px; }
.checkbox-wrapper label::after { content: ""; position: absolute; left: 6px; top: 50%; transform: translateY(-60%) rotate(45deg); width: 6px; height: 12px; border: solid #000; border-width: 0 2px 2px 0; opacity: 0; transition: opacity 0.08s ease; }
.checkbox-wrapper input[type="checkbox"]:checked + label::after { opacity: 1; }
.checkbox-wrapper label:hover::before { border-color: #333; }

/* Responsive kecil */
@media (max-width:420px) { button { font-size: 1em; padding:10px; } }

/* ---------- Modal (tetap ada di DOM tapi tidak digunakan untuk hasil gambar/video) ---------- */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.75); }
.modal.open { display: flex; align-items: center; justify-content: center; }
.modal-content {
    background-color: #e0e0e0;
    margin: 0 12px;
    padding: 12px;
    border: 2px solid #808080;
    text-align: center;
    border-radius: 6px;
    box-shadow: 5px 5px 0px 0px rgba(0,0,0,0.75);
    max-width: 98vw;
    width: auto;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    justify-content: center;
}

/* area konten hasil: agar bisa scroll jika konten lebih besar */
#resultContainer {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 100%;
    max-height: 85vh;        /* batasi tinggi modal konten */
    overflow: auto;          /* scroll jika perlu di device kecil */
    box-sizing: border-box;
    padding: 4px;
}

/* gaya untuk gambar & video di modal (responsif menurut viewport) */
#resultContainer img,
#resultContainer video {
    display: block;
    max-width: 95vw;      /* lebar maksimal relatif terhadap viewport */
    max-height: 85vh;     /* tinggi maksimal relatif terhadap viewport */
    width: auto;
    height: auto;
    object-fit: contain;
    border: 2px solid #555;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.6);
    border-radius: 4px;
}

/* tombol unduh & keluar di modal: tetap terlihat di bawah konten */
#downloadBtn, #closePageBtn {
    padding: 10px 14px;
    font-size: 1em;
    border: 2px solid #808080;
    background: #c0c0c0;
    color: #333;
    cursor: pointer;
    font-family: 'VT323', monospace;
    text-transform: uppercase;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.75);
}
.closeBtn { color: #333; position: absolute; top: 14px; right: 18px; font-size: 26px; font-weight: bold; cursor: pointer; }
.closeBtn:hover { color: #ff0000; }

/* Pastikan tombol close berada di atas layout */
.modal .closeBtn { z-index: 1010; }

/* baris tombol modal: buat Keluar di kiri dan Unduh di kanan */
#modalButtonRow { width: 100%; display:flex; justify-content:space-between; gap:12px; max-width:95%; box-sizing: border-box; }
#modalButtonRow button { flex: 1 1 auto; }

</style>
</head>
<body>

<div class="container">
    <h1>Pemindai QR & Barcode v3.1 â€” Open in New Tab</h1>
    <div id="video-stream-container">
        <video id="liveVideo" autoplay playsinline></video>
    </div>

    <canvas id="snapshot"></canvas>

    <div class="controls">
        <div class="row">
            <button id="startCameraButton">Nyalakan Kamera</button>
            <button id="flashlightBtn" disabled>Senter Tidak Tersedia</button>
        </div>
        <div class="row">
            <button id="fileInputBtn">Pilih Gambar</button>
            <input type="file" id="fileInput" accept="image/*">
            <button id="createQRBtn">Buat QR</button>
        </div>
    </div>

    <div class="checkbox-wrapper">
        <input type="checkbox" id="luckyCheck" />
        <label for="luckyCheck">Saya beruntung</label>
    </div>

    <div id="output">STATUS: SIAP</div>

    <div id="actionButtons" class="action-buttons" style="display: none;">
        <button id="copyTextBtn">Salin Teks</button>
        <button id="rightActionBtn">Aksi</button>
    </div>
</div>

<!-- Modal Pembuat Kode QR (tetap tersedia) -->
<div id="qrModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <span class="closeBtn" id="closeQRModal">&times;</span>
        <h2>Buat Kode QR</h2>
        <input type="text" id="qrText" placeholder="Masukkan teks/link..." style="width:90%; padding:10px; font-family: 'VT323'; font-size:1em; border: 2px solid #808080; background: #c0c0c0; color: #333;">
        <canvas id="qrCanvas"></canvas>
        <div style="width:100%;display:flex;justify-content:space-between;gap:12px;max-width:95%;box-sizing:border-box;">
            <button id="closeQRExitBtn">Keluar</button>
            <button id="downloadQRBtn">Unduh QR</button>
        </div>
    </div>
</div>

<!-- Modal Hasil (tidak akan dipakai untuk membuka gambar/video) -->
<div id="resultModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-label="Hasil Dekripsi">
        <div id="resultContainer" ></div>
        <div id="modalButtonRow">
            <button id="closePageBtn" style="display:none;">Keluar</button>
            <button id="downloadBtn" style="display:none;">Unduh</button>
        </div>
    </div>
</div>

<script>
/* === Elemen DOM === */
const liveVideo = document.getElementById('liveVideo');
const snapshot = document.getElementById('snapshot');
const output = document.getElementById('output');
const fileInput = document.getElementById('fileInput');
const fileInputBtn = document.getElementById('fileInputBtn');
const startCameraButton = document.getElementById('startCameraButton');
const createQRBtn = document.getElementById('createQRBtn');

const flashlightBtn = document.getElementById('flashlightBtn');

const qrModal = document.getElementById('qrModal');
const closeQRModal = document.getElementById('closeQRModal');
const qrText = document.getElementById('qrText');
const qrCanvas = document.getElementById('qrCanvas');
const downloadQRBtn = document.getElementById('downloadQRBtn');
const closeQRExitBtn = document.getElementById('closeQRExitBtn');
if (closeQRExitBtn) closeQRExitBtn.addEventListener('click', () => { location.reload(); });

const resultModal = document.getElementById('resultModal');
const resultContainer = document.getElementById('resultContainer');
const downloadBtn = document.getElementById('downloadBtn');
const closePageBtn = document.getElementById('closePageBtn');

const actionButtons = document.getElementById('actionButtons');
const copyTextBtn = document.getElementById('copyTextBtn');
const rightActionBtn = document.getElementById('rightActionBtn');

const luckyCheck = document.getElementById('luckyCheck');

let stream = null, animationFrameId = null;
let lastDecodedData = null;
let lastDecodedDataLink = null;
let lastDecodedText = null;

let track = null;
let torchOn = false;

/* === Nada notifikasi (beep) === */
function playBeep() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(1.0, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.18);
    } catch (err) { console.error("Audio error:", err); }
}

/* === Caesar decipher === */
function caesarDecipher(str, shift) {
    let result = '';
    for (let i = 0; i < str.length; i++) {
        let code = str.charCodeAt(i);
        if (code >= 65 && code <= 90) result += String.fromCharCode((code - 65 - shift + 26) % 26 + 65);
        else if (code >= 97 && code <= 122) result += String.fromCharCode((code - 97 - shift + 26) % 26 + 97);
        else result += str[i];
    }
    return result;
}

/* === Tampilkan hasil dekripsi â€” versi baru: buka di tab baru, tanpa modal/popup === */
function showDecodedBase64(data) {
    output.textContent = '';
    resultContainer.innerHTML = '';
    lastDecodedData = null;
    downloadBtn.style.display = 'none';
    closePageBtn.style.display = 'none';
    actionButtons.style.display = 'none';
    lastDecodedDataLink = null;
    lastDecodedText = null;

    try {
        // Jika hasil adalah data:image atau data:video, buka langsung di tab baru dan refresh halaman
        if (data.startsWith('data:image/') || data.startsWith('data:video/')) {
            // Coba buka tab baru. Jika diblokir, beri notifikasi fallback.
            const win = window.open();
            if (!win) {
                output.textContent = "Gagal membuka tab baru (pop-up diblokir). Salin data atau gunakan tombol unduh sebagai fallback.";
                // Fallback: set hasil ke textarea untuk disalin (simple)
                lastDecodedText = data;
                actionButtons.style.display = 'flex';
                copyTextBtn.style.display = 'inline-block';
                rightActionBtn.style.display = 'none';
                return;
            }

            // Isi konten tab baru: untuk gambar atau video gunakan element HTML yang sesuai
            win.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Hasil â€” QR</title>' +
                               '<meta name="viewport" content="width=device-width,initial-scale=1">' +
                               '<style>body{margin:0;display:flex;align-items:center;justify-content:center;background:#111;color:#fff;height:100vh}img,video{max-width:100vw;max-height:100vh;object-fit:contain}</style>' +
                               '</head><body>');
            if (data.startsWith('data:image/')) {
                win.document.write('<img src="' + data + '" alt="Hasil gambar" />');
            } else {
                win.document.write('<video src="' + data + '" controls autoplay muted playsinline></video>');
            }
            win.document.write('</body></html>');
            win.document.close();

            // Setelah berhasil membuka tab baru â€” lakukan reload pada halaman saat ini.
            // Delay kecil agar browser punya waktu membuka tab baru.
            setTimeout(() => { try { location.reload(); } catch(e) { console.warn('Reload gagal:', e); } }, 600);
            return;
        } else {
            // untuk teks biasa/URL, pakai proses yang sudah ada
            processQRData(data);
        }
    } catch (err) {
        output.textContent = "GALAT saat membuka hasil: " + err;
    }
}

/* === Modal open/close helpers (tetap ada, tapi tidak dipakai untuk membuka gambar/video) === */
function openResultModal() {
    resultModal.classList.add('open');
    resultModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
}

function closeResultModalFunc() {
    resultModal.classList.remove('open');
    resultModal.setAttribute('aria-hidden', 'true');
    resultContainer.innerHTML = '';
    downloadBtn.style.display = 'none';
    closePageBtn.style.display = 'none';
    document.body.style.overflow = '';
}
resultModal.addEventListener('click', (e) => {
    if (e.target === resultModal) closeResultModalFunc();
});

/* tombol aksi salin / buka */
copyTextBtn.addEventListener('click', async () => {
    if(lastDecodedText) {
        try {
            await navigator.clipboard.writeText(lastDecodedText);
            output.textContent = "Teks berhasil disalin!";
            setTimeout(() => { output.textContent = lastDecodedText; }, 1500);
        } catch (e) {
            output.textContent = "Gagal menyalin. Silakan salin manual: " + lastDecodedText;
        }
    }
});
rightActionBtn.addEventListener('click', () => {
    if (lastDecodedDataLink) {
        window.open(lastDecodedDataLink, "_blank");
    } else if (lastDecodedText) {
        const q = encodeURIComponent(lastDecodedText);
        window.open(`https://www.google.com/search?q=${q}`, '_blank');
    }
});
downloadBtn.addEventListener('click', () => {
    if (!lastDecodedData) return;
    const a = document.createElement('a');
    a.href = lastDecodedData;
    a.download = lastDecodedData.startsWith('data:image/') ? 'hasil_terdekode.png' : 'hasil_terdekode';
    a.click();
});
closePageBtn.addEventListener('click', () => { location.reload(); });

/* === Penanganan upload file === */
fileInputBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    stopCamera();
    const reader = new FileReader();
    reader.onload = async ev => {
        const img = new Image();
        img.onload = async function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
            const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(imageData.data,imageData.width,imageData.height);
            if(code){
                playBeep();
                output.textContent="QR DITEMUKAN: "+code.data;
                processQRData(code.data);
                return;
            }
            output.textContent = "Mencoba deteksi barcode pada gambar...";
            try {
                const barcode = await tryDecodeBarcodeFromCanvas(canvas);
                if (barcode) {
                    playBeep();
                    output.textContent = "BARCODE DITEMUKAN: " + barcode;
                    processQRData(barcode);
                } else {
                    output.textContent = "Tidak ditemukan QR atau barcode pada gambar";
                    downloadBtn.style.display='none';
                    closePageBtn.style.display='none';
                    actionButtons.style.display='none';
                }
            } catch(err) {
                output.textContent = "GALAT: " + err;
            }
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

/* === Ambil & dekripsi helper === */
async function fetchAndDecrypt(link, shift) {
    try {
        output.textContent = "STATUS: MENGAMBIL DATA MENTAH...";
        let res = await fetch(link);
        if (!res.ok) throw new Error("HTTP " + res.status);
        let rawText = await res.text();
        let shifted = caesarDecipher(rawText, shift);
        showDecodedBase64(shifted);
    } catch (err) { output.textContent = "GALAT: " + err; }
}

/* === Camera start/stop + torch === */
function stopCamera() {
    if (stream) {
        if (torchOn && track) {
            try { track.applyConstraints({ advanced: [{ torch: false }] }); } catch(e) { /* ignore */ }
            torchOn = false;
            flashlightBtn.textContent = "Senter OFF";
        }
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        track = null;
    }
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
    liveVideo.pause();
    liveVideo.srcObject = null;
    liveVideo.style.display = 'none';
    startCameraButton.textContent = 'Nyalakan Kamera';
    flashlightBtn.disabled = true;
    flashlightBtn.textContent = 'Senter Tidak Tersedia';
}

async function startCamera() {
    stopCamera();
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
        liveVideo.srcObject = stream;
        track = stream.getVideoTracks()[0] || null;

        liveVideo.style.display = 'block';

        // cek kemampuan torch
        try {
            const caps = track && track.getCapabilities ? track.getCapabilities() : null;
            if (caps && caps.torch) {
                flashlightBtn.disabled = false;
                flashlightBtn.textContent = 'Senter OFF';
            } else {
                flashlightBtn.disabled = true;
                flashlightBtn.textContent = 'Senter Tidak Tersedia';
            }
        } catch (e) {
            flashlightBtn.disabled = true;
            flashlightBtn.textContent = 'Senter Tidak Tersedia';
        }

        liveVideo.play();
        startCameraButton.textContent = 'Matikan Kamera';
        output.textContent = "STATUS: KAMERA DINYALAKAN";
        scanQRCode();
    } catch (err) {
        output.textContent = "GALAT: " + err;
    }
}
function toggleCamera() { if (stream) stopCamera(); else startCamera(); }

/* Toggle flashlight */
flashlightBtn.addEventListener('click', async () => {
    if (!track) { output.textContent = "Senter tidak tersedia"; return; }
    try {
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        if (!caps.torch) { output.textContent = "Perangkat tidak mendukung senter"; return; }
        await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
        torchOn = !torchOn;
        flashlightBtn.textContent = torchOn ? "Senter ON" : "Senter OFF";
        output.textContent = torchOn ? "Senter: ON" : "Senter: OFF";
    } catch (err) {
        output.textContent = "Gagal mengubah senter: " + err;
    }
});

/* === Barcode detection helper (promisified) === */
function tryDecodeBarcodeFromCanvas(canvas) {
    return new Promise((resolve) => {
        if ('BarcodeDetector' in window) {
            try {
                const formats = ["code_128","code_39","code_93","ean_13","ean_8","upc_e","upc_a","itf","codabar"];
                const detector = new BarcodeDetector({ formats });
                detector.detect(canvas).then(results => {
                    if (results && results.length > 0) resolve(results[0].rawValue || null);
                    else resolve(null);
                }).catch(err => { console.warn("BarcodeDetector error:", err); resolve(null); });
                return;
            } catch (err) { console.warn("BarcodeDetector exception:", err); }
        }
        try {
            const src = canvas.toDataURL();
            if (window.Quagga && Quagga.decodeSingle) {
                Quagga.decodeSingle({
                    src,
                    numOfWorkers: 0,
                    inputStream: { size: 800 },
                    locator: { patchSize: "medium", halfSample: true },
                    decoder: {
                        readers: [
                            "code_128_reader","ean_reader","ean_8_reader","code_39_reader",
                            "upc_reader","upc_e_reader","codabar_reader","i2of5_reader"
                        ]
                    }
                }, function(result) {
                    if (result && result.codeResult && result.codeResult.code) resolve(result.codeResult.code);
                    else resolve(null);
                });
            } else {
                resolve(null);
            }
        } catch (err) {
            console.warn("Quagga fallback error:", err);
            resolve(null);
        }
    });
}

/* === Scan loop === */
function scanQRCode() {
    const ctx = snapshot.getContext('2d');

    async function tick() {
        if (!stream) return;
        if (liveVideo.readyState === liveVideo.HAVE_ENOUGH_DATA) {
            const w = liveVideo.videoWidth;
            const h = liveVideo.videoHeight;
            if (w === 0 || h === 0) { animationFrameId = requestAnimationFrame(tick); return; }

            snapshot.width = w; snapshot.height = h;

            ctx.drawImage(liveVideo, 0, 0, w, h);
            const imageData = ctx.getImageData(0, 0, w, h);

            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                playBeep();
                output.textContent = "QR DITEMUKAN: " + code.data;
                processQRData(code.data);
                stopCamera();
                return;
            }

            try {
                const barcode = await tryDecodeBarcodeFromCanvas(snapshot);
                if (barcode) {
                    playBeep();
                    output.textContent = "BARCODE DITEMUKAN: " + barcode;
                    processQRData(barcode);
                    stopCamera();
                    return;
                }
            } catch (err) { console.warn("Barcode check failed:", err); }
        }
        animationFrameId = requestAnimationFrame(tick);
    }
    tick();
}

/* === Process decoded data (text/link) === */
function processQRData(data) {
    lastDecodedData = null;
    downloadBtn.style.display = 'none';
    closePageBtn.style.display = 'none';
    actionButtons.style.display = 'none';
    lastDecodedDataLink = null;
    lastDecodedText = null;
    output.textContent = '';

    let parts = data.split("||").map(p => p.trim());

    if (luckyCheck.checked) {
        if (parts.length === 2 && parts[0].startsWith("http") && !isNaN(parseInt(parts[1]))) {
            fetchAndDecrypt(parts[0], parseInt(parts[1]));
            return;
        }
    }

    output.textContent = "" + data;
    lastDecodedText = data;

    if (data.startsWith("http://") || data.startsWith("https://")) {
        lastDecodedDataLink = data;
        actionButtons.style.display = 'flex';
        copyTextBtn.style.display = 'inline-block';
        rightActionBtn.style.display = 'inline-block';
        rightActionBtn.textContent = 'Buka Link';
        copyTextBtn.title = 'Salin hasil (link)';
        rightActionBtn.title = 'Buka link di tab baru';
    } else {
        actionButtons.style.display = 'flex';
        copyTextBtn.style.display = 'inline-block';
        rightActionBtn.style.display = 'inline-block';
        rightActionBtn.textContent = 'Cari di Google';
        copyTextBtn.title = 'Salin teks';
        rightActionBtn.title = 'Cari teks di Google';
    }
}

/* === Start/stop binding & QR generator === */
startCameraButton.addEventListener('click', toggleCamera);

/* QR generator modal */
createQRBtn.addEventListener('click', () => { qrModal.classList.add('open'); qrModal.style.display = 'flex'; generateQRFromInput(); });
closeQRModal.addEventListener('click', () => { qrModal.classList.remove('open'); qrModal.style.display = 'none'; });
qrText.addEventListener('input', generateQRFromInput);
function generateQRFromInput() {
    const text = qrText.value.trim() || " ";
    new QRious({
        element: qrCanvas,
        value: text,
        size: 300,
        level: 'H',
        background: '#e0e0e0',
        foreground: '#333333'
    });
}
downloadQRBtn.addEventListener('click', () => {
    const a = document.createElement('a');
    a.href = qrCanvas.toDataURL("image/png");
    a.download = 'kode_qr.png';
    a.click();
});

/* Close qr modal on overlay click */
window.addEventListener('click', (e) => {
    if (e.target === qrModal) { qrModal.classList.remove('open'); qrModal.style.display = 'none'; }
});

/* Tutup modal & restore scroll pada ESC */
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (resultModal.classList.contains('open')) closeResultModalFunc();
        if (qrModal.classList.contains('open')) { qrModal.classList.remove('open'); qrModal.style.display='none'; }
    }
});
</script>
</body>
</html>

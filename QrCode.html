<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Retro Gray QR Scanner + Caesar Decoder</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<style>
body {
    font-family: 'VT323', monospace;
    background: #282c34;
    color: #d8d8d8;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
}
.container {
    background: #1a1a1a;
    border: 3px solid #666;
    padding: 20px;
    box-shadow: 0 0 15px #d8d8d8, inset 0 0 10px #000;
    max-width: 500px;
    width: 90%;
    text-align: center;
    border-radius: 8px;
}
#video {
    width: 100%;
    max-width: 400px;
    border: 2px solid #555;
    background: #000;
    margin-bottom: 15px;
    filter: grayscale(100%) brightness(120%) contrast(150%);
}
#snapshot { display:none; }
.controls { display:flex; flex-direction:column; gap:10px; margin-bottom:20px;}
button, input[type="file"] {
    padding: 12px;
    font-size: 1.2em;
    border: 2px solid #777;
    background: #444;
    color: #d8d8d8;
    cursor: pointer;
    font-family: 'VT323', monospace;
    text-align: center;
}
#output {
    background: #1a1a1a;
    padding: 15px;
    border: 2px solid #777;
    margin-top: 15px;
    font-size: 1.2em;
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00;
    min-height: 50px;
    white-space: pre-wrap;
}

/* Popup Modal QR Generator */
.modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
}
.modal-content {
    background-color: #1a1a1a;
    margin: 10% auto;
    padding: 20px;
    border: 2px solid #777;
    width: 90%;
    max-width: 400px;
    text-align: center;
    border-radius: 8px;
}
#qrCanvas {
    margin-top: 15px;
    max-width: 100%;
    border: 2px solid #555;
}
.closeBtn {
    color: #d8d8d8;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.closeBtn:hover { color: #ff5555; }

/* Popup Hasil QR Gambar/Video */
#resultModal .modal-content img,
#resultModal .modal-content video {
    max-width: 100%;
}
#downloadBtn, #downloadQRBtn {
    display: block;
    margin-top: 10px;
    padding: 10px;
    font-size: 1.1em;
    border: 2px solid #777;
    background: #333;
    color: #d8d8d8;
    cursor: pointer;
    font-family: 'VT323', monospace;
}
#downloadBtn:hover, #downloadQRBtn:hover { background: #555; }
</style>
</head>
<body>

<div class="container">
    <h1>QR Decoder v2.8</h1>
    <video id="video" autoplay></video>
    <canvas id="snapshot"></canvas>
    <div class="controls">
        <button id="startCameraButton">Start Camera</button>
        <input type="file" id="fileInput" accept="image/*">
        <button id="createQRBtn">Buat QR</button>
    </div>
    <div id="output">STATUS: READY</div>
</div>

<!-- Modal QR Generator -->
<div id="qrModal" class="modal">
    <div class="modal-content">
        <span class="closeBtn" id="closeQRModal">&times;</span>
        <h2>Buat QR Code</h2>
        <input type="text" id="qrText" placeholder="Masukkan teks/link..." style="width:90%; padding:10px; font-family: 'VT323'; font-size:1em;">
        <canvas id="qrCanvas"></canvas>
        <button id="downloadQRBtn">Download QR</button>
    </div>
</div>

<!-- Modal Hasil QR Gambar/Video -->
<div id="resultModal" class="modal">
    <div class="modal-content">
        <span class="closeBtn" id="closeResultModal">&times;</span>
        <div id="resultContainer"></div>
        <button id="downloadBtn">Download Image</button>
    </div>
</div>

<script>
const video = document.getElementById('video');
const snapshot = document.getElementById('snapshot');
const output = document.getElementById('output');
const fileInput = document.getElementById('fileInput');
const startCameraButton = document.getElementById('startCameraButton');
const createQRBtn = document.getElementById('createQRBtn');

const qrModal = document.getElementById('qrModal');
const closeQRModal = document.getElementById('closeQRModal');
const qrText = document.getElementById('qrText');
const qrCanvas = document.getElementById('qrCanvas');
const downloadQRBtn = document.getElementById('downloadQRBtn');

const resultModal = document.getElementById('resultModal');
const closeResultModal = document.getElementById('closeResultModal');
const resultContainer = document.getElementById('resultContainer');
const downloadBtn = document.getElementById('downloadBtn');

let stream = null, animationFrameId = null;
let lastDecodedData = null;

// --- Fungsi beep ---
function playBeep() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(1.0, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.2);
    } catch (err) { console.error("Audio error:", err); }
}

// --- Caesar Cipher mundur ---
function caesarDecipher(str, shift) {
    let result = '';
    for (let i = 0; i < str.length; i++) {
        let code = str.charCodeAt(i);
        if (code >= 65 && code <= 90) result += String.fromCharCode((code - 65 - shift + 26) % 26 + 65);
        else if (code >= 97 && code <= 122) result += String.fromCharCode((code - 97 - shift + 26) % 26 + 97);
        else result += str[i];
    }
    return result;
}

// --- Tampilkan hasil decode ---
function showDecodedBase64(data) {
    output.textContent = '';
    resultContainer.innerHTML = '';
    lastDecodedData = null;
    downloadBtn.style.display = 'none';

    if (data.startsWith('data:image/')) {
        let img = document.createElement('img');
        img.src = data;
        resultContainer.appendChild(img);
        lastDecodedData = data;
        downloadBtn.style.display = 'block';
        resultModal.style.display = 'block';
    } else if (data.startsWith('data:video/')) {
        let vid = document.createElement('video');
        vid.src = data;
        vid.controls = true;
        vid.loop = true;
        vid.autoplay = true;
        resultContainer.appendChild(vid);
        resultModal.style.display = 'block';
    } else {
        output.textContent = data;
    }
}

// --- Download image ---
downloadBtn.addEventListener('click', () => {
    if (!lastDecodedData) return;
    const a = document.createElement('a');
    a.href = lastDecodedData;
    a.download = 'decoded_image.png';
    a.click();
});

// --- Fetch raw & decrypt ---
async function fetchAndDecrypt(link, shift) {
    try {
        output.textContent = "STATUS: FETCHING RAW DATA...";
        let res = await fetch(link);
        let rawText = await res.text();
        let shifted = caesarDecipher(rawText, shift);
        showDecodedBase64(shifted);
    } catch (err) { output.textContent = "ERROR: " + err; }
}

// --- Kamera ---
function stopCamera() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
}
async function startCamera() {
    stopCamera();
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
        video.srcObject = stream;
        video.play();
        scanQRCode();
    } catch (err) { output.textContent = "ERROR: " + err; }
}

// --- Scan QR ---
function scanQRCode() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth * 2;
            canvas.height = video.videoHeight * 2;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                stopCamera();
                playBeep();
                output.textContent = "QR FOUND: " + code.data;
                processQRData(code.data);
                return;
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }
    tick();
}

// --- Proses QR ---
function processQRData(data) {
    lastDecodedData = null;
    downloadBtn.style.display = 'none';
    let parts = data.split("||").map(p => p.trim());
    if (parts.length===2 && parts[0].startsWith("http") && !isNaN(parseInt(parts[1]))) fetchAndDecrypt(parts[0], parseInt(parts[1]));
    else { output.textContent="QR Content: "+data; downloadBtn.style.display='none'; }
}

// --- Upload file ---
fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    stopCamera();
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
            const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const code = jsQR(imageData.data,imageData.width,imageData.height);
            if(code){ playBeep(); output.textContent="QR FOUND: "+code.data; processQRData(code.data); }
            else { output.textContent="No QR found in image"; downloadBtn.style.display='none'; }
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
});

startCameraButton.addEventListener('click', startCamera);

// --- QR Generator ---
createQRBtn.addEventListener('click', () => {
    qrModal.style.display = 'block';
    generateQRFromInput();
});

closeQRModal.addEventListener('click', () => {
    qrModal.style.display = 'none';
    qrCanvas.getContext('2d').clearRect(0,0,qrCanvas.width,qrCanvas.height);
    qrText.value = '';
});

qrText.addEventListener('input', generateQRFromInput);

function generateQRFromInput() {
    const text = qrText.value.trim() || " ";
    new QRious({
        element: qrCanvas,
        value: text,
        size: 300,
        level: 'H',
        background: '#ffffff', // putih
        foreground: '#000000'  // hitam
    });
}

// --- Download QR Button ---
downloadQRBtn.addEventListener('click', () => {
    const a = document.createElement('a');
    a.href = qrCanvas.toDataURL("image/png");
    a.download = 'qr_code.png';
    a.click();
});

// --- Close result modal ---
closeResultModal.addEventListener('click', () => {
    resultModal.style.display='none';
    resultContainer.innerHTML='';
    downloadBtn.style.display='none';
});

// Tutup modal klik di luar
window.addEventListener('click', (e) => {
    if(e.target===qrModal) qrModal.style.display='none';
    if(e.target===resultModal) resultModal.style.display='none';
});
</script>
</body>
</html>
